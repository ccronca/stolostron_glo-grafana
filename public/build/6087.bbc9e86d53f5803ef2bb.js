(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6087],{39592:(Ie,W,v)=>{"use strict";v.d(W,{a:()=>z});var I=v(31733),m=v(76932),R=v(41164),i=v(98572),l=v(64516),Y=v(98463),te=Object.defineProperty,se=Object.defineProperties,we=Object.getOwnPropertyDescriptors,ie=Object.getOwnPropertySymbols,$=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable,k=(Q,j,U)=>j in Q?te(Q,j,{enumerable:!0,configurable:!0,writable:!0,value:U}):Q[j]=U,J=(Q,j)=>{for(var U in j||(j={}))$.call(j,U)&&k(Q,U,j[U]);if(ie)for(var U of ie(j))w.call(j,U)&&k(Q,U,j[U]);return Q},fe=(Q,j)=>se(Q,we(j));const z=({config:Q,onChange:j,className:U})=>{const Ne=X=>{j(fe(J({},Q),{jsonData:fe(J({},Q.jsonData),{keepCookies:X})}))},Ce=X=>{j(fe(J({},Q),{jsonData:fe(J({},Q.jsonData),{timeout:parseInt(X.currentTarget.value,10)})}))},dt={container:(0,m.css)({maxWidth:578})};return I.createElement(Y._,{title:"Advanced HTTP settings",className:(0,m.cx)(dt.container,U)},I.createElement(R._,{htmlFor:"advanced-http-cookies",label:"Allowed cookies",labelWidth:24,tooltip:"Grafana proxy deletes forwarded cookies by default. Specify cookies by name that should be forwarded to the data source.",disabled:Q.readOnly,grow:!0},I.createElement(i.B,{id:"advanced-http-cookies",placeholder:"New cookie (hit enter to add)",tags:Q.jsonData.keepCookies,onChange:Ne})),I.createElement(R._,{htmlFor:"advanced-http-timeout",label:"Timeout",labelWidth:24,tooltip:"HTTP request timeout in seconds",disabled:Q.readOnly,grow:!0},I.createElement(l.I,{id:"advanced-http-timeout",type:"number",min:0,placeholder:"Timeout in seconds","aria-label":"Timeout in seconds",value:Q.jsonData.timeout,onChange:Ce})))}},84655:(Ie,W,v)=>{"use strict";v.d(W,{i:()=>i});var I=v(76932),m=v(31733),R=v(76067);const i=({hideLine:Y=!1})=>{const te=(0,R.wW)(l);return Y?m.createElement("hr",{className:te.dividerHideLine}):m.createElement("hr",{className:te.divider})},l=Y=>({divider:(0,I.css)({margin:Y.spacing(4,0)}),dividerHideLine:(0,I.css)({border:"none",margin:Y.spacing(3,0)})})},16087:(Ie,W,v)=>{"use strict";v.r(W),v.d(W,{plugin:()=>Yi});var I=v(51023),m=v(93670),R=v(1727),i=v(76932),l=v(31733),Y=v(5333),te=v(25111),se=v(76067),we=v(59328),ie=v(20888),$=v(41164),w=v(64516);const k=t=>(e,r)=>{const n={};for(const a in t)n[a]=t[a](e[a],r);return n},J=(t,e,r)=>(0,l.useCallback)(a=>{t(r(e,a))},[t,e,r]),fe=(0,l.createContext)(void 0),z=()=>{const t=(0,l.useContext)(fe);if(!t)throw new Error("Use DispatchContext first.");return t},Q=t=>({name:t,pipelineAgg:""}),j=t=>`var${Math.max(0,...t.map(e=>parseInt(e.name.match("^var(\\d+)$")?.[1]||"0",10)))+1}`,U=t=>t.settings?.model==="ewma",Ne=t=>t.settings?.model==="holt",Ce=t=>t.settings?.model==="holt_winters",dt=t=>["holt","ewma","holt_winters"].includes(t.settings?.model||""),X=t=>N[t.type].requiresField,Le=t=>N[t.type].isPipelineAgg,ze=t=>N[t.type].supportsMultipleBucketPaths,Fs=t=>N[t.type].supportsMissing,ft=t=>N[t.type].hasSettings,ye=t=>N[t.type].hasMeta,ge=t=>N[t.type].supportsInlineScript,He=["count","avg","sum","min","max","extended_stats","percentiles","cardinality","raw_document","raw_data","logs","moving_avg","moving_fn","derivative","serial_diff","cumulative_sum","bucket_script","rate","top_metrics"],kt=t=>He.includes(t),N={count:{label:"Count",impliedQueryType:"metrics",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!1,hasMeta:!1,supportsInlineScript:!1,defaults:{}},avg:{label:"Average",impliedQueryType:"metrics",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},sum:{label:"Sum",impliedQueryType:"metrics",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},max:{label:"Max",impliedQueryType:"metrics",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},min:{label:"Min",impliedQueryType:"metrics",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},extended_stats:{label:"Extended Stats",impliedQueryType:"metrics",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!0,defaults:{meta:{std_deviation_bounds_lower:!0,std_deviation_bounds_upper:!0}}},percentiles:{label:"Percentiles",impliedQueryType:"metrics",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{settings:{percents:["25","50","75","95","99"]}}},cardinality:{label:"Unique Count",impliedQueryType:"metrics",requiresField:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},moving_avg:{label:"Moving Average",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,versionRange:"<8.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{model:"simple",window:"5"}}},moving_fn:{label:"Moving Function",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,supportsMultipleBucketPaths:!1,supportsInlineScript:!1,supportsMissing:!1,hasMeta:!1,hasSettings:!0,defaults:{}},derivative:{label:"Derivative",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},serial_diff:{label:"Serial Difference",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{lag:"1"}}},cumulative_sum:{label:"Cumulative Sum",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},bucket_script:{label:"Bucket Script",impliedQueryType:"metrics",requiresField:!1,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!0,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{pipelineVariables:[Q(j([]))]}},raw_document:{label:"Raw Document (deprecated)",requiresField:!1,impliedQueryType:"raw_document",isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},raw_data:{label:"Raw Data",requiresField:!1,impliedQueryType:"raw_data",isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},logs:{label:"Logs",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,impliedQueryType:"logs",supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{limit:"500"}}},top_metrics:{label:"Top Metrics",impliedQueryType:"metrics",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{order:"desc"}}},rate:{label:"Rate",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!0,hasMeta:!1,defaults:{}}},xs={moving_avg:[{label:"window",default:5},{label:"model",default:"simple"},{label:"predict"},{label:"minimize",default:!1}],moving_fn:[{label:"window",default:5},{label:"script"}],derivative:[{label:"unit"}],serial_diff:[{label:"lag"}],cumulative_sum:[{label:"format"}],bucket_script:[]},Qt=(t,e)=>{const r=e.filter(n=>ze(n)?n.pipelineVariables?.some(a=>a.pipelineAgg===t.id):X(n)&&t.id===n.field);return[...r,...r.flatMap(n=>Qt(n,e))]},gt=[{label:"Avg",value:"avg"},{label:"Min",value:"min"},{label:"Max",value:"max"},{label:"Sum",value:"sum"},{label:"Count",value:"count"},{label:"Std Dev",value:"std_deviation"},{label:"Std Dev Upper",value:"std_deviation_bounds_upper"},{label:"Std Dev Lower",value:"std_deviation_bounds_lower"}],$s=[{label:"Simple",value:"simple"},{label:"Linear",value:"linear"},{label:"Exponentially Weighted",value:"ewma"},{label:"Holt Linear",value:"holt"},{label:"Holt Winters",value:"holt_winters"}],qe={pre:"@HIGHLIGHT@",post:"@/HIGHLIGHT@"},pt="3";function ve(t="1"){return{type:"count",id:t}}function be(t="1"){return{type:"date_histogram",id:t,settings:{interval:"auto"}}}const Bt=(t,e)=>t.find(r=>r.id===e);function Me(t,e){return!!t?.metrics?.some(r=>r.type===e)}function Ue(t){return t in xs}function Is(t){return!!N[t].supportsMultipleBucketPaths}var ke=v(74293);const pe=t=>X(t)?`${N[t.type].label} ${t.field}`:N[t.type].label,Ge=t=>Object.entries(t).reduce((e,[r,n])=>{if(n==null)return{...e};if(Array.isArray(n)&&n.length===0)return{...e};if(typeof n=="string"&&n.length===0)return{...e};if(!Array.isArray(n)&&typeof n=="object"){const a=Ge(n);return Object.keys(a).length===0?{...e}:{...e,[r]:a}}return{...e,[r]:n}},{}),mt=t=>{const e=t.match(/^(\d+)/);return e?e[1]:void 0},_e=t=>(typeof t.settings?.script=="object"?t.settings?.script?.inline:t.settings?.script)||"",ht=t=>!!(0,ke.gte)(t,"7.16.0"),yt="Support for Elasticsearch versions after their end-of-life (currently versions < 7.16) was removed. Using unsupported version of Elasticsearch may lead to unexpected and incorrect results.",vt=t=>t?.bucketAggs?.slice(-1)[0]?.type==="date_histogram";var L=v(4579);const Ke=(0,L.PH)("@metrics/add"),Ye=(0,L.PH)("@metrics/remove"),Je=(0,L.PH)("@metrics/toggle_visibility"),Qe=(0,L.PH)("@metrics/change_field"),Ae=(0,L.PH)("@metrics/change_type"),Ze=(0,L.PH)("@metrics/change_attr"),H=(0,L.PH)("@metrics/change_setting"),bt=(0,L.PH)("@metrics/change_meta"),Te=(0,L.PH)("init"),Vt=(0,L.PH)("change_query"),Wt=(0,L.PH)("change_alias_pattern"),ws=(t,e)=>Vt.match(e)?e.payload:Te.match(e)?t||"":t,Cs=(t,e)=>Wt.match(e)?e.payload:Te.match(e)?t||"":t;var Et=v(10020);const jt=()=>({label:"",query:"*"}),V={terms:{label:"Terms",requiresField:!0,defaultSettings:{min_doc_count:"1",size:"10",order:"desc",orderBy:"_term"}},filters:{label:"Filters",requiresField:!1,defaultSettings:{filters:[jt()]}},geohash_grid:{label:"Geo Hash Grid",requiresField:!0,defaultSettings:{precision:pt}},date_histogram:{label:"Date Histogram",requiresField:!0,defaultSettings:{interval:"auto",min_doc_count:"0",trimEdges:"0",timeZone:Et.RQ.utc}},histogram:{label:"Histogram",requiresField:!0,defaultSettings:{interval:"1000",min_doc_count:"0"}},nested:{label:"Nested (experimental)",requiresField:!0,defaultSettings:{}}},zt=[{label:"Term value",value:"_term"},{label:"Doc Count",value:"_count"}],St=[{label:"Top",value:"desc"},{label:"Bottom",value:"asc"}],Ms=[{label:"No limit",value:"0"},{label:"1",value:"1"},{label:"2",value:"2"},{label:"3",value:"3"},{label:"5",value:"5"},{label:"10",value:"10"},{label:"15",value:"15"},{label:"20",value:"20"}],Xe=(0,L.PH)("@bucketAggs/add"),et=(0,L.PH)("@bucketAggs/remove"),Ht=(0,L.PH)("@bucketAggs/change_type"),qt=(0,L.PH)("@bucketAggs/change_field"),G=(0,L.PH)("@bucketAggs/change_setting"),_s=t=>(e,r)=>{if(Xe.match(r)){const n={id:r.payload,type:"terms",settings:V.terms.defaultSettings},a=e[e.length-1];return a?.type==="date_histogram"?[...e.slice(0,e.length-1),n,a]:[...e,n]}return et.match(r)?e.filter(n=>n.id!==r.payload):Ht.match(r)?e.map(n=>n.id!==r.payload.id?n:{id:n.id,type:r.payload.newType,settings:V[r.payload.newType].defaultSettings}):qt.match(r)?e.map(n=>n.id!==r.payload.id?n:{...n,field:r.payload.newField}):Ae.match(r)?N[r.payload.type].impliedQueryType!=="metrics"?[]:e.length===0?[{...be("2"),field:t}]:e:G.match(r)?e.map(n=>{if(n.id!==r.payload.bucketAgg.id)return n;const a=Ge({...n.settings,[r.payload.settingName]:r.payload.newValue});return{...n,settings:{...a}}}):Te.match(r)?e&&e.length>0?e:[{...be("2"),field:t}]:e},As=(t,e)=>{if(Ke.match(e))return[...t,ve(e.payload)];if(Ye.match(e)){const r=t.find(u=>u.id===e.payload),n=[r,...Qt(r,t)],a=t.filter(u=>!n.some(f=>f.id===u.id));return a.length===0?[ve("1")]:a}return Ae.match(e)?t.filter(r=>N[e.payload.type].impliedQueryType==="metrics"?!0:r.id===e.payload.id).map(r=>r.id!==e.payload.id?r:{id:r.id,type:e.payload.type,...N[e.payload.type].defaults}):Qe.match(e)?t.map(r=>{if(r.id!==e.payload.id)return r;const n={...r,field:e.payload.field};return Le(r)?{...n,pipelineAgg:e.payload.field}:n}):Je.match(e)?t.map(r=>r.id!==e.payload?r:{...r,hide:!r.hide}):H.match(e)?t.map(r=>{if(r.id!==e.payload.metric.id)return r;if(ft(r)){const n=Ge({...r.settings,[e.payload.settingName]:e.payload.newValue});return{...r,settings:{...n}}}return r}):bt.match(e)?t.map(r=>r.id!==e.payload.metric.id?r:ye(r)?{...r,meta:{...r.meta,[e.payload.meta]:e.payload.newValue}}:r):Ze.match(e)?t.map(r=>r.id!==e.payload.metric.id?r:{...r,[e.payload.attribute]:e.payload.newValue}):Te.match(e)?t&&t.length>0?t:[ve("1")]:t},Ut=(0,l.createContext)(void 0),Gt=(0,l.createContext)(void 0),Ft=(0,l.createContext)(void 0),Ts=({children:t,onChange:e,onRunQuery:r,query:n,datasource:a,range:u})=>{const f=(0,l.useCallback)(C=>{e(C),r()},[e,r]),p=k({query:ws,alias:Cs,metrics:As,bucketAggs:_s(a.timeField)}),y=J(C=>f({...n,...C,timeField:a.timeField}),n,p),g=!n.metrics||!n.bucketAggs||n.query===void 0,[h,S]=(0,l.useState)(g);return(0,l.useEffect)(()=>{h&&g&&(y(Te()),S(!1))},[h,y,g]),g?null:l.createElement(Ut.Provider,{value:a},l.createElement(Gt.Provider,{value:n},l.createElement(Ft.Provider,{value:u},l.createElement(fe.Provider,{value:y},t))))},De=t=>()=>{const e=(0,l.useContext)(t);if(!e)throw new Error("use ElasticsearchProvider first.");return e},ae=De(Gt),Kt=De(Ut),Ds=De(Ft),ce=t=>t.id,tt=t=>parseInt(t,10),Ps=()=>{const{metrics:t,bucketAggs:e}=ae();return(0,l.useMemo)(()=>(Math.max(...[...t?.map(ce)||["0"],...e?.map(ce)||["0"]].map(tt))+1).toString(),[t,e])};var Pe=v(51343),T=v(69781),xt=v(47701),Ee=v(11950),$t=v(41354);const Yt=({children:t,label:e,onRemoveClick:r,onHideClick:n,hidden:a=!1})=>{const u=(0,se.wW)(Jt);return l.createElement(xt.Z,null,l.createElement(Ee.m,null,l.createElement(ie.W,{width:17,as:"div"},l.createElement("span",null,e),l.createElement("span",{className:u.iconWrapper},n&&l.createElement($t.h,{name:a?"eye-slash":"eye",onClick:n,size:"sm","aria-pressed":a,className:u.icon,tooltip:"Hide row"}),l.createElement($t.h,{name:"trash-alt",size:"sm",className:u.icon,onClick:r||T.noop,disabled:!r,tooltip:"Remove row"})))),t)},Jt=t=>({iconWrapper:(0,i.css)`
      display: flex;
    `,icon:(0,i.css)`
      color: ${t.colors.text.secondary};
      margin-left: ${t.spacing(.25)};
    `});var Zt=v(77932),Be=v(68777),le=v(71892);const st=t=>V[t.type].requiresField,Os=["date_histogram","histogram","terms","filters","geohash_grid","nested"],Xt=t=>Os.includes(t),Rs=t=>{if(kt(t))switch(t){case"cardinality":return[];case"top_metrics":return["number"];default:return["number"]}if(Xt(t))switch(t){case"date_histogram":return["date"];case"geohash_grid":return["geo_point"];case"histogram":return["number"];default:return[]}return[]},es=({text:t})=>({label:t,value:t}),rt=t=>{const e=Kt(),r=Ds(),n=Array.isArray(t)?t:Rs(t);let a;return async u=>(a||(a=await(0,le.n)(e.getFields(n,r))),a.filter(({text:f})=>u===void 0||f.includes(u)).map(es))},Se=(0,i.css)`
  min-width: 150px;
`;var Ns=v(49311);const Ls=(t,e)=>({wrapper:(0,i.css)`
      max-width: 500px;
      display: flex;
      flex-direction: column;
    `,settingsWrapper:(0,i.css)`
      padding-top: ${t.spacing(.5)};
    `,icon:(0,i.css)`
      margin-right: ${t.spacing(.5)};
    `,button:(0,i.css)`
      justify-content: start;
      ${e&&(0,i.css)`
        color: ${t.colors.text.disabled};
      `}
    `}),It=({label:t,children:e,hidden:r=!1})=>{const[n,a]=(0,l.useState)(!1),u=(0,se.l4)(),f=Ls(u,r);return l.createElement(Ee.m,null,l.createElement("div",{className:(0,i.cx)(f.wrapper)},l.createElement("button",{className:(0,i.cx)("gf-form-label query-part",f.button,Se),onClick:()=>a(!n),"aria-expanded":n,type:"button"},l.createElement(Ns.J,{name:n?"angle-down":"angle-right","aria-hidden":"true",className:f.icon}),t),n&&l.createElement("div",{className:f.settingsWrapper},e)))};var ne=v(38834),o=v(60100);const A=["1w","1M","1q","1y"];class it{constructor(e){this.timeField=e.timeField}getRangeFilter(){return{[this.timeField]:{gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"}}}buildTermsAgg(e,r,n){if(r.terms={field:e.field},!e.settings)return r;const a=e.settings?.size?parseInt(e.settings.size,10):500;if(r.terms.size=a===0?500:a,e.settings.orderBy!==void 0){r.terms.order={},e.settings.orderBy==="_term"?r.terms.order._key=e.settings.order:r.terms.order[e.settings.orderBy]=e.settings.order;const u=mt(e.settings.orderBy);if(u){for(let f of n.metrics||[])if(f.id===u){f.type==="count"?r.terms.order={_count:e.settings.order}:X(f)&&(r.aggs={},r.aggs[f.id]={[f.type]:{field:f.field}});break}}}return e.settings.min_doc_count!==void 0&&(r.terms.min_doc_count=parseInt(e.settings.min_doc_count,10),isNaN(r.terms.min_doc_count)&&(r.terms.min_doc_count=e.settings.min_doc_count)),e.settings.missing&&(r.terms.missing=e.settings.missing),r}getDateHistogramAgg(e){const r={},n=e.settings||{};r.field=e.field||this.timeField,r.min_doc_count=n.min_doc_count||0,r.extended_bounds={min:"$timeFrom",max:"$timeTo"},r.format="epoch_millis",n.timeZone&&n.timeZone!==Et.RQ.utc&&(r.time_zone=n.timeZone),n.offset!==""&&(r.offset=n.offset);const a=n.interval==="auto"?"${__interval_ms}ms":n.interval;return a!==void 0&&A.includes(a)?r.calendar_interval=a:r.fixed_interval=a,r}getHistogramAgg(e){return{interval:e.settings?.interval,field:e.field,min_doc_count:e.settings?.min_doc_count||0}}getFiltersAgg(e){const r={};for(let{query:n,label:a}of e.settings?.filters||[])r[a||n]={query_string:{query:n,analyze_wildcard:!0}};return r}documentQuery(e,r){return e.size=r,e.sort=[{[this.timeField]:{order:"desc",unmapped_type:"boolean"}},{_doc:{order:"desc"}}],e.script_fields={},e}build(e){e.metrics=e.metrics||[ve()],e.bucketAggs=e.bucketAggs||[be()],e.timeField=this.timeField;let r,n,a,u,f;const p={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};if(e.query&&e.query!==""&&(p.query.bool.filter=[...p.query.bool.filter,{query_string:{analyze_wildcard:!0,query:e.query}}]),e.bucketAggs.length===0&&(r=e.metrics[0],!r||!(r.type==="raw_document"||r.type==="raw_data")))throw{message:"Invalid query"};if(e.metrics?.[0]?.type==="raw_document"||e.metrics?.[0]?.type==="raw_data"){r=e.metrics[0];const y=r.settings?.size?parseInt(r.settings.size,10):500;return this.documentQuery(p,y||500)}for(f=p,n=0;n<e.bucketAggs.length;n++){const y=e.bucketAggs[n],g={};switch(y.type){case"date_histogram":{g.date_histogram=this.getDateHistogramAgg(y);break}case"histogram":{g.histogram=this.getHistogramAgg(y);break}case"filters":{g.filters={filters:this.getFiltersAgg(y)};break}case"terms":{this.buildTermsAgg(y,g,e);break}case"geohash_grid":{g.geohash_grid={field:y.field,precision:y.settings?.precision||pt};break}case"nested":{g.nested={path:y.field};break}}f.aggs=f.aggs||{},f.aggs[y.id]=g,f=g}for(f.aggs={},n=0;n<e.metrics.length;n++){if(r=e.metrics[n],r.type==="count")continue;const y={};let g={};if(Le(r))if(ze(r))if(r.pipelineVariables){for(g={buckets_path:{}},a=0;a<r.pipelineVariables.length;a++)if(u=r.pipelineVariables[a],u.name&&u.pipelineAgg&&/^\d*$/.test(u.pipelineAgg)){const h=Bt(e.metrics,u.pipelineAgg);h&&(h.type==="count"?g.buckets_path[u.name]="_count":g.buckets_path[u.name]=u.pipelineAgg)}}else continue;else if(r.field&&/^\d*$/.test(r.field)){const h=Bt(e.metrics,r.field);h&&(h.type==="count"?g={buckets_path:"_count"}:g={buckets_path:r.field})}else continue;else X(r)&&(g={field:r.field});if(ft(r))switch(Object.entries(r.settings||{}).filter(([h,S])=>S!==null).forEach(([h,S])=>{g[h]=h==="script"?this.buildScript(_e(r)):S}),r.type){case"moving_avg":g={...g,...g?.window!==void 0&&{window:this.toNumber(g.window)},...g?.predict!==void 0&&{predict:this.toNumber(g.predict)},...dt(r)&&{settings:{...g.settings,...Object.fromEntries(Object.entries(g.settings||{}).filter(([h])=>["alpha","beta","gamma","period"].includes(h)).filter(([h,S])=>S!==void 0).map(([h,S])=>[h,this.toNumber(S)]))}}};break;case"serial_diff":g={...g,...g.lag!==void 0&&{lag:this.toNumber(g.lag)}};break;case"top_metrics":g={metrics:r.settings?.metrics?.map(h=>({field:h})),size:1},r.settings?.orderBy&&(g.sort=[{[r.settings?.orderBy]:r.settings?.order}]);break}y[r.type]=g,f.aggs[r.id]=y}return p}buildScript(e){return e}toNumber(e){const r=parseFloat(`${e}`);return isNaN(r)?e:r}getTermsQuery(e){const r={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};e.query&&r.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}});let n=500;e.size&&(n=e.size),r.aggs={1:{terms:{field:e.field,size:n,order:{}}}};const{orderBy:a="key",order:u=a==="doc_count"?"desc":"asc"}=e;if(["asc","desc"].indexOf(u)<0)throw{message:`Invalid query sort order ${u}`};switch(a){case"key":case"term":const f="_key";r.aggs[1].terms.order[f]=u;break;case"doc_count":r.aggs[1].terms.order._count=u;break;default:throw{message:`Invalid query sort type ${a}`}}return r}getLogsQuery(e,r){let n={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};return e.query&&n.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}}),n=this.documentQuery(n,r),{...n,aggs:this.build(e).aggs,highlight:{fields:{"*":{}},pre_tags:[qe.pre],post_tags:[qe.post],fragment_size:2147483647}}}}const oe=t=>({value:e})=>e===t,wt=(t,e)=>e===void 0||t.some(oe(e))?t:[...t,{value:e,label:e}],F=({options:t,value:e,onChange:r})=>{const[n,a]=(0,l.useState)(wt(t,e)),u=f=>a([...n,{value:f,label:f}]);return{onCreateOption:f=>{u(f),r({value:f})},onChange:r,allowCustomValue:!0,options:n,value:e}},nt=[{label:"auto",value:"auto"},{label:"10s",value:"10s"},{label:"1m",value:"1m"},{label:"5m",value:"5m"},{label:"10m",value:"10m"},{label:"20m",value:"20m"},{label:"1h",value:"1h"},{label:"1d",value:"1d"},{label:"1w",value:"1w"},{label:"1M",value:"1M"},{label:"1q",value:"1q"},{label:"1y",value:"1y"}],rr=t=>({value:e})=>e===t,at=(t,e,r)=>!r.some(rr(t))&&t.trim().length>0,ir=(t,e)=>t.value?.startsWith(e)||!1,nr=t=>t&&A.includes(t)?"calendar":"fixed",O=({bucketAgg:t})=>{const e=z(),{current:r}=(0,l.useRef)((0,T.uniqueId)("es-date_histogram-")),n=(0,l.useCallback)(({value:u})=>e(G({bucketAgg:t,settingName:"interval",newValue:u})),[t,e]),a=nr(t.settings?.interval||V.date_histogram.defaultSettings?.interval);return l.createElement(l.Fragment,null,l.createElement($._,{label:a==="calendar"?"Calendar interval":"Fixed interval",tooltip:a==="calendar"?"Calendar-aware intervals adapt to varying day lengths, month durations, and leap seconds, considering the calendar context.":"Fixed intervals remain constant, always being multiples of SI units, independent of calendar changes.",...ee},l.createElement(ne.Ph,{inputId:(0,T.uniqueId)("es-date_histogram-interval"),isValidNewOption:at,filterOption:ir,...F({options:nt,value:t.settings?.interval||V.date_histogram.defaultSettings?.interval,onChange:n})})),l.createElement($._,{label:"Min Doc Count",...ee},l.createElement(w.I,{id:`${r}-min_doc_count`,onBlur:u=>e(G({bucketAgg:t,settingName:"min_doc_count",newValue:u.target.value})),defaultValue:t.settings?.min_doc_count||V.date_histogram.defaultSettings?.min_doc_count})),l.createElement($._,{label:"Trim Edges",...ee,tooltip:"Trim the edges on the timeseries datapoints"},l.createElement(w.I,{id:`${r}-trime_edges`,onBlur:u=>e(G({bucketAgg:t,settingName:"trimEdges",newValue:u.target.value})),defaultValue:t.settings?.trimEdges||V.date_histogram.defaultSettings?.trimEdges})),l.createElement($._,{label:"Offset",...ee,tooltip:"Change the start value of each bucket by the specified positive (+) or negative offset (-) duration, such as 1h for an hour, or 1d for a day"},l.createElement(w.I,{id:`${r}-offset`,onBlur:u=>e(G({bucketAgg:t,settingName:"offset",newValue:u.target.value})),defaultValue:t.settings?.offset||V.date_histogram.defaultSettings?.offset})),l.createElement($._,{label:"Timezone",...ee},l.createElement(o.O,{value:t.settings?.timeZone||V.date_histogram.defaultSettings?.timeZone,includeInternal:[Et.RQ.utc],onChange:u=>{e(G({bucketAgg:t,settingName:"timeZone",newValue:u}))}})))},Oe=({index:t,onAdd:e,onRemove:r,elements:n})=>l.createElement("div",{className:(0,i.css)`
        display: flex;
      `},t===0&&l.createElement(Pe.zx,{variant:"secondary",fill:"text",icon:"plus",onClick:e,tooltip:"Add","aria-label":"Add"}),n.length>=2&&l.createElement(Pe.zx,{variant:"secondary",fill:"text",icon:"minus",onClick:r,tooltip:"Remove","aria-label":"Remove"})),Ct=(0,L.PH)("@bucketAggregations/filter/add"),ts=(0,L.PH)("@bucketAggregations/filter/remove"),lt=(0,L.PH)("@bucketAggregations/filter/change"),ss=(t=[],e)=>Ct.match(e)?[...t,jt()]:ts.match(e)?t.slice(0,e.payload).concat(t.slice(e.payload+1)):lt.match(e)?t.map((r,n)=>n!==e.payload.index?r:e.payload.filter):t,Ve=({bucketAgg:t})=>{const{current:e}=(0,l.useRef)((0,T.uniqueId)("es-filters-")),r=z(),n=J(a=>r(G({bucketAgg:t,settingName:"filters",newValue:a})),t.settings?.filters,ss);return(0,l.useEffect)(()=>{t.settings?.filters?.length||n(Ct())},[n,t.settings?.filters?.length]),l.createElement(l.Fragment,null,l.createElement("div",{className:(0,i.css)`
          display: flex;
          flex-direction: column;
        `},t.settings?.filters.map((a,u)=>l.createElement("div",{key:u,className:(0,i.css)`
              display: flex;
            `},l.createElement($._,{label:"Query",labelWidth:8},l.createElement("div",{className:(0,i.css)`
                  width: 150px;
                `},l.createElement(we.q,{placeholder:"Lucene Query",portalOrigin:"elasticsearch",onChange:f=>n(lt({index:u,filter:{...a,query:f}})),query:a.query}))),l.createElement($._,{label:"Label",labelWidth:8},l.createElement(w.I,{width:16,id:`${e}-label-${u}`,placeholder:"Label",onBlur:f=>n(lt({index:u,filter:{...a,label:f.target.value}})),defaultValue:a.label})),l.createElement(Oe,{index:u,elements:t.settings?.filters||[],onAdd:()=>n(Ct()),onRemove:()=>n(ts(u))})))))},x=({bucketAgg:t})=>{const{metrics:e}=ae(),r=ue(e),{current:n}=(0,l.useRef)((0,T.uniqueId)("es-terms-")),a=z();return l.createElement(l.Fragment,null,l.createElement($._,{label:"Order",...ee},l.createElement(ne.Ph,{inputId:`${n}-order`,onChange:u=>a(G({bucketAgg:t,settingName:"order",newValue:u.value})),options:St,value:t.settings?.order||V.terms.defaultSettings?.order})),l.createElement($._,{label:"Size",...ee},l.createElement(ne.Ph,{inputId:`${n}-size`,...F({options:Ms,value:t.settings?.size||V.terms.defaultSettings?.size,onChange({value:u}){a(G({bucketAgg:t,settingName:"size",newValue:u}))}})})),l.createElement($._,{label:"Min Doc Count",...ee},l.createElement(w.I,{id:`${n}-min_doc_count`,onBlur:u=>a(G({bucketAgg:t,settingName:"min_doc_count",newValue:u.target.value})),defaultValue:t.settings?.min_doc_count||V.terms.defaultSettings?.min_doc_count})),l.createElement($._,{label:"Order By",...ee},l.createElement(ne.Ph,{inputId:`${n}-order_by`,onChange:u=>a(G({bucketAgg:t,settingName:"orderBy",newValue:u.value})),options:r,value:t.settings?.orderBy||V.terms.defaultSettings?.orderBy})),l.createElement($._,{label:"Missing",...ee},l.createElement(w.I,{id:`${n}-missing`,onBlur:u=>a(G({bucketAgg:t,settingName:"missing",newValue:u.target.value})),defaultValue:t.settings?.missing||V.terms.defaultSettings?.missing})))};function ks(t){return t.meta?Object.keys(t.meta).filter(r=>t.meta?.[r]).map(r=>{let n=r;return r==="std_deviation_bounds_lower"&&(n="std_lower"),r==="std_deviation_bounds_upper"&&(n="std_upper"),{label:`${pe(t)} (${n})`,value:`${t.id}[${n}]`}}):[]}function rs(t){return t.settings?.percents?t.settings.percents.map(e=>{const r=/^\d+\.\d+/.test(`${e}`)?e:`${e}.0`;return{label:`${pe(t)} (${e})`,value:`${t.id}[${r}]`}}):[]}function is(t){return t.type!=="top_metrics"&&!Le(t)}const ue=(t=[])=>{const e=t.filter(is).flatMap(r=>r.type==="extended_stats"?ks(r):r.type==="percentiles"?rs(r):{label:pe(r),value:r.id});return[...zt,...e]},Mt=t=>e=>e.value===t,ns=t=>{const{metrics:e}=ae();switch(t.type){case"terms":{const r=t.settings?.order||"desc",n=t.settings?.size||"10",a=parseInt(t.settings?.min_doc_count||"0",10),u=t.settings?.orderBy||"_term";let f="";n!=="0"&&(f=`${St.find(Mt(r))?.label} ${n}, `),a>0&&(f+=`Min Doc Count: ${a}, `),f+="Order by: ";const p=zt.find(Mt(u));if(p)f+=p.label;else{const y=e?.find(g=>g.id===mt(u));y?f+=pe(y):f+="metric not found"}return n==="0"&&(f+=` (${r})`),f}case"histogram":{const r=t.settings?.interval||"1000",n=parseInt(t.settings?.min_doc_count||"1",10);return`Interval: ${r}${n>0?`, Min Doc Count: ${n}`:""}`}case"filters":return`Filter Queries (${(t.settings?.filters||V.filters.defaultSettings?.filters).length})`;case"geohash_grid":return`Precision: ${parseInt(t.settings?.precision||pt,10)}`;case"date_histogram":{const r=t.settings?.interval||"auto",n=parseInt(t.settings?.min_doc_count||"0",10),a=parseInt(t.settings?.trimEdges||"0",10);let u=`Interval: ${r}`;return n>0&&(u+=`, Min Doc Count: ${n}`),a>0&&(u+=`, Trim edges: ${a}`),u}default:return"Settings"}},ee={labelWidth:18},_t=({bucketAgg:t})=>{const{current:e}=(0,l.useRef)((0,T.uniqueId)("es-setting-")),r=z(),n=ns(t);return l.createElement(It,{label:n},t.type==="terms"&&l.createElement(x,{bucketAgg:t}),t.type==="date_histogram"&&l.createElement(O,{bucketAgg:t}),t.type==="filters"&&l.createElement(Ve,{bucketAgg:t}),t.type==="geohash_grid"&&l.createElement($._,{label:"Precision",...ee},l.createElement(w.I,{id:`${e}-geohash_grid-precision`,onBlur:a=>r(G({bucketAgg:t,settingName:"precision",newValue:a.target.value})),defaultValue:t.settings?.precision||V[t.type].defaultSettings?.precision})),t.type==="histogram"&&l.createElement(l.Fragment,null,l.createElement($._,{label:"Interval",...ee},l.createElement(w.I,{id:`${e}-histogram-interval`,onBlur:a=>r(G({bucketAgg:t,settingName:"interval",newValue:a.target.value})),defaultValue:t.settings?.interval||V[t.type].defaultSettings?.interval})),l.createElement($._,{label:"Min Doc Count",...ee},l.createElement(w.I,{id:`${e}-histogram-min_doc_count`,onBlur:a=>r(G({bucketAgg:t,settingName:"min_doc_count",newValue:a.target.value})),defaultValue:t.settings?.min_doc_count||V[t.type].defaultSettings?.min_doc_count}))))},Qs=Object.entries(V).map(([t,{label:e}])=>({label:e,value:t})),as=t=>({label:V[t.type].label,value:t.type}),me=({value:t})=>{const e=z(),r=rt(t.type);return l.createElement(l.Fragment,null,l.createElement(Ee.m,null,l.createElement(Zt.X,{className:Se,options:Qs,onChange:n=>e(Ht({id:t.id,newType:n.value})),value:as(t)}),st(t)&&l.createElement(Be.V,{className:Se,loadOptions:r,onChange:n=>e(qt({id:t.id,newField:n.value})),placeholder:"Select Field",value:t.field})),l.createElement(_t,{bucketAgg:t}))},ls=({nextId:t})=>{const e=z(),{bucketAggs:r}=ae(),n=r?.length||0;return l.createElement(l.Fragment,null,r.map((a,u)=>l.createElement(Yt,{key:`${a.type}-${a.id}`,label:u===0?"Group By":"Then By",onRemoveClick:n>1&&(()=>e(et(a.id)))},l.createElement(me,{value:a}),u===0&&l.createElement(Pe.zx,{variant:"secondary",fill:"text",icon:"plus",onClick:()=>e(Xe(t)),tooltip:"Add grouping condition","aria-label":"Add grouping condition"}))))};var Fe=v(76772);const Bs=(0,i.css)`
  white-space: nowrap;
`,os=t=>({label:pe(t),value:t}),cs=t=>t.map(os),At=({options:t,onChange:e,className:r,value:n})=>{const a=t.find(u=>u.id===n);return l.createElement(Zt.X,{className:(0,i.cx)(r,Bs),options:cs(t),onChange:e,placeholder:"Select Metric",value:a?os(a):void 0})};function q({label:t,settingName:e,metric:r,placeholder:n,tooltip:a}){const u=z(),[f]=(0,l.useState)((0,T.uniqueId)("es-field-id-"));let y=r.settings?.[e]||"";return e==="script"&&(y=_e(r)),l.createElement($._,{label:t,labelWidth:16,tooltip:a},l.createElement(w.I,{id:f,placeholder:n,onBlur:g=>u(H({metric:r,settingName:e,newValue:g.target.value})),defaultValue:y}))}const Tt=(0,L.PH)("@pipelineVariables/add"),Dt=(0,L.PH)("@pipelineVariables/remove"),us=(0,L.PH)("@pipelineVariables/rename"),ds=(0,L.PH)("@pipelineVariables/change_metric"),fs=(t=[],e)=>Tt.match(e)?[...t,Q(j(t))]:Dt.match(e)?t.slice(0,e.payload).concat(t.slice(e.payload+1)):us.match(e)?t.map((r,n)=>n!==e.payload.index?r:{...r,name:e.payload.newName}):ds.match(e)?t.map((r,n)=>n!==e.payload.index?r:{...r,pipelineAgg:e.payload.newMetric}):t,gs=({value:t,previousMetrics:e})=>{const r=z(),n=J(a=>r(Ze({metric:t,attribute:"pipelineVariables",newValue:a})),t.pipelineVariables,fs);return(0,l.useEffect)(()=>{t.pipelineVariables?.length||n(Tt())},[n,t.pipelineVariables?.length]),l.createElement(l.Fragment,null,l.createElement("div",{className:(0,i.css)`
          display: flex;
        `},l.createElement(ie.W,{width:16},"Variables"),l.createElement("div",{className:(0,i.css)`
            display: grid;
            grid-template-columns: 1fr auto;
            row-gap: 4px;
            margin-bottom: 4px;
          `},t.pipelineVariables.map((a,u)=>l.createElement(l.Fragment,{key:(0,T.uniqueId)("es-bs-")},l.createElement("div",{className:(0,i.css)`
                  display: grid;
                  column-gap: 4px;
                  grid-template-columns: auto auto;
                `},l.createElement(w.I,{"aria-label":"Variable name",defaultValue:a.name,placeholder:"Variable Name",onBlur:f=>n(us({newName:f.target.value,index:u}))}),l.createElement(At,{onChange:f=>n(ds({newMetric:f.value.id,index:u})),options:e,value:a.pipelineAgg})),l.createElement(Oe,{index:u,elements:t.pipelineVariables||[],onAdd:()=>n(Tt()),onRemove:()=>n(Dt(u))}))))),l.createElement(q,{label:"Script",metric:t,settingName:"script",tooltip:"Elasticsearch v5.0 and above: Scripting language is Painless. Use params.<var> to reference a variable. Elasticsearch pre-v5.0: Scripting language is per default Groovy if not changed. For Groovy use <var> to reference a variable.",placeholder:"params.var1 / params.var2"}))},Vs=({metric:t})=>{const e=z(),{current:r}=(0,l.useRef)((0,T.uniqueId)("es-moving-avg-"));return l.createElement(l.Fragment,null,l.createElement($._,{label:"Model",labelWidth:16},l.createElement(ne.Ph,{inputId:`${r}-model`,onChange:n=>e(H({metric:t,settingName:"model",newValue:n.value})),options:$s,value:t.settings?.model})),l.createElement(q,{label:"Window",settingName:"window",metric:t,placeholder:"5"}),l.createElement(q,{label:"Predict",settingName:"predict",metric:t}),(U(t)||Ne(t)||Ce(t))&&l.createElement($._,{label:"Alpha",labelWidth:16},l.createElement(w.I,{id:`${r}-alpha`,onBlur:n=>e(H({metric:t,settingName:"settings",newValue:{...t.settings?.settings,alpha:n.target.value}})),defaultValue:t.settings?.settings?.alpha})),(Ne(t)||Ce(t))&&l.createElement($._,{label:"Beta",labelWidth:16},l.createElement(w.I,{id:`${r}-beta`,onBlur:n=>e(H({metric:t,settingName:"settings",newValue:{...t.settings?.settings,beta:n.target.value}})),defaultValue:t.settings?.settings?.beta})),Ce(t)&&l.createElement(l.Fragment,null,l.createElement($._,{label:"Gamma",labelWidth:16},l.createElement(w.I,{id:`${r}-gamma`,onBlur:n=>e(H({metric:t,settingName:"settings",newValue:{...t.settings?.settings,gamma:n.target.value}})),defaultValue:t.settings?.settings?.gamma})),l.createElement($._,{label:"Period",labelWidth:16},l.createElement(w.I,{id:`${r}-period`,onBlur:n=>e(H({metric:t,settingName:"settings",newValue:{...t.settings?.settings,period:n.target.value}})),defaultValue:t.settings?.settings?.period})),l.createElement($._,{label:"Pad",labelWidth:16},l.createElement(Fe.x,{id:`${r}-pad`,onChange:n=>e(H({metric:t,settingName:"settings",newValue:{...t.settings?.settings,pad:n.target.checked}})),checked:!!t.settings?.settings?.pad}))),(U(t)||Ne(t)||Ce(t))&&l.createElement($._,{label:"Minimize",labelWidth:16},l.createElement(Fe.x,{id:`${r}-minimize`,onChange:n=>e(H({metric:t,settingName:"minimize",newValue:n.target.checked})),checked:!!t.settings?.minimize})))},xe=t=>({value:t,label:t}),ps=({metric:t})=>{const e=z(),r=rt(["number","date"]),n=rt(t.type);return l.createElement(l.Fragment,null,l.createElement($._,{label:"Metrics",labelWidth:16},l.createElement(ne.M8,{onChange:a=>e(H({metric:t,settingName:"metrics",newValue:a.map(u=>u.value)})),loadOptions:n,value:t.settings?.metrics?.map(xe),closeMenuOnSelect:!1,defaultOptions:!0})),l.createElement($._,{label:"Order",labelWidth:16},l.createElement(ne.Ph,{onChange:a=>e(H({metric:t,settingName:"order",newValue:a.value})),options:St,value:t.settings?.order})),l.createElement($._,{label:"Order By",labelWidth:16,className:(0,i.css)`
          & > div {
            width: 100%;
          }
        `},l.createElement(Be.V,{className:(0,i.css)`
            margin-right: 0;
          `,loadOptions:r,onChange:a=>e(H({metric:t,settingName:"orderBy",newValue:a.value})),placeholder:"Select Field",value:t.settings?.orderBy})))},Pt=t=>e=>e.value===t,Ws=t=>{switch(t.type){case"cardinality":return`Precision threshold: ${t.settings?.precision_threshold||""}`;case"percentiles":return t.settings?.percents&&t.settings?.percents?.length>=1?`Values: ${t.settings?.percents}`:"Percents: Default";case"extended_stats":{const e=Object.entries(t.meta||{}).map(([r,n])=>n&&gt.find(Pt(r))?.label).filter(Boolean);return`Stats: ${e.length>0?e.join(", "):"None selected"}`}case"raw_document":case"raw_data":return`Size: ${t.settings?.size||500}`;default:return"Options"}},M={labelWidth:16},ot=({metric:t,previousMetrics:e})=>{const{current:r}=(0,l.useRef)((0,T.uniqueId)("es-setting-")),n=z(),a=Ws(t),u=(0,l.useId)(),f=(0,l.useId)(),p=(0,l.useId)(),y=[{value:"second",label:"Second"},{value:"minute",label:"Minute"},{value:"hour",label:"Hour"},{value:"day",label:"Day"},{value:"week",label:"Week"},{value:"month",label:"Month"},{value:"quarter",label:"Quarter"},{value:"Year",label:"Year"}],g=[{value:"sum",label:"Sum"},{value:"value_count",label:"Value count"}];return l.createElement(It,{label:a,hidden:t.hide},t.type==="derivative"&&l.createElement(q,{label:"Unit",metric:t,settingName:"unit"}),t.type==="serial_diff"&&l.createElement(q,{label:"Lag",metric:t,settingName:"lag",placeholder:"1"}),t.type==="cumulative_sum"&&l.createElement(q,{label:"Format",metric:t,settingName:"format"}),t.type==="moving_avg"&&l.createElement(Vs,{metric:t}),t.type==="moving_fn"&&l.createElement(l.Fragment,null,l.createElement(q,{label:"Window",metric:t,settingName:"window"}),l.createElement(q,{label:"Script",metric:t,settingName:"script"}),l.createElement(q,{label:"Shift",metric:t,settingName:"shift"})),t.type==="top_metrics"&&l.createElement(ps,{metric:t}),t.type==="bucket_script"&&l.createElement(gs,{value:t,previousMetrics:e}),(t.type==="raw_data"||t.type==="raw_document")&&l.createElement($._,{label:"Size",...M,htmlFor:u},l.createElement(w.I,{id:u,onBlur:h=>n(H({metric:t,settingName:"size",newValue:h.target.value})),defaultValue:t.settings?.size??N.raw_data.defaults.settings?.size})),t.type==="logs"&&l.createElement(q,{label:"Limit",metric:t,settingName:"limit",placeholder:"500"}),t.type==="cardinality"&&l.createElement(q,{label:"Precision Threshold",metric:t,settingName:"precision_threshold"}),t.type==="extended_stats"&&l.createElement(l.Fragment,null,gt.map(h=>l.createElement(s,{key:h.value,stat:h,onChange:S=>n(bt({metric:t,meta:h.value,newValue:S})),value:t.meta?.[h.value]!==void 0?!!t.meta?.[h.value]:!!N.extended_stats.defaults.meta?.[h.value]})),l.createElement(q,{label:"Sigma",metric:t,settingName:"sigma",placeholder:"3"})),t.type==="percentiles"&&l.createElement($._,{label:"Percentiles",...M},l.createElement(w.I,{id:`${r}-percentiles-percents`,onBlur:h=>n(H({metric:t,settingName:"percents",newValue:h.target.value.split(",").filter(Boolean)})),defaultValue:t.settings?.percents||N.percentiles.defaults.settings?.percents,placeholder:"1,5,25,50,75,95,99"})),t.type==="rate"&&l.createElement(l.Fragment,null,l.createElement($._,{label:"Unit",...M,"data-testid":"unit-select",htmlFor:f},l.createElement(ne.Ph,{id:f,onChange:h=>n(H({metric:t,settingName:"unit",newValue:h.value})),options:y,value:t.settings?.unit})),l.createElement($._,{label:"Mode",...M,"data-testid":"mode-select",htmlFor:p},l.createElement(ne.Ph,{id:p,onChange:h=>n(H({metric:t,settingName:"mode",newValue:h.value})),options:g,value:t.settings?.unit}))),ge(t)&&l.createElement(q,{label:"Script",metric:t,settingName:"script",placeholder:"_value * 1"}),Fs(t)&&l.createElement(q,{label:"Missing",metric:t,settingName:"missing",tooltip:`The missing parameter defines how documents that are missing a value should be treated. By default
            they will be ignored but it is also possible to treat them as if they had a value`}))},s=({stat:t,onChange:e,value:r})=>{const[n]=(0,l.useState)((0,T.uniqueId)("es-field-id-"));return l.createElement($._,{label:t.label,...M,key:t.value},l.createElement(Fe.x,{id:n,onChange:a=>e(a.target.checked),value:r}))},c=({name:t,metric:e})=>{const r=[];return l.createElement(xt.Z,null,l.createElement(Ee.m,null,l.createElement(ie.W,{width:17,as:"div"},l.createElement("span",null,t))),l.createElement(ot,{metric:e,previousMetrics:r}))},d=(t,e)=>({color:e&&(0,i.css)`
        &,
        &:hover,
        label,
        a {
          color: ${e?t.colors.text.disabled:t.colors.text.primary};
        }
      `}),b=t=>({label:N[t.type].label,value:t.type}),E=t=>!N[t.type].isPipelineAgg,D=(t,e)=>{const r=t.some(E);return Object.entries(N).filter(([n,a])=>a.impliedQueryType==="metrics").filter(([n,{versionRange:a="*"}])=>e!=null?(0,ke.satisfies)(e,a):!0).filter(([n,a])=>r||!a.isPipelineAgg).map(([n,{label:a}])=>({label:a,value:n}))},_=({value:t})=>{const e=d((0,se.l4)(),!!t.hide),r=Kt(),n=ae(),a=z(),u=rt(t.type),f=async g=>{const h=await r.getDatabaseVersion();return D(g,h)},p=(0,l.useCallback)(async()=>{const g=await u();return ge(t)?[{label:"None"},...g]:g},[u,t]),y=n.metrics.slice(0,n.metrics.findIndex(g=>g.id===t.id));return l.createElement(l.Fragment,null,l.createElement(Ee.m,null,l.createElement(Be.V,{className:(0,i.cx)(e.color,Se),loadOptions:()=>f(y),onChange:g=>a(Ae({id:t.id,type:g.value})),value:b(t)}),X(t)&&!Le(t)&&l.createElement(Be.V,{className:(0,i.cx)(e.color,Se),loadOptions:p,onChange:g=>a(Qe({id:t.id,field:g.value})),placeholder:"Select Field",value:t.field}),Le(t)&&!ze(t)&&l.createElement(At,{className:(0,i.cx)(e.color,Se),onChange:g=>a(Qe({id:t.id,field:g.value?.id})),options:y,value:t.field})),ft(t)&&l.createElement(ot,{metric:t,previousMetrics:y}))},re=({nextId:t})=>{const e=z(),{metrics:r}=ae(),n=r?.length||0;return l.createElement(l.Fragment,null,r?.map((a,u)=>{switch(a.type){case"logs":return l.createElement(c,{key:`${a.type}-${a.id}`,name:"Logs",metric:a});case"raw_data":return l.createElement(c,{key:`${a.type}-${a.id}`,name:"Raw Data",metric:a});case"raw_document":return l.createElement(l.Fragment,null,l.createElement(c,{key:`${a.type}-${a.id}`,name:"Raw Document",metric:a}),l.createElement(te.b,{severity:"warning",title:"The 'Raw Document' query type is deprecated."}));default:return l.createElement(Yt,{key:`${a.type}-${a.id}`,label:`Metric (${a.id})`,hidden:a.hide,onHideClick:()=>e(Je(a.id)),onRemoveClick:n>1&&(()=>e(Ye(a.id)))},l.createElement(_,{value:a}),N[a.type].impliedQueryType==="metrics"&&u===0&&l.createElement(Pe.zx,{variant:"secondary",fill:"text",icon:"plus",onClick:()=>e(Ke(t)),tooltip:"Add metric","aria-label":"Add metric"}))}}))};var Pr=v(96856);const Or=[{value:"metrics",label:"Metrics"},{value:"logs",label:"Logs"},{value:"raw_data",label:"Raw Data"},{value:"raw_document",label:"Raw Document"}];function Rr(t){switch(t){case"logs":case"raw_data":case"raw_document":return t;case"metrics":return"count";default:throw new Error(`invalid query type: ${t}`)}}const Nr=()=>{const t=ae(),e=z(),r=t.metrics?.[0];if(r==null)return null;const n=N[r.type].impliedQueryType,a=u=>{e(Ae({id:r.id,type:Rr(u)}))};return l.createElement(Pr.S,{fullWidth:!1,options:Or,value:n,onChange:a})};function Lr(t){const[e,r]=(0,l.useState)(null);return(0,l.useEffect)(()=>{let n=!1;return t.getDatabaseVersion().then(a=>{n||r(a)},a=>{console.log(a)}),()=>{n=!0}},[t]),e}const kr=({query:t,onChange:e,onRunQuery:r,datasource:n,range:a})=>{const u=Lr(n),f=u!=null&&!ht(u);return l.createElement(Ts,{datasource:n,onChange:e,onRunQuery:r,query:t,range:a||(0,Y.JK)()},f&&l.createElement(te.b,{title:yt}),l.createElement(Qr,{value:t}))},ar=t=>({root:(0,i.css)`
    display: flex;
  `,queryItem:(0,i.css)`
    flex-grow: 1;
    margin: 0 ${t.spacing(.5)} ${t.spacing(.5)} 0;
  `}),lr=({value:t,onChange:e})=>{const r=(0,se.wW)(ar);return l.createElement("div",{className:r.queryItem},l.createElement(we.q,{query:t,onChange:e,placeholder:"Enter a lucene query",portalOrigin:"elasticsearch"}))},Qr=({value:t})=>{const e=z(),r=Ps(),n=(0,l.useId)(),a=(0,se.wW)(ar),u=vt(t),f=t.metrics?.every(p=>N[p.type].impliedQueryType==="metrics");return l.createElement(l.Fragment,null,l.createElement("div",{className:a.root},l.createElement(ie.W,{width:17},"Query type"),l.createElement("div",{className:a.queryItem},l.createElement(Nr,null))),l.createElement("div",{className:a.root},l.createElement(ie.W,{width:17},"Lucene Query"),l.createElement(lr,{onChange:p=>e(Vt(p)),value:t?.query}),u&&l.createElement($._,{label:"Alias",labelWidth:15,tooltip:"Aliasing only works for timeseries queries (when the last group is 'Date Histogram'). For all other query types this field is ignored.",htmlFor:n},l.createElement(w.I,{id:n,placeholder:"Alias Pattern",onBlur:p=>e(Wt(p.currentTarget.value)),defaultValue:t.alias}))),l.createElement(re,{nextId:r}),f&&l.createElement(ls,{nextId:r}))};var Br=v(43051),Vr=v(31388),Wr=v(85510),jr=v(60466),zr=v(49875),js=v(83378),Hr=v(83717),qr=v(39592),Ur=v(41854),ct=v(84655),or=v(83811),Gr=v(81548),Kr=v(63908),zs=v(98463),Hs=v(5936),Yr=v(31621),Jr=v(14757),Zr=v(79228);const Xr=t=>{const{value:e,onChange:r,onDelete:n,suggestions:a,className:u}=t,f=(0,se.wW)(ti),[p,y]=ei(e.datasourceUid),g=h=>S=>{r({...e,[h]:S.currentTarget.value})};return l.createElement("div",{className:u},l.createElement("div",{className:f.firstRow},l.createElement($._,{label:"Field",htmlFor:"elasticsearch-datasource-config-field",labelWidth:12,tooltip:"Can be exact field name or a regex pattern that will match on the field name."},l.createElement(w.I,{type:"text",id:"elasticsearch-datasource-config-field",value:e.field,onChange:g("field"),width:100})),l.createElement(Pe.zx,{variant:"destructive",title:"Remove field",icon:"times",onClick:h=>{h.preventDefault(),n()}})),l.createElement(xt.Z,null,l.createElement("div",{className:f.urlField},l.createElement(ie.W,{htmlFor:"elasticsearch-datasource-internal-link",width:12},p?"Query":"URL"),l.createElement(Jr.v,{placeholder:p?"${__value.raw}":"http://example.com/${__value.raw}",value:e.url||"",onChange:h=>r({...e,url:h}),suggestions:a})),l.createElement("div",{className:f.urlDisplayLabelField},l.createElement($._,{label:"URL Label",htmlFor:"elasticsearch-datasource-url-label",labelWidth:14,tooltip:"Use to override the button label."},l.createElement(w.I,{type:"text",id:"elasticsearch-datasource-url-label",value:e.urlDisplayLabel,onChange:g("urlDisplayLabel")})))),l.createElement("div",{className:f.row},l.createElement($._,{label:"Internal link",labelWidth:12},l.createElement(Fe.x,{label:"Internal link",value:p||!1,onChange:()=>{p&&r({...e,datasourceUid:void 0}),y(!p)}})),p&&l.createElement(Zr.q,{tracing:!0,onChange:h=>{r({...e,datasourceUid:h.uid})},current:e.datasourceUid})))};function ei(t){const[e,r]=(0,l.useState)(!!t),n=(0,Yr.Z)(t);return(0,l.useEffect)(()=>{!n&&t&&!e&&r(!0),n&&!t&&e&&r(!1)},[n,t,e]),[e,r]}const ti=()=>({firstRow:(0,i.css)`
    display: flex;
  `,nameField:(0,i.css)`
    flex: 2;
  `,regexField:(0,i.css)`
    flex: 3;
  `,row:(0,i.css)`
    display: flex;
    align-items: baseline;
  `,urlField:(0,i.css)`
    display: flex;
    flex: 1;
  `,urlDisplayLabelField:(0,i.css)`
    flex: 1;
  `}),si=t=>({addButton:(0,i.css)`
      margin-right: 10px;
    `,container:(0,i.css)`
      margin-bottom: ${t.spacing(2)};
    `,dataLink:(0,i.css)`
      margin-bottom: ${t.spacing(1)};
    `}),ri=t=>{const{value:e,onChange:r}=t,n=(0,se.wW)(si);return l.createElement(zs._,{title:"Data links",description:l.createElement(Hs.W,{description:"Add links to existing fields. Links will be shown in log row details next to the field value.",suffix:"elasticsearch/#data-links",feature:"Elasticsearch data links"})},l.createElement("div",{className:n.container},e&&e.length>0&&l.createElement("div",{className:"gf-form-group"},e.map((a,u)=>l.createElement(Xr,{className:n.dataLink,key:u,value:a,onChange:f=>{const p=[...e];p.splice(u,1,f),r(p)},onDelete:()=>{const f=[...e];f.splice(u,1),r(f)},suggestions:[{value:Gr.W.valueRaw,label:"Raw value",documentation:"Raw value of the field",origin:Kr.L8.Value}]}))),l.createElement(Pe.zx,{type:"button",variant:"secondary",className:n.addButton,icon:"plus",onClick:a=>{a.preventDefault();const u=[...e||[],{field:"",url:""}];r(u)}},"Add")))},qs=[{label:"No pattern",value:"none"},{label:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{label:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{label:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{label:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{label:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],ii=({value:t,onChange:e})=>l.createElement(zs._,{title:"Elasticsearch details",description:l.createElement(Hs.W,{description:"Specific settings for the Elasticsearch data source.",suffix:"elasticsearch/#index-settings",feature:"Elasticsearch details"})},l.createElement($._,{label:"Index name",htmlFor:"es_config_indexName",labelWidth:29,tooltip:"Name of your Elasticsearch index. You can use a time pattern, such as YYYY.MM.DD, or a wildcard for the index name."},l.createElement(w.I,{id:"es_config_indexName",value:t.jsonData.index??(t.database||""),onChange:ni(t,e),width:24,placeholder:"es-index-name",required:!0})),l.createElement($._,{label:"Pattern",htmlFor:"es_config_indexPattern",labelWidth:29,tooltip:"If you're using a pattern for your index, select the type, or no pattern."},l.createElement(ne.Ph,{inputId:"es_config_indexPattern",value:qs.find(r=>r.value===(t.jsonData.interval===void 0?"none":t.jsonData.interval)),options:qs,onChange:ai(t,e),width:24})),l.createElement($._,{label:"Time field name",htmlFor:"es_config_timeField",labelWidth:29,tooltip:"Name of your time field. Defaults to @timestamp."},l.createElement(w.I,{id:"es_config_timeField",value:t.jsonData.timeField||"",onChange:Us("timeField",t,e),width:24,placeholder:"@timestamp",required:!0})),l.createElement($._,{label:"Max concurrent Shard Requests",htmlFor:"es_config_shardRequests",labelWidth:29,tooltip:"Maximum number of concurrent shards a search request can hit per node. Defaults to 5."},l.createElement(w.I,{id:"es_config_shardRequests",value:t.jsonData.maxConcurrentShardRequests||"",onChange:Us("maxConcurrentShardRequests",t,e),width:24})),l.createElement($._,{label:"Min time interval",htmlFor:"es_config_minTimeInterval",labelWidth:29,tooltip:l.createElement(l.Fragment,null,"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example"," ",l.createElement("code",null,"1m")," if your data is written every minute."),error:"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s",invalid:!!t.jsonData.timeInterval&&!/^\d+(ms|[Mwdhmsy])$/.test(t.jsonData.timeInterval)},l.createElement(w.I,{id:"es_config_minTimeInterval",value:t.jsonData.timeInterval||"",onChange:Us("timeInterval",t,e),width:24,placeholder:"10s"})),l.createElement($._,{label:"X-Pack enabled",labelWidth:29,tooltip:"Enable or disable X-Pack specific features"},l.createElement(Fe.x,{id:"es_config_xpackEnabled",value:t.jsonData.xpack||!1,onChange:cr("xpack",t,e)})),t.jsonData.xpack&&l.createElement($._,{label:"Include Frozen Indices",htmlFor:"es_config_frozenIndices",labelWidth:29,tooltip:"Include frozen indices in searches."},l.createElement(Fe.x,{id:"es_config_frozenIndices",value:t.jsonData.includeFrozen??!1,onChange:cr("includeFrozen",t,e)}))),ni=(t,e)=>r=>{e({...t,database:"",jsonData:{...t.jsonData,index:r.currentTarget.value}})},Us=(t,e,r)=>n=>{r({...e,jsonData:{...e.jsonData,[t]:n.currentTarget.value}})},cr=(t,e,r)=>n=>{r({...e,jsonData:{...e.jsonData,[t]:n.currentTarget.checked}})},ai=(t,e)=>r=>{const n=r.value==="none"?void 0:r.value,a=t.jsonData.index??t.database;if(!a||a.length===0||a.startsWith("[logstash-]")){let u="";if(n!==void 0){const f=qs.find(p=>p.value===n);f&&(u=f.example??"")}e({...t,database:"",jsonData:{...t.jsonData,index:u,interval:n}})}else e({...t,jsonData:{...t.jsonData,interval:n}})};function li(){return 5}const oi=t=>{const{value:e,onChange:r}=t,n=a=>u=>{r({...e,[a]:u.currentTarget.value})};return l.createElement(zs._,{title:"Logs",description:l.createElement(Hs.W,{description:"Configure which fields the data source uses for log messages and log levels.",suffix:"elasticsearch/#logs",feature:"Elasticsearch log fields"})},l.createElement($._,{label:"Message field name",labelWidth:22,tooltip:"Configure the field to be used for log messages."},l.createElement(w.I,{id:"es_logs-config_logMessageField",value:e.logMessageField,onChange:n("logMessageField"),placeholder:"_source",width:24})),l.createElement($._,{label:"Level field name",labelWidth:22,tooltip:"Configure the field that determines the level of each log message."},l.createElement(w.I,{id:"es_logs-config_logLevelField",value:e.logLevelField,onChange:n("logLevelField"),width:24})))},ci=t=>({...t,jsonData:{...t.jsonData,timeField:t.jsonData.timeField||"@timestamp",maxConcurrentShardRequests:t.jsonData.maxConcurrentShardRequests||li(),logMessageField:t.jsonData.logMessageField||"",logLevelField:t.jsonData.logLevelField||"",includeFrozen:t.jsonData.includeFrozen??!1}}),ui=t=>!!t.jsonData.timeField&&!!t.jsonData.maxConcurrentShardRequests&&t.jsonData.logMessageField!==void 0&&t.jsonData.logLevelField!==void 0,di=t=>{const{options:e,onOptionsChange:r}=t;(0,l.useEffect)(()=>{ui(e)||r(ci(e))},[r,e]);const n=(0,Vr.T2)({config:e,onChange:r});return or.config.sigV4AuthEnabled&&(n.customMethods=[{id:"custom-sigv4",label:"SigV4 auth",description:"AWS Signature Version 4 authentication",component:l.createElement(Br.IW,{inExperimentalAuthComponent:!0,...t})}],n.selectedMethod=e.jsonData.sigV4Auth?"custom-sigv4":n.selectedMethod),l.createElement(l.Fragment,null,e.access==="direct"&&l.createElement(te.b,{title:"Error",severity:"error"},"Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode."),l.createElement(Wr.j,{dataSourceName:"Elasticsearch",docsLink:"https://grafana.com/docs/grafana/latest/datasources/elasticsearch",hasRequiredFields:!1}),l.createElement(ct.i,null),l.createElement(jr.f,{config:e,onChange:r,urlPlaceholder:"http://localhost:9200"}),l.createElement(ct.i,null),l.createElement(zr.g,{...n,onAuthMethodSelect:a=>{r({...e,basicAuth:a===js.H.BasicAuth,withCredentials:a===js.H.CrossSiteCredentials,jsonData:{...e.jsonData,sigV4Auth:a==="custom-sigv4",oauthPassThru:a===js.H.OAuthForward}})}}),l.createElement(ct.i,null),l.createElement(Hr.K,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!0},l.createElement(qr.a,{config:e,onChange:r}),l.createElement(ct.i,{hideLine:!0}),or.config.secureSocksDSProxyEnabled&&l.createElement(Ur.i,{options:e,onOptionsChange:r}),l.createElement(ii,{value:e,onChange:r}),l.createElement(ct.i,{hideLine:!0}),l.createElement(oi,{value:e.jsonData,onChange:a=>r({...e,jsonData:a})}),l.createElement(ct.i,{hideLine:!0}),l.createElement(ri,{value:e.jsonData.dataLinks,onChange:a=>{r({...e,jsonData:{...e.jsonData,dataLinks:a}})}})))};var fi=v(95072),ms=v(57298),Ot=v(86457),hs=v(56183),ur=v(89582),gi=v(83825),pi=v(80005),mi=v(4681),We=v(4558),dr=v(89852),Z=v(68387),hi=v(17201),Gs=v(44343),K=v(74011),$e=v(85666),yi=v(65821),vi=v(61129),Re=v(85498),bi=v(66261),fr=v(76597),Ei=v(40641);const gr={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}};class Si{constructor(e,r){this.pattern=e,this.interval=r,this.dateLocale="en"}getIndexForToday(){return this.interval?(0,K.zh)().locale(this.dateLocale).format(this.pattern):this.pattern}getIndexList(e,r){if(!this.interval)return this.pattern;const a=gr[this.interval],u=(0,K.CQ)(e||(0,K.CQ)(r).add(-7,a.amount)).utc().startOf(a.startOf),f=(0,K.CQ)(r||(0,K.CQ)(e).add(7,a.amount)).utc().startOf(a.startOf).valueOf(),p=[];for(;u.valueOf()<=f;)p.push(u.locale(this.dateLocale).format(this.pattern)),u.add(1,a.amount);return p}}var ys=v(1181);class Fi extends I.iL{constructor(e,r){super(),this.datasource=e,Object.assign(this,r)}importFromAbstractQuery(e){return{metrics:[{id:"1",type:"logs"}],query:this.getElasticsearchQuery(e.labelMatchers),refId:e.refId}}getElasticsearchQuery(e){return e.map(r=>{switch(r.operator){case ys.K2.Equal:return r.name+':"'+r.value+'"';case ys.K2.NotEqual:return"-"+r.name+':"'+r.value+'"';case ys.K2.EqualRegEx:return r.name+":/"+r.value+"/";case ys.K2.NotEqualRegEx:return"-"+r.name+":/"+r.value+"/"}}).join(" AND ")}}var Ks=v(27005),pr=v(70816),xi=v(69391),Ys=v(98147),$i=v(47862),mr=v(14150),Ii=v(60742);const hr=`${qe.pre}([^@]+)${qe.post}`;class yr{constructor(e,r){this.targets=e,this.response=r,this.processResponseToSeries=()=>{const n=[];for(let a=0;a<this.response.responses.length;a++){const u=this.response.responses[a],f=this.targets[a];if(u.error)throw this.getErrorFromElasticResponse(this.response,u.error);if(u.hits&&u.hits.hits.length>0&&this.processHits(u.hits,n,f),u.aggregations){const p=u.aggregations,y=this.targets[a],g=[],h=new mr.Z;h.refId=y.refId,this.processBuckets(p,y,g,h,{},0),this.trimDatapoints(g,y),this.nameSeries(g,y);for(let S=0;S<g.length;S++)n.push(g[S]);h.rows.length>0&&n.push(h)}}return{data:n}},this.targets=e,this.response=r}processMetrics(e,r,n,a){let u;for(let f=0;f<r.metrics.length;f++){const p=r.metrics[f];if(!p.hide)switch(p.type){case"count":{u={datapoints:[],metric:"count",props:a,refId:r.refId};for(let y=0;y<e.buckets.length;y++){const g=e.buckets[y],h=g.doc_count;u.datapoints.push([h,g.key])}n.push(u);break}case"percentiles":{if(e.buckets.length===0)break;const g=e.buckets[0][p.id].values;for(const h in g){u={datapoints:[],metric:"p"+h,props:a,field:p.field,refId:r.refId};for(let S=0;S<e.buckets.length;S++){const C=e.buckets[S],P=C[p.id].values;u.datapoints.push([P[h],C.key])}n.push(u)}break}case"extended_stats":{for(const y in p.meta)if(p.meta[y]){u={datapoints:[],metric:y,props:a,field:p.field,refId:r.refId};for(let g=0;g<e.buckets.length;g++){const h=e.buckets[g],S=h[p.id];S.std_deviation_bounds_upper=S.std_deviation_bounds.upper,S.std_deviation_bounds_lower=S.std_deviation_bounds.lower,u.datapoints.push([S[y],h.key])}n.push(u)}break}case"top_metrics":{if(p.settings?.metrics?.length)for(const y of p.settings?.metrics){u={datapoints:[],metric:p.type,props:a,refId:r.refId,field:y};for(let g=0;g<e.buckets.length;g++){const h=e.buckets[g],C=h[p.id].top.map(B=>B.metrics[y]?B.metrics[y]:null),P=[C[C.length-1],h.key];u.datapoints.push(P)}n.push(u)}break}default:{u={datapoints:[],metric:p.type,metricId:p.id,props:a,refId:r.refId},X(p)&&(u.field=p.field);for(let y=0;y<e.buckets.length;y++){const g=e.buckets[y],h=g[p.id];h!==void 0&&(h.normalized_value?u.datapoints.push([h.normalized_value,g.key]):u.datapoints.push([h.value,g.key]))}n.push(u);break}}}}processAggregationDocs(e,r,n,a,u){if(a.columns.length===0){for(const y of(0,T.keys)(u))a.addColumn({text:y,filterable:!0});a.addColumn({text:r.field,filterable:!0})}const f=(y,g,h)=>{a.addColumn({text:g}),y.push(h)},p=(0,T.isArray)(e.buckets)?e.buckets:[e.buckets];for(const y of p){const g=[];for(const h of(0,T.values)(u))g.push(h);g.push(y.key);for(const h of n.metrics||[])switch(h.type){case"count":{f(g,this.getMetricName(h.type),y.doc_count);break}case"extended_stats":{for(const S in h.meta){if(!h.meta[S])continue;const C=y[h.id];C.std_deviation_bounds_upper=C.std_deviation_bounds.upper,C.std_deviation_bounds_lower=C.std_deviation_bounds.lower,f(g,this.getMetricName(S),C[S])}break}case"percentiles":{const S=y[h.id].values;for(const C in S)f(g,`p${C} ${h.field}`,S[C]);break}case"top_metrics":{const S=this.getMetricName(h.type);if(h.settings?.metrics)for(const C of h.settings.metrics){const P=h.settings.metrics.length>1?`${S} ${C}`:S,B=y[h.id];f(g,P,B.top[0].metrics[C])}break}default:{let S=this.getMetricName(h.type);(0,T.filter)(n.metrics,{type:h.type}).length>1&&(X(h)&&(S+=" "+h.field),h.type==="bucket_script"&&(S=_e(h))),f(g,S,y[h.id].value);break}}a.rows.push(g)}}processBuckets(e,r,n,a,u,f){let p,y,g,h;const S=r.bucketAggs.length-1;for(h in e)if(y=(0,T.find)(r.bucketAggs,{id:h}),g=e[h],!!y){if(y.type==="nested"){this.processBuckets(g,r,n,a,u,f+1);continue}if(f===S)y.type==="date_histogram"?this.processMetrics(g,r,n,u):this.processAggregationDocs(g,y,r,a,u);else for(const C in g.buckets)p=g.buckets[C],u=(0,T.clone)(u),p.key!==void 0?u[y.field]=p.key:u.filter=C,p.key_as_string&&(u[y.field]=p.key_as_string),this.processBuckets(p,r,n,a,u,f+1)}}getMetricName(e){const r=Object.entries(N).filter(([a])=>a===e).map(([a,u])=>u)[0];if(r)return r.label;const n=gt.find(a=>a.value===e);return n?n.label:e}getSeriesName(e,r,n){let a=this.getMetricName(e.metric);if(r.alias){const p=/\{\{([\s\S]+?)\}\}/g;return r.alias.replace(p,(y,g,h)=>{const S=g||h;return S.indexOf("term ")===0?e.props[S.substring(5)]:e.props[S]!==void 0?e.props[S]:S==="metric"?a:S==="field"?e.field||"":y})}if(Ue(e.metric))if(e.metric&&Is(e.metric)){const p=(0,T.find)(r.metrics,{id:e.metricId});if(p&&p.settings.script){a=_e(p);for(const y of p.pipelineVariables){const g=(0,T.find)(r.metrics,{id:y.pipelineAgg});g&&(a=a.replace("params."+y.name,pe(g)))}}else a="Unset"}else{const p=(0,T.find)(r.metrics,{id:e.field});p?a+=" "+pe(p):a="Unset"}else e.field&&(a+=" "+e.field);if((0,T.keys)(e.props).length===0)return a;let f="";for(const p in e.props)f+=e.props[p]+" ";return n?f.trim()+" "+a:f.trim()}nameSeries(e,r){const n=(0,T.uniq)((0,T.map)(e,"metric")).length,a=(r.metrics?.filter(u=>u.type==="top_metrics")).some(u=>(u?.settings?.metrics?.length||0)>1);for(let u=0;u<e.length;u++){const f=e[u];f.target=this.getSeriesName(f,r,n>1||a)}}processHits(e,r,n){const a=typeof e.total=="number"?e.total:e.total.value,u={target:n.refId,type:"docs",refId:n.refId,datapoints:[],total:a,filterable:!0};let f,p,y,g;for(g=0;g<e.hits.length;g++){if(p=e.hits[g],y={_id:p._id,_type:p._type,_index:p._index,sort:p.sort,highlight:p.highlight},p._source)for(f in p._source)y[f]=p._source[f];for(f in p.fields)y[f]=p.fields[f];u.datapoints.push(y)}r.push(u)}trimDatapoints(e,r){const n=(0,T.find)(r.bucketAggs,{type:"date_histogram"});if(n&&n.settings&&n.settings.trimEdges){const u=n.settings.trimEdges;for(const f in e){const p=e[f];p.datapoints.length>u*2&&(p.datapoints=p.datapoints.slice(u,p.datapoints.length-u))}}}getErrorFromElasticResponse(e,r){const n={};return n.data=JSON.stringify(r,null,4),r.root_cause&&r.root_cause.length>0&&r.root_cause[0].reason?n.message=r.root_cause[0].reason:n.message=r.reason||"Unknown elastic error response",e.$$config&&(n.config=e.$$config),n}getTimeSeries(){if(this.targets.some(r=>Me(r,"raw_data")))return this.processResponseToDataFrames(!1);const e=this.processResponseToSeries();return{...e,data:e.data.map(r=>(0,Ys.g0)(r))}}getLogs(e,r){return this.processResponseToDataFrames(!0,e,r)}processResponseToDataFrames(e,r,n){const a=[];for(let u=0;u<this.response.responses.length;u++){const f=this.response.responses[u];if(f.error)throw this.getErrorFromElasticResponse(this.response,f.error);if(f.hits){const{propNames:p,docs:y}=wi(f.hits.hits),g=y.length?vr(p.map(Ci(y)),e,this.targets[0].timeField,r,n):vr([],e);e&&br(g,"logs");for(const S of y){if(n&&(S.level=S[n]),S.highlight){const C=new RegExp(hr,"g"),P=new RegExp(hr),B=Object.keys(S.highlight).flatMap(je=>S.highlight[je].flatMap(Lt=>{const Ss=Lt.match(C);return Ss?Ss.map(he=>{const Dr=he.match(P);return Dr&&Dr[1]||null}):[]})).filter(T.identity),de=g.meta?.searchWords?(0,T.uniq)([...g.meta.searchWords,...B]):[...B];g.meta=g.meta?{...g.meta,searchWords:de}:{searchWords:de}}g.add(S)}const h=this.targets[u];g.refId=h.refId,a.push(g)}if(f.aggregations){const p=f.aggregations,y=this.targets[u],g=[],h=new mr.Z;if(this.processBuckets(p,y,g,h,{},0),this.trimDatapoints(g,y),this.nameSeries(g,y),h.rows.length>0){const S=(0,Ys.g0)(h);S.refId=y.refId,a.push(S)}for(let S=0;S<g.length;S++){let C=(0,Ys.g0)(g[S]);e&&br(C,"graph"),C.refId=y.refId,a.push(C)}}}for(let u of a)for(let f of u.fields)f.type===$e.fS.time&&typeof f.values[0]!="number"&&(f.values=(0,pr.p8)(f,{destinationType:$e.fS.time}).values);return{data:a}}}const wi=t=>{const e=[];let r=[];for(const n of t){const a=n._source?(0,Ii.default)(n._source):{},u={_id:n._id,_type:n._type,_index:n._index,sort:n.sort,highlight:n.highlight,_source:{...a},...a};for(const f of Object.keys(u))r.indexOf(f)===-1&&r.push(f);e.push(u)}return r.sort(),{docs:e,propNames:r}},vr=(t,e,r,n,a)=>{const u=new $i.v({fields:[]});if(r&&u.addField({config:{filterable:!0},name:r,type:$e.fS.time}),n){const p=u.addField({name:n,type:$e.fS.string});u.setParser(p,y=>y||"")}if(a){const p=u.addField({name:"level",type:$e.fS.string});u.setParser(p,y=>y||"")}const f=u.fields.map(p=>p.name);for(const[p,y]of t){if(f.includes(p)||!e&&p==="_source")continue;const g=u.addField({config:{filterable:!0},name:p,type:y});u.setParser(g,h=>h||"")}return u},br=(t,e)=>{let r=t;r.meta?r.meta.preferredVisualisationType=e:r.meta={preferredVisualisationType:e}},Ci=t=>e=>[e,Mi(t.find(r=>r[e]!==void 0)?.[e])],Mi=t=>{switch(typeof t){case"number":return $e.fS.number;case"string":return $e.fS.string;default:return $e.fS.other}};var Js=v(64704),_i=v(77378),Ai=v(31886);const Ti=({payload:{dashboardId:t,orgId:e,grafanaVersion:r,queries:n}})=>{try{const a=n[Ai.id]?.filter(P=>!P.hide);if(!a?.length)return;const u=a.filter(Pi),f=a.filter(P=>!!P.query),p=a.filter(P=>Rt(P)==="logs"),y=a.filter(P=>Rt(P)==="metric"),g=a.filter(P=>Rt(P)==="raw_data"),h=a.filter(P=>Rt(P)==="raw_document"),S=a.filter(Di),C={grafana_version:r,dashboard_id:t,org_id:e,queries_count:a.length,logs_queries_count:p.length,metric_queries_count:y.length,raw_data_queries_count:g.length,raw_document_queries_count:h.length,queries_with_template_variables_count:u.length,queries_with_changed_line_limit_count:S.length,queries_with_lucene_query_count:f.length};(0,Js.ff)("grafana_elasticsearch_dashboard_loaded",C)}catch(a){console.error("error in elasticsearch tracking handler",a)}},Rt=t=>!t.metrics||!t.metrics.length?void 0:["logs","raw_data","raw_document"].includes(t.metrics[0].type)?t.metrics[0].type:"metric",Er=t=>{if(t.metrics?.[0]?.type!=="logs")return;const e=t.metrics?.[0].settings?.limit;return e?parseInt(e,10):void 0},Di=t=>{const e=Er(t);return e!==void 0&&e!==500},Pi=t=>_i.J7.test(t.query??""),Oi=t=>!!t.startsWith(_r);function Sr(t,e,r){const{targets:n,app:a}=e;if(!(a===Gs.zj.Dashboard||a===Gs.zj.PanelViewer))for(const u of n){if(Oi(u.refId))return;(0,Js.ff)("grafana_elasticsearch_query_executed",{app:a,grafana_version:Re.config.buildInfo.version,with_lucene_query:!!u.query,query_type:Rt(u),line_limit:Er(u),alias:u.alias,has_error:t.error!==void 0,has_data:t.data.some(f=>f.length>0),simultaneously_sent_query_count:n.length,time_range_from:e?.range?.from?.toISOString(),time_range_to:e?.range?.to?.toISOString(),time_taken:Date.now()-r.getTime()})}}function Ri(t){(0,Js.ff)("grafana_elasticsearch_annotation_query_executed",{grafana_version:Re.config.buildInfo.version,has_target_query:!!t.target?.query,has_query:!!t.query,has_time_field:!!t.timeField,has_time_end_field:!!t.timeEndField,has_tags_field:!!t.tagsField,has_text_field:!!t.textField,has_index:!!t.index})}class Ni{constructor(e,r){this.datasource=e,this.templateSrv=r}request(e,r,n,a){if(!this.datasource.isProxyAccess){const f=new Error("Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode.");return(0,Ks._)(()=>f)}const u={url:this.datasource.url+"/"+r,method:e,data:n,headers:a};return e==="POST"&&(u.headers=u.headers??{},u.headers["Content-Type"]="application/x-ndjson"),(this.datasource.basicAuth||this.datasource.withCredentials)&&(u.withCredentials=!0),this.datasource.basicAuth&&(u.headers={Authorization:this.datasource.basicAuth}),(0,xi.i)().fetch(u).pipe((0,We.U)(f=>(f.data.$$config=f.config,f.data)),(0,hs.K)(f=>{if(f.data){const p=f.data.error?.reason??f.data.message??"Unknown error";return(0,Ks._)({message:p,error:f.data.error})}return(0,Ks._)(f)}))}async logContextQuery(e,r){const a=e.dataFrame.fields.find(he=>he.name==="sort")?.values[e.rowIndex]||[e.timeEpochMs],u=r?.direction===Z.M4.Forward?"asc":"desc",f=r?.direction===Z.M4.Forward?this.datasource.getQueryHeader("query_then_fetch",(0,K.CQ)(e.timeEpochMs)):this.datasource.getQueryHeader("query_then_fetch",void 0,(0,K.CQ)(e.timeEpochMs)),p=r?.limit??10,y=JSON.stringify({size:p,query:{bool:{filter:[{range:{[this.datasource.timeField]:{[r?.direction===Z.M4.Forward?"gte":"lte"]:e.timeEpochMs,format:"epoch_millis"}}}]}},sort:[{[this.datasource.timeField]:u},{_doc:u}],search_after:a}),g=[f,y].join(`
`)+`
`,h=this.datasource.getMultiSearchUrl(),S=await(0,le.n)(this.request("POST",h,g)),C=[{refId:`${e.dataFrame.refId}`,metrics:[{type:"logs",id:"1"}]}],B=new yr(C,Li(S,u)).getLogs(this.datasource.logMessageField,this.datasource.logLevelField),de=(0,T.first)(B.data);if(!de)return{data:[]};const je=de.fields.find(he=>he.name===this.datasource.timeField),Lt=de.fields.find(he=>he.name===this.datasource.logMessageField),Ss=de.fields.filter(he=>he!==je&&he!==Lt);return je&&Lt?{data:[{...de,fields:[(0,pr.J_)(je),Lt,...Ss]}]}:B}query(e){let r="";const n=this.datasource.interpolateVariablesInQueries((0,T.cloneDeep)(e.targets),e.scopedVars),a=[];let u=n.some(g=>Me(g,"logs"));const f=[];for(const g of n){if(g.hide)continue;let h;if(Me(g,"logs")){g.bucketAggs=[be()];const B=g.metrics?.find(je=>je.type==="logs"),de=B.settings?.limit?parseInt(B.settings?.limit,10):500;f.push(de),g.metrics=[],h=this.datasource.queryBuilder.getLogsQuery(g,de)}else f.push(),g.alias&&(g.alias=this.datasource.interpolateLuceneQuery(g.alias,e.scopedVars)),h=this.datasource.queryBuilder.build(g);const S=JSON.stringify(h),C="query_then_fetch",P=this.datasource.getQueryHeader(C,e.range.from,e.range.to);r+=P+`
`,r+=S+`
`,a.push(g)}if(a.length===0)return(0,Ot.of)({data:[]});r=r.replace(/"\$timeFrom"/g,e.range.from.valueOf().toString()),r=r.replace(/"\$timeTo"/g,e.range.to.valueOf().toString()),r=this.templateSrv.replace(r,e.scopedVars);const p=this.datasource.getMultiSearchUrl(),y=new Date;return this.request("POST",p,r).pipe((0,We.U)(g=>{const h=new yr(a,g);if(u){const S=h.getLogs(this.datasource.logMessageField,this.datasource.logLevelField);return S.data.forEach((C,P)=>{ki(C,this.datasource.dataLinks,f[P])}),S}return h.getTimeSeries()}),(0,dr.b)(g=>Sr(g,e,y)))}}function Li(t,e){if(e==="desc")return t;const r=t.responses[0];return{...t,responses:[{...r,hits:{...r.hits,hits:r.hits.hits.reverse()}}]}}function ki(t,e,r){r&&(t.meta={...t.meta,limit:r}),Tr(t,e)}var Qi=v(70605),vs=v(73375),Bi=v(37739);function Vi(t){const e=t.annotation,r=t.onAnnotationChange;return l.createElement(Bi.K,{direction:"column",gap:5},l.createElement("div",null,l.createElement(lr,{value:e.target?.query,onChange:n=>{const u={...e.target??{refId:"annotation_query"},query:n};r({...e,target:u})}})),l.createElement("div",null,l.createElement("h6",null,"Field mappings"),l.createElement(Qi.p,null,l.createElement(vs.S,{label:"Time"},l.createElement(w.I,{type:"text",placeholder:"@timestamp",value:e.timeField,onChange:n=>{r({...e,timeField:n.currentTarget.value})}})),l.createElement(vs.S,{label:"Time End"},l.createElement(w.I,{type:"text",value:e.timeEndField,onChange:n=>{r({...e,timeEndField:n.currentTarget.value})}})),l.createElement(vs.S,{label:"Text"},l.createElement(w.I,{type:"text",value:e.textField,onChange:n=>{r({...e,textField:n.currentTarget.value})}})),l.createElement(vs.S,{label:"Tags"},l.createElement(w.I,{type:"text",placeholder:"tags",value:e.tagsField,onChange:n=>{r({...e,tagsField:n.currentTarget.value})}})))),l.createElement("div",null))}function Wi(t){return!t||typeof t!="object"?!1:"meta"in t}var ut=v(42275);function bs(t,e,r,n=""){return Fr(t,e,r,n)!==null}function Fr(t,e,r,n=""){const a=`${n}${ut.term.escape(e)}`;r=ut.phrase.escape(r);let u=Cr(t);return u?Zs(u,a,r):null}function Zs(t,e,r){return Object.keys(t).length===0?null:wr(t.left)?Zs(t.left,e,r):Es(t.left)&&t.left.field===e&&t.left.term===r?t.left:tr(t)?null:Es(t.right)&&t.right.field===e&&t.right.term===r?t.right:sr(t.right)?Zs(t.right,e,r):null}function Nt(t,e,r,n=""){if(bs(t,e,r,n))return t;e=Ir(e),r=er(r);const a=`${n}${e}:"${r}"`;return xr(t,a)}function xr(t,e,r="AND"){return e?t.trim()===""?e:`${t} ${r} ${e}`:t}function ji(t,e){if(!e.key||!e.value)return t;if(e={...e,value:e.value.toString()},["=","!="].includes(e.operator))return Nt(t,e.key,e.value,e.operator==="="?"":"-");const n=Ir(e.key),a=er(e.value);let u="";switch(e.operator){case"=~":u=`${n}:/${a}/`;break;case"!~":u=`-${n}:/${a}/`;break;case">":u=`${n}:>${a}`;break;case"<":u=`${n}:<${a}`;break}return xr(t,u)}function $r(t,e,r,n=""){const a=Fr(t,e,r,n),u=Cr(t);return!a||!u?t:ut.toString(Xs(u,a))}function Xs(t,e){return Object.keys(t).length===0?t:wr(t.left)?(t.left=Xs(t.left,e),t):Es(t.left)&&(0,T.isEqual)(t.left,e)?(Object.assign(t,{left:void 0,operator:void 0,right:void 0},"right"in t?t.right:{}),t):tr(t)?t:Es(t.right)&&(0,T.isEqual)(t.right,e)?(Object.assign(t,{right:void 0,operator:void 0}),t):(sr(t.right)&&(t.right=Xs(t.right,e)),t)}function Ir(t){return ut.term.escape(t)}function er(t){return t=t.replace(/\\/g,"\\\\"),ut.phrase.escape(t)}function zi(t){return t.replace(/(\w+)\s(:)/gi,"$1$2")}function tr(t){return!t||typeof t!="object"?!1:"left"in t&&!("right"in t)}function sr(t){return!t||typeof t!="object"?!1:"left"in t&&"right"in t}function wr(t){return tr(t)||sr(t)}function Es(t){return!!(t&&typeof t=="object"&&"term"in t)}function Cr(t){try{return ut.parse(zi(t))}catch{return null}}function Mr(t,e,r=!0){const n=`"${er(e)}"`;return t.trim()?`${t} ${r?"AND":"NOT"} ${n}`:`${r?"":"NOT "}${n}`}const _r="log-volume-",Ar="log-sample-",Hi=["_index","_type","_id","_source","_size","_field_names","_ignored","_routing","_meta"];class qi extends yi.CK{constructor(e,r=(0,vi.J)()){super(e),this.templateSrv=r,this.getLogRowContext=async(a,u)=>{const{enableElasticsearchBackendQuerying:f}=Re.config.featureToggles;if(f){const p=this.makeLogContextDataRequest(a,u);return(0,le.n)(this.query(p).pipe((0,hs.K)(y=>{throw{message:"Error during context query. Please check JS console logs.",status:y.status,statusText:y.statusText}})))}else return this.legacyQueryRunner.logContextQuery(a,u)},this.makeLogContextDataRequest=(a,u)=>{const f=u?.direction||Z.M4.Backward,p={type:"logs",id:"1",settings:{limit:u?.limit?u?.limit.toString():"10",sortDirection:f===Z.M4.Backward?"desc":"asc",searchAfter:a.dataFrame.fields.find(P=>P.name==="sort")?.values[a.rowIndex]??[a.timeEpochMs]}},y={refId:`log-context-${a.dataFrame.refId}-${f}`,metrics:[p],query:""},g=Gi(a.timeEpochMs,f,this.intervalPattern),h={from:g.from,to:g.to,raw:g},S=hi.calculateInterval(h,1);return{requestId:`log-context-request-${a.dataFrame.refId}-${u?.direction}`,targets:[y],interval:S.interval,intervalMs:S.intervalMs,range:h,scopedVars:{},timezone:"UTC",app:Gs.zj.Explore,startTime:Date.now(),hideFromInspector:!0}},this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.url=e.url,this.name=e.name,this.isProxyAccess=e.access==="proxy";const n=e.jsonData||{};this.index=n.index??e.database??"",this.timeField=n.timeField,this.xpack=!!n.xpack,this.indexPattern=new Si(this.index,n.interval),this.intervalPattern=n.interval,this.interval=n.timeInterval,this.maxConcurrentShardRequests=n.maxConcurrentShardRequests,this.queryBuilder=new it({timeField:this.timeField}),this.logMessageField=n.logMessageField||"",this.logLevelField=n.logLevelField||"",this.dataLinks=n.dataLinks||[],this.includeFrozen=n.includeFrozen??!1,this.databaseVersion=null,this.annotations={QueryEditor:Vi},this.logMessageField===""&&(this.logMessageField=void 0),this.logLevelField===""&&(this.logLevelField=void 0),this.languageProvider=new Fi(this),this.legacyQueryRunner=new Ni(this,this.templateSrv)}getResourceRequest(e,r,n){return this.getResource(e,r,n)}postResourceRequest(e,r,n){const a=n??{};return a.headers=a.headers??{},a.headers["content-type"]="application/x-ndjson",this.postResource(e,r,a)}async importFromAbstractQueries(e){return e.map(r=>this.languageProvider.importFromAbstractQuery(r))}requestAllIndices(e=(0,Y.JK)()){let r=this.indexPattern.getIndexList(e.from,e.to);Array.isArray(r)||(r=[this.indexPattern.getIndexForToday()]);const n="_mapping",a=r.map(p=>(p=p.replace(/\/$/,""),p===""?n:`${p}/${n}`)),u=7,f=a.length;return(0,fi.R)({initialState:0,condition:p=>p<Math.min(f,u),iterate:p=>p+1}).pipe((0,ur.z)(p=>{const y=a[f-p-1];return(Re.config.featureToggles.enableElasticsearchBackendQuerying?(0,ms.D)(this.getResource(y)):this.legacyQueryRunner.request("GET",y)).pipe((0,hs.K)(h=>(0,Ot.of)({err:h})))}),(0,gi.n)(p=>p?.err?.status===404),(0,pi.T)(()=>"Could not find an available index for this time range."),(0,mi.P)(),(0,We.U)(p=>{if(p.err)throw p.err;return p}))}annotationQuery(e){const r=this.prepareAnnotationRequest(e);Ri(e.annotation);const n=Re.config.featureToggles.enableElasticsearchBackendQuerying?(0,ms.D)(this.postResourceRequest("_msearch",r)):this.legacyQueryRunner.request("POST","_msearch",r);return(0,le.n)(n.pipe((0,We.U)(a=>{const u=a.responses[0].hits.hits;return this.processHitsToAnnotationEvents(e.annotation,u)})))}prepareAnnotationRequest(e){const r=e.annotation,n=r.timeField||"@timestamp",a=r.timeEndField||null,u=r.query??r.target?.query??"",f=[],p={};if(p[n]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},f.push({range:p}),a){const P={};P[a]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},f.push({range:P})}const y=this.interpolateLuceneQuery(u),g={bool:{filter:[{bool:{should:f,minimum_should_match:1}}]}};y&&g.bool.filter.push({query_string:{query:y}});const h={query:g,size:1e4},S={search_type:"query_then_fetch",ignore_unavailable:!0};return r.index?S.index=r.index:S.index=this.indexPattern.getIndexList(e.range.from,e.range.to),JSON.stringify(S)+`
`+JSON.stringify(h)+`
`}processHitsToAnnotationEvents(e,r){const n=e.timeField||"@timestamp",a=e.timeEndField||null,u=e.textField||"tags",f=e.tagsField||null,p=[],y=(g,h)=>{if(!h)return;const S=h.split(".");let C=g;for(let P=0;P<S.length;P++)if(C=C[S[P]],!C)return"";return C};for(let g=0;g<r.length;g++){const h=r[g]._source;let S=y(h,n);if(typeof r[g].fields<"u"){const B=r[g].fields;typeof B=="object"&&((0,T.isString)(B[n])||(0,T.isNumber)(B[n]))&&(S=B[n])}const C={annotation:e,time:(0,K.zh)(S).valueOf(),text:y(h,u)};if(a){const B=y(h,a);B&&(C.timeEnd=(0,K.zh)(B).valueOf())}if(e.titleField){const B=y(h,e.titleField);B&&(C.text=B+`
`+C.text)}const P=y(h,f);typeof P=="string"?C.tags=P.split(","):C.tags=P,p.push(C)}return p}interpolateLuceneQuery(e,r){return this.templateSrv.replace(e,r,"lucene")}interpolateVariablesInQueries(e,r,n){return e.map(a=>this.applyTemplateVariables(a,r,n))}async testDatasource(){const e=await this.getDatabaseVersion(!1),n=(e!=null?ht(e):!0)?"":`WARNING: ${yt} `;return(0,le.n)(this.getFields(["date"]).pipe((0,ur.z)(a=>(0,T.find)(a,{text:this.timeField})?(0,Ot.of)({status:"success",message:`${n}Data source successfully connected.`}):(0,Ot.of)({status:"error",message:"No date field named "+this.timeField+" found"})),(0,hs.K)(a=>{const f=`Unable to connect with Elasticsearch${a.message?` (${a.message})`:""}. Please check the server logs for more details.`;return(0,Ot.of)({status:"error",message:f})})))}getQueryHeader(e,r,n){const a={search_type:e,ignore_unavailable:!0,index:this.indexPattern.getIndexList(r,n)};return JSON.stringify(a)}getQueryDisplayText(e){const r=e.metrics,n=e.bucketAggs;let a="";return e.query&&(a+="Query: "+e.query+", "),a+="Metrics: ",a+=r?.reduce((u,f)=>{let y=N[f.type].label+"(";return X(f)&&(y+=f.field),ze(f)&&(y+=_e(f).replace(new RegExp("params.","g"),"")),y+="), ",`${u} ${y}`},""),a+=n?.reduce((u,f,p)=>{const y=V[f.type];let g="";return p===0&&(g+=" Group by: "),g+=y.label+"(",st(f)&&(g+=f.field),`${u} ${g}), `},""),e.alias&&(a+="Alias: "+e.alias),a}getDataProvider(e,r){if(this.getSupportedSupplementaryQueryTypes().includes(e))switch(e){case Z.v8.LogsVolume:return this.getLogsVolumeDataProvider(r);case Z.v8.LogsSample:return this.getLogsSampleDataProvider(r);default:return}}getSupportedSupplementaryQueryTypes(){return[Z.v8.LogsVolume,Z.v8.LogsSample]}getSupplementaryQuery(e,r){if(!this.getSupportedSupplementaryQueryTypes().includes(e.type))return;let n=!1;switch(e.type){case Z.v8.LogsVolume:if(n=r.metrics?.length===1&&r.metrics[0].type==="logs",!n)return;const a=[],u=this.timeField??"@timestamp";return this.logLevelField&&a.push({id:"2",type:"terms",settings:{min_doc_count:"0",size:"0",order:"desc",orderBy:"_count",missing:Z.in.unknown},field:this.logLevelField}),a.push({id:"3",type:"date_histogram",settings:{interval:"auto",min_doc_count:"0",trimEdges:"0"},field:u}),{refId:`${_r}${r.refId}`,query:r.query,metrics:[{type:"count",id:"1"}],timeField:u,bucketAggs:a};case Z.v8.LogsSample:return n=vt(r),n?e.limit?{refId:`${Ar}${r.refId}`,query:r.query,metrics:[{type:"logs",id:"1",settings:{limit:e.limit.toString()}}]}:{refId:`${Ar}${r.refId}`,query:r.query,metrics:[{type:"logs",id:"1"}]}:void 0;default:return}}getLogsVolumeDataProvider(e){const r=(0,T.cloneDeep)(e),n=r.targets.map(a=>this.getSupplementaryQuery({type:Z.v8.LogsVolume},a)).filter(a=>!!a);if(n.length)return(0,fr.Bz)(this,{...r,targets:n},{range:e.range,targets:e.targets,extractLevel:Ki})}getLogsSampleDataProvider(e){const r=(0,T.cloneDeep)(e),u=r.targets.map(f=>this.getSupplementaryQuery({type:Z.v8.LogsSample,limit:100},f)).filter(f=>!!f);if(u.length)return(0,fr.Ce)(this,{...r,targets:u})}query(e){const{enableElasticsearchBackendQuerying:r}=Re.config.featureToggles;if(r){const n=new Date;return super.query(e).pipe((0,dr.b)(a=>Sr(a,e,n)),(0,We.U)(a=>(a.data.forEach(u=>{Tr(u,this.dataLinks)}),a)))}return this.legacyQueryRunner.query(e)}filterQuery(e){return!e.hide}isMetadataField(e){return Hi.includes(e)}getFields(e,r){const n={float:"number",double:"number",integer:"number",long:"number",date:"date",date_nanos:"date",string:"string",text:"string",scaled_float:"number",nested:"nested",histogram:"number"};return this.requestAllIndices(r).pipe((0,We.U)(a=>{const u=(g,h)=>this.isMetadataField(h)?!1:!e||e.length===0?!0:e.includes(g.type)||e.includes(n[g.type]),f=[],p={};function y(g){for(const h in g){const S=g[h];if((0,T.isObject)(S.properties)&&(f.push(h),y(S.properties)),(0,T.isObject)(S.fields)&&(f.push(h),y(S.fields)),(0,T.isString)(S.type)){const C=f.concat(h).join(".");u(S,h)&&(p[C]={text:C,type:S.type})}}f.pop()}for(const g in a){const h=a[g];if(h&&h.mappings){const C=h.mappings.properties;y(C)}}return(0,T.map)(p,g=>g)}))}getTerms(e,r=(0,Y.JK)()){const n="query_then_fetch",a=this.getQueryHeader(n,r.from,r.to);let u=JSON.stringify(this.queryBuilder.getTermsQuery(e));u=u.replace(/\$timeFrom/g,r.from.valueOf().toString()),u=u.replace(/\$timeTo/g,r.to.valueOf().toString()),u=a+`
`+u+`
`;const f=this.getMultiSearchUrl();return(Re.config.featureToggles.enableElasticsearchBackendQuerying?(0,ms.D)(this.postResourceRequest(f,u)):this.legacyQueryRunner.request("POST",f,u)).pipe((0,We.U)(y=>{if(!y.responses[0].aggregations)return[];const g=y.responses[0].aggregations[1].buckets;return(0,T.map)(g,h=>({text:h.key_as_string||h.key,value:h.key}))}))}getMultiSearchUrl(){const e=new URLSearchParams;return this.maxConcurrentShardRequests&&e.append("max_concurrent_shard_requests",`${this.maxConcurrentShardRequests}`),this.xpack&&this.includeFrozen&&e.append("ignore_throttled","false"),("_msearch?"+e.toString()).replace(/\?$/,"")}metricFindQuery(e,r){const n=r?.range,a=JSON.parse(e);if(e){if(a.find==="fields")return a.type=this.interpolateLuceneQuery(a.type),(0,le.n)(this.getFields(a.type,n));if(a.find==="terms")return a.field=this.interpolateLuceneQuery(a.field),a.query=this.interpolateLuceneQuery(a.query),(0,le.n)(this.getTerms(a,n))}return Promise.resolve([])}getTagKeys(){return(0,le.n)(this.getFields())}getTagValues(e){return(0,le.n)(this.getTerms({field:e.key},e.timeRange))}targetContainsTemplate(e){if(this.templateSrv.containsTemplate(e.query)||this.templateSrv.containsTemplate(e.alias))return!0;if(e.bucketAggs){for(const r of e.bucketAggs)if(st(r)&&this.templateSrv.containsTemplate(r.field)||this.objectContainsTemplate(r.settings))return!0}if(e.metrics){for(const r of e.metrics)if(X(r)&&(r.field&&this.templateSrv.containsTemplate(r.field)||r.settings&&this.objectContainsTemplate(r.settings)||Wi(r)&&this.objectContainsTemplate(r.meta)))return!0}return!1}objectContainsTemplate(e){if(typeof e=="string")return this.templateSrv.containsTemplate(e);if(!e||typeof e!="object")return!1;for(const r of Object.keys(e))if(Array.isArray(e[r])){for(const n of e[r])if(this.objectContainsTemplate(n))return!0}else if(this.objectContainsTemplate(e[r]))return!0;return!1}toggleQueryFilter(e,r){let n=e.query??"";switch(r.type){case"FILTER_FOR":{n=bs(n,r.options.key,r.options.value)?$r(n,r.options.key,r.options.value):Nt(n,r.options.key,r.options.value);break}case"FILTER_OUT":{bs(n,r.options.key,r.options.value)&&(n=$r(n,r.options.key,r.options.value)),n=Nt(n,r.options.key,r.options.value,"-");break}}return{...e,query:n}}queryHasFilter(e,r){let n=e.query??"";return bs(n,r.key,r.value)}modifyQuery(e,r){if(!r.options)return e;let n=e.query??"";switch(r.type){case"ADD_FILTER":{n=Nt(n,r.options.key,r.options.value);break}case"ADD_FILTER_OUT":{n=Nt(n,r.options.key,r.options.value,"-");break}case"ADD_STRING_FILTER":{n=Mr(n,r.options.value);break}case"ADD_STRING_FILTER_OUT":{n=Mr(n,r.options.value,!1);break}}return{...e,query:n}}getSupportedQueryModifications(){return["ADD_FILTER","ADD_FILTER_OUT","ADD_STRING_FILTER","ADD_STRING_FILTER_OUT"]}addAdHocFilters(e,r){if(!r)return e;let n=e;return r.forEach(a=>{n=ji(n,a)}),n}applyTemplateVariables(e,r,n){const a=p=>p.type==="filters"?{...p,settings:{...p.settings,filters:p.settings?.filters?.map(y=>({...y,query:this.interpolateLuceneQuery(y.query,r)||"*"}))}}:p,u={...e,datasource:this.getRef(),query:this.addAdHocFilters(this.interpolateLuceneQuery(e.query||"",r),n),bucketAggs:e.bucketAggs?.map(a)};return JSON.parse(this.templateSrv.replace(JSON.stringify(u),r))}getDatabaseVersionUncached(){const e=Re.config.featureToggles.enableElasticsearchBackendQuerying?(0,ms.D)(this.getResourceRequest("")):this.legacyQueryRunner.request("GET","/");return(0,le.n)(e).then(r=>{const n=r?.version?.number;if(typeof n!="string")return null;try{return new ke.SemVer(n)}catch(a){return console.error(a),null}},r=>(console.error(r),null))}async getDatabaseVersion(e=!0){if(e){const n=this.databaseVersion;if(n!=null)return n}const r=await this.getDatabaseVersionUncached();return this.databaseVersion=r,r}}function Tr(t,e){if(e.length)for(const r of t.fields){const n=e.filter(a=>new RegExp(a.field).test(r.name));n.length!==0&&(r.config=r.config||{},r.config.links=[...(r.config.links,n.map(Ui))])}}function Ui(t){const e=(0,bi.F)();if(t.datasourceUid){const r=e.getInstanceSettings(t.datasourceUid);return{title:t.urlDisplayLabel||"",url:"",internal:{query:{query:t.url},datasourceUid:t.datasourceUid,datasourceName:r?.name??"Data source not found"}}}else return{title:t.urlDisplayLabel||"",url:t.url}}function Gi(t,e,r){if(r){const a=gr[r];return e===Z.M4.Forward?{from:(0,K.CQ)(t).utc(),to:(0,K.CQ)(t).add(7,a.amount).utc().startOf(a.startOf)}:{from:(0,K.CQ)(t).subtract(7,a.amount).utc().startOf(a.startOf),to:(0,K.CQ)(t).utc()}}else return e===Z.M4.Forward?{from:(0,K.CQ)(t).utc(),to:(0,K.CQ)(t).add(7,"hours").utc()}:{from:(0,K.CQ)(t).subtract(7,"hours").utc(),to:(0,K.CQ)(t).utc()}}function Ki(t){const r=t.fields.find(n=>n.type===$e.fS.number)?.labels?.level??"";return(0,Ei.jx)(r)}const Yi=new I.hf(qi).setQueryEditor(kr).setConfigEditor(di);(0,R.N$)().subscribe(m.Pl,Ti)},81528:(Ie,W)=>{W.escape=function(R){return R.replace(/[\+\-\!\(\)\{\}\[\]\^\"\?\:\\\&\|\'\/\s\*\~]/g,v)};function v(m){return"\\"+m}W.unescape=function(R){return R.replace(/\\([\+\-\!\(\)\{\}\[\]\^\"\?\:\\\&\|\'\/\s\*\~])/g,I)};function I(m,R){return R}W.escapePhrase=function(R){return R.replace(/"/g,v)},W.unescapePhrase=function(R){return R.replace(/\\(")/g,I)}},42275:(Ie,W,v)=>{"use strict";var I=v(39087),m=v(81528);W.parse=I.parse.bind(I),W.toString=v(76396),W.term={escape:m.escape,unescape:m.unescape},W.phrase={escape:m.escapePhrase,unescape:m.unescapePhrase}},39087:Ie=>{"use strict";function W(m,R){function i(){this.constructor=m}i.prototype=R.prototype,m.prototype=new i}function v(m,R,i,l){this.message=m,this.expected=R,this.found=i,this.location=l,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,v)}W(v,Error),v.buildMessage=function(m,R){var i={literal:function($){return'"'+Y($.text)+'"'},class:function($){var w="",k;for(k=0;k<$.parts.length;k++)w+=$.parts[k]instanceof Array?te($.parts[k][0])+"-"+te($.parts[k][1]):te($.parts[k]);return"["+($.inverted?"^":"")+w+"]"},any:function($){return"any character"},end:function($){return"end of input"},other:function($){return $.description}};function l($){return $.charCodeAt(0).toString(16).toUpperCase()}function Y($){return $.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(w){return"\\x0"+l(w)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(w){return"\\x"+l(w)})}function te($){return $.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(w){return"\\x0"+l(w)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(w){return"\\x"+l(w)})}function se($){return i[$.type]($)}function we($){var w=new Array($.length),k,J;for(k=0;k<$.length;k++)w[k]=se($[k]);if(w.sort(),w.length>0){for(k=1,J=1;k<w.length;k++)w[k-1]!==w[k]&&(w[J]=w[k],J++);w.length=J}switch(w.length){case 1:return w[0];case 2:return w[0]+" or "+w[1];default:return w.slice(0,-1).join(", ")+", or "+w[w.length-1]}}function ie($){return $?'"'+Y($)+'"':"end of input"}return"Expected "+we(m)+" but "+ie(R)+" found."};function I(m,R){R=R!==void 0?R:{};var i={},l={start:is},Y=is,te=function(s){return s[0]},se=function(){return{}},we=function(s){return{operator:s}},ie=function(s,c,d,D){var E={start:s,left:c},D=D.length==0?null:D[0].right==null?D[0].left:D[0];return D!=null&&(E.operator=d==""?"<implicit>":d[0],E.right=D),E},$=function(s,c){return c},w=function(s,c,E){var b={left:s},E=E.length==0?null:E[0].right==null?E[0].left:E[0];return E!=null&&(b.operator=c==""?"<implicit>":c[0],b.right=E),b},k=function(s){return s},J="(",fe=O("(",!1),z=")",Q=O(")",!1),j=function(s){return s[0].parenthesized=!0,s[0]},U=function(s,c){return c.field=s==null||s.label==""?"<implicit>":s.label,c.fieldLocation=s==null||s.label==""?null:s.location,c},Ne=function(s,c){return c.field=s.label,c.fieldLocation=s.location,c},Ce=function(s,c){var d={field:s==null||s.label==""?"<implicit>":s.label,fieldLocation:s==null||s.label==""?null:s.location};for(var b in c)d[b]=c[b];return d},dt=/^[:]/,X=Oe([":"],!1,!1),Le=function(s){return{label:s.label,location:s.location}},ze=function(s,c,d,b){var E={term:c,quoted:!0,regex:!1,termLocation:at()};return d!=""&&(E.proximity=d),b!=""&&(E.boost=b),s!=""&&(E.prefix=s),E},Fs=function(s,c){var d={term:c,quoted:!1,regex:!0,termLocation:at()};return d},ft=function(s,c,d,b){var E={term:c.label,quoted:!1,regex:!1,termLocation:at()};return d!=""&&(E.similarity=d),b!=""&&(E.boost=b),s!=""&&(E.prefix=s),E},ye="\\",ge=O("\\",!1),He=function(s){return"\\"+s},kt=".",N=O(".",!1),xs=/^[^ \t\r\n\f{}()"\/\^~[\]]/,Qt=Oe([" ","	","\r",`
`,"\f","{","}","(",")",'"',"/","^","~","[","]"],!0,!1),gt=function(s){return s.join("")},$s=function(s){return{label:s.join(""),location:at()}},qe=/^[^: \t\r\n\f{}()"\/\^~[\]]/,pt=Oe([":"," ","	","\r",`
`,"\f","{","}","(",")",'"',"/","^","~","[","]"],!0,!1),ve='"',be=O('"',!1),Bt=function(s){return s.join("")},Me="/",Ue=O("/",!1),Is=function(s){return s.join("")},ke=Ct(),pe=function(s){return s},Ge="+",mt=O("+",!1),_e="-",ht=O("-",!1),yt="!",vt=O("!",!1),L="{",Ke=O("{",!1),Ye="}",Je=O("}",!1),Qe="[",Ae=O("[",!1),Ze="]",H=O("]",!1),bt="^",Te=O("^",!1),Vt="?",Wt=O("?",!1),ws=":",Cs=O(":",!1),Et="&",jt=O("&",!1),V="|",zt=O("|",!1),St="'",Ms=O("'",!1),Xe="~",et=O("~",!1),Ht="*",qt=O("*",!1),G=" ",_s=O(" ",!1),As=function(s){return s},Ut=function(s){return s},Gt=function(s){return s==""||s==null?.5:s},Ft="0.",Ts=O("0.",!1),De=/^[0-9]/,ae=Oe([["0","9"]],!1,!1),Kt=function(s){return parseFloat("0."+s.join(""))},Ds=function(s){return parseInt(s.join(""))},ce="TO",tt=O("TO",!1),Ps=function(s,c){return{term_min:s,term_max:c,inclusive:"both"}},Pe=function(s,c){return{term_min:s,term_max:c,inclusive:"none"}},T=function(s,c){return{term_min:s,term_max:c,inclusive:"left"}},xt=function(s,c){return{term_min:s,term_max:c,inclusive:"right"}},Ee=function(s){return s},$t="OR NOT",Yt=O("OR NOT",!1),Jt="AND NOT",Zt=O("AND NOT",!1),Be="OR",le=O("OR",!1),st="AND",Os=O("AND",!1),Xt="NOT",Rs=O("NOT",!1),es="||",rt=O("||",!1),Se="&&",Ns=O("&&",!1),Ls=lt("whitespace"),It=/^[ \t\r\n\f]/,ne=Oe([" ","	","\r",`
`,"\f"],!1,!1),o=0,A=0,it=[{line:1,column:1}],oe=0,wt=[],F=0,nt;if("startRule"in R){if(!(R.startRule in l))throw new Error(`Can't start parsing from rule "`+R.startRule+'".');Y=l[R.startRule]}function rr(){return m.substring(A,o)}function at(){return Ve(A,o)}function ir(s,c){throw c=c!==void 0?c:Ve(A,o),rs([lt(s)],m.substring(A,o),c)}function nr(s,c){throw c=c!==void 0?c:Ve(A,o),ks(s,c)}function O(s,c){return{type:"literal",text:s,ignoreCase:c}}function Oe(s,c,d){return{type:"class",parts:s,inverted:c,ignoreCase:d}}function Ct(){return{type:"any"}}function ts(){return{type:"end"}}function lt(s){return{type:"other",description:s}}function ss(s){var c=it[s],d;if(c)return c;for(d=s-1;!it[d];)d--;for(c=it[d],c={line:c.line,column:c.column};d<s;)m.charCodeAt(d)===10?(c.line++,c.column=1):c.column++,d++;return it[s]=c,c}function Ve(s,c){var d=ss(s),b=ss(c);return{start:{offset:s,line:d.line,column:d.column},end:{offset:c,line:b.line,column:b.column}}}function x(s){o<oe||(o>oe&&(oe=o,wt=[]),wt.push(s))}function ks(s,c){return new v(s,null,null,c)}function rs(s,c,d){return new v(v.buildMessage(s,c),s,c,d)}function is(){var s,c,d,b;for(s=o,c=[],d=M();d!==i;)c.push(d),d=M();if(c!==i){if(d=[],b=ue(),b!==i)for(;b!==i;)d.push(b),b=ue();else d=i;d!==i?(A=s,c=te(d),s=c):(o=s,s=i)}else o=s,s=i;if(s===i){for(s=o,c=[],d=M();d!==i;)c.push(d),d=M();c!==i&&(A=s,c=se()),s=c,s===i&&(s=o,c=ot(),c!==i&&(A=s,c=se()),s=c)}return s}function ue(){var s,c,d,b,E,D;if(s=o,c=xe(),c!==i?(d=ot(),d!==i?(A=s,c=we(c),s=c):(o=s,s=i)):(o=s,s=i),s===i){if(s=o,c=xe(),c!==i)if(d=Mt(),d!==i){for(b=[],E=xe();E!==i;)b.push(E),E=xe();if(b!==i){for(E=[],D=ue();D!==i;)E.push(D),D=ue();E!==i?(A=s,c=ie(c,d,b,E),s=c):(o=s,s=i)}else o=s,s=i}else o=s,s=i;else o=s,s=i;if(s===i&&(s=o,c=xe(),c!==i?(d=ue(),d!==i?(A=s,c=$(c,d),s=c):(o=s,s=i)):(o=s,s=i),s===i))if(s=o,c=Mt(),c!==i){for(d=[],b=xe();b!==i;)d.push(b),b=xe();if(d!==i){for(b=[],E=ue();E!==i;)b.push(E),E=ue();b!==i?(A=s,c=w(c,d,b),s=c):(o=s,s=i)}else o=s,s=i}else o=s,s=i}return s}function Mt(){var s,c,d,b;if(s=o,c=ee(),c!==i){for(d=[],b=M();b!==i;)d.push(b),b=M();d!==i?(A=s,c=k(c),s=c):(o=s,s=i)}else o=s,s=i;return s===i&&(s=ns()),s}function ns(){var s,c,d,b,E,D,_;if(s=o,m.charCodeAt(o)===40?(c=J,o++):(c=i,F===0&&x(fe)),c!==i){for(d=[],b=M();b!==i;)d.push(b),b=M();if(d!==i){if(b=[],E=ue(),E!==i)for(;E!==i;)b.push(E),E=ue();else b=i;if(b!==i)if(m.charCodeAt(o)===41?(E=z,o++):(E=i,F===0&&x(Q)),E!==i){for(D=[],_=M();_!==i;)D.push(_),_=M();D!==i?(A=s,c=j(b),s=c):(o=s,s=i)}else o=s,s=i;else o=s,s=i}else o=s,s=i}else o=s,s=i;return s}function ee(){var s,c,d;return s=o,c=_t(),c===i&&(c=null),c!==i?(d=Vs(),d!==i?(A=s,c=U(c,d),s=c):(o=s,s=i)):(o=s,s=i),s===i&&(s=o,c=_t(),c!==i?(d=ns(),d!==i?(A=s,c=Ne(c,d),s=c):(o=s,s=i)):(o=s,s=i),s===i&&(s=o,c=_t(),c===i&&(c=null),c!==i?(d=Qs(),d!==i?(A=s,c=Ce(c,d),s=c):(o=s,s=i)):(o=s,s=i))),s}function _t(){var s,c,d,b,E;if(s=o,c=ls(),c!==i)if(dt.test(m.charAt(o))?(d=m.charAt(o),o++):(d=i,F===0&&x(X)),d!==i){for(b=[],E=M();E!==i;)b.push(E),E=M();b!==i?(A=s,c=Le(c),s=c):(o=s,s=i)}else o=s,s=i;else o=s,s=i;return s}function Qs(){var s,c,d,b,E,D,_;if(s=o,c=Pt(),c===i&&(c=null),c!==i)if(d=Bs(),d!==i)if(b=Tt(),b===i&&(b=null),b!==i)if(E=Dt(),E===i&&(E=null),E!==i){for(D=[],_=M();_!==i;)D.push(_),_=M();D!==i?(A=s,c=ze(c,d,b,E),s=c):(o=s,s=i)}else o=s,s=i;else o=s,s=i;else o=s,s=i;else o=s,s=i;if(s===i){if(s=o,c=Pt(),c===i&&(c=null),c!==i)if(d=os(),d!==i){for(b=[],E=M();E!==i;)b.push(E),E=M();b!==i?(A=s,c=Fs(c,d),s=c):(o=s,s=i)}else o=s,s=i;else o=s,s=i;if(s===i)if(s=o,c=Pt(),c===i&&(c=null),c!==i)if(d=ls(),d!==i)if(b=us(),b===i&&(b=null),b!==i)if(E=Dt(),E===i&&(E=null),E!==i){for(D=[],_=M();_!==i;)D.push(_),_=M();D!==i?(A=s,c=ft(c,d,b,E),s=c):(o=s,s=i)}else o=s,s=i;else o=s,s=i;else o=s,s=i;else o=s,s=i}return s}function as(){var s,c,d;return s=o,m.charCodeAt(o)===92?(c=ye,o++):(c=i,F===0&&x(ge)),c!==i?(d=q(),d!==i?(A=s,c=He(d),s=c):(o=s,s=i)):(o=s,s=i),s===i&&(m.charCodeAt(o)===46?(s=kt,o++):(s=i,F===0&&x(N)),s===i&&(xs.test(m.charAt(o))?(s=m.charAt(o),o++):(s=i,F===0&&x(Qt)))),s}function me(){var s,c,d;if(s=o,c=[],d=as(),d!==i)for(;d!==i;)c.push(d),d=as();else c=i;return c!==i&&(A=s,c=gt(c)),s=c,s}function ls(){var s,c,d;if(s=o,c=[],d=Fe(),d!==i)for(;d!==i;)c.push(d),d=Fe();else c=i;return c!==i&&(A=s,c=$s(c)),s=c,s}function Fe(){var s,c,d;return s=o,m.charCodeAt(o)===92?(c=ye,o++):(c=i,F===0&&x(ge)),c!==i?(d=q(),d!==i?(A=s,c=He(d),s=c):(o=s,s=i)):(o=s,s=i),s===i&&(m.charCodeAt(o)===46?(s=kt,o++):(s=i,F===0&&x(N)),s===i&&(qe.test(m.charAt(o))?(s=m.charAt(o),o++):(s=i,F===0&&x(pt)))),s}function Bs(){var s,c,d,b;if(s=o,m.charCodeAt(o)===34?(c=ve,o++):(c=i,F===0&&x(be)),c!==i){for(d=[],b=cs();b!==i;)d.push(b),b=cs();d!==i?(m.charCodeAt(o)===34?(b=ve,o++):(b=i,F===0&&x(be)),b!==i?(A=s,c=Bt(d),s=c):(o=s,s=i)):(o=s,s=i)}else o=s,s=i;return s}function os(){var s,c,d,b;if(s=o,m.charCodeAt(o)===47?(c=Me,o++):(c=i,F===0&&x(Ue)),c!==i){if(d=[],b=At(),b!==i)for(;b!==i;)d.push(b),b=At();else d=i;d!==i?(m.charCodeAt(o)===47?(b=Me,o++):(b=i,F===0&&x(Ue)),b!==i?(A=s,c=Is(d),s=c):(o=s,s=i)):(o=s,s=i)}else o=s,s=i;return s}function cs(){var s,c,d;return s=o,c=o,F++,m.charCodeAt(o)===34?(d=ve,o++):(d=i,F===0&&x(be)),d===i&&(m.charCodeAt(o)===92?(d=ye,o++):(d=i,F===0&&x(ge))),F--,d===i?c=void 0:(o=c,c=i),c!==i?(m.length>o?(d=m.charAt(o),o++):(d=i,F===0&&x(ke)),d!==i?(A=s,c=pe(d),s=c):(o=s,s=i)):(o=s,s=i),s===i&&(s=o,m.charCodeAt(o)===92?(c=ye,o++):(c=i,F===0&&x(ge)),c!==i?(d=q(),d!==i?(A=s,c=He(d),s=c):(o=s,s=i)):(o=s,s=i)),s}function At(){var s,c,d;return s=o,c=o,F++,m.charCodeAt(o)===47?(d=Me,o++):(d=i,F===0&&x(Ue)),d===i&&(m.charCodeAt(o)===92?(d=ye,o++):(d=i,F===0&&x(ge))),F--,d===i?c=void 0:(o=c,c=i),c!==i?(m.length>o?(d=m.charAt(o),o++):(d=i,F===0&&x(ke)),d!==i?(A=s,c=pe(d),s=c):(o=s,s=i)):(o=s,s=i),s===i&&(s=o,m.charCodeAt(o)===92?(c=ye,o++):(c=i,F===0&&x(ge)),c!==i?(d=q(),d!==i?(A=s,c=He(d),s=c):(o=s,s=i)):(o=s,s=i)),s}function q(){var s;return m.charCodeAt(o)===43?(s=Ge,o++):(s=i,F===0&&x(mt)),s===i&&(m.charCodeAt(o)===45?(s=_e,o++):(s=i,F===0&&x(ht)),s===i&&(m.charCodeAt(o)===33?(s=yt,o++):(s=i,F===0&&x(vt)),s===i&&(m.charCodeAt(o)===40?(s=J,o++):(s=i,F===0&&x(fe)),s===i&&(m.charCodeAt(o)===41?(s=z,o++):(s=i,F===0&&x(Q)),s===i&&(m.charCodeAt(o)===123?(s=L,o++):(s=i,F===0&&x(Ke)),s===i&&(m.charCodeAt(o)===125?(s=Ye,o++):(s=i,F===0&&x(Je)),s===i&&(m.charCodeAt(o)===91?(s=Qe,o++):(s=i,F===0&&x(Ae)),s===i&&(m.charCodeAt(o)===93?(s=Ze,o++):(s=i,F===0&&x(H)),s===i&&(m.charCodeAt(o)===94?(s=bt,o++):(s=i,F===0&&x(Te)),s===i&&(m.charCodeAt(o)===34?(s=ve,o++):(s=i,F===0&&x(be)),s===i&&(m.charCodeAt(o)===63?(s=Vt,o++):(s=i,F===0&&x(Wt)),s===i&&(m.charCodeAt(o)===58?(s=ws,o++):(s=i,F===0&&x(Cs)),s===i&&(m.charCodeAt(o)===92?(s=ye,o++):(s=i,F===0&&x(ge)),s===i&&(m.charCodeAt(o)===38?(s=Et,o++):(s=i,F===0&&x(jt)),s===i&&(m.charCodeAt(o)===124?(s=V,o++):(s=i,F===0&&x(zt)),s===i&&(m.charCodeAt(o)===39?(s=St,o++):(s=i,F===0&&x(Ms)),s===i&&(m.charCodeAt(o)===47?(s=Me,o++):(s=i,F===0&&x(Ue)),s===i&&(m.charCodeAt(o)===126?(s=Xe,o++):(s=i,F===0&&x(et)),s===i&&(m.charCodeAt(o)===42?(s=Ht,o++):(s=i,F===0&&x(qt)),s===i&&(m.charCodeAt(o)===32?(s=G,o++):(s=i,F===0&&x(_s)))))))))))))))))))))),s}function Tt(){var s,c,d;return s=o,m.charCodeAt(o)===126?(c=Xe,o++):(c=i,F===0&&x(et)),c!==i?(d=gs(),d!==i?(A=s,c=As(d),s=c):(o=s,s=i)):(o=s,s=i),s}function Dt(){var s,c,d;return s=o,m.charCodeAt(o)===94?(c=bt,o++):(c=i,F===0&&x(Te)),c!==i?(d=ds(),d!==i?(A=s,c=Ut(d),s=c):(o=s,s=i)):(o=s,s=i),s}function us(){var s,c,d;return s=o,m.charCodeAt(o)===126?(c=Xe,o++):(c=i,F===0&&x(et)),c!==i?(d=fs(),d===i&&(d=null),d!==i?(A=s,c=Gt(d),s=c):(o=s,s=i)):(o=s,s=i),s}function ds(){var s;return s=fs(),s===i&&(s=gs()),s}function fs(){var s,c,d,b;if(s=o,m.substr(o,2)===Ft?(c=Ft,o+=2):(c=i,F===0&&x(Ts)),c!==i){if(d=[],De.test(m.charAt(o))?(b=m.charAt(o),o++):(b=i,F===0&&x(ae)),b!==i)for(;b!==i;)d.push(b),De.test(m.charAt(o))?(b=m.charAt(o),o++):(b=i,F===0&&x(ae));else d=i;d!==i?(A=s,c=Kt(d),s=c):(o=s,s=i)}else o=s,s=i;return s}function gs(){var s,c,d;if(s=o,c=[],De.test(m.charAt(o))?(d=m.charAt(o),o++):(d=i,F===0&&x(ae)),d!==i)for(;d!==i;)c.push(d),De.test(m.charAt(o))?(d=m.charAt(o),o++):(d=i,F===0&&x(ae));else c=i;return c!==i&&(A=s,c=Ds(c)),s=c,s}function Vs(){var s,c,d,b,E,D,_,re;if(s=o,m.charCodeAt(o)===91?(c=Qe,o++):(c=i,F===0&&x(Ae)),c!==i)if(d=me(),d!==i){for(b=[],E=M();E!==i;)b.push(E),E=M();if(b!==i)if(m.substr(o,2)===ce?(E=ce,o+=2):(E=i,F===0&&x(tt)),E!==i){if(D=[],_=M(),_!==i)for(;_!==i;)D.push(_),_=M();else D=i;D!==i?(_=me(),_!==i?(m.charCodeAt(o)===93?(re=Ze,o++):(re=i,F===0&&x(H)),re!==i?(A=s,c=Ps(d,_),s=c):(o=s,s=i)):(o=s,s=i)):(o=s,s=i)}else o=s,s=i;else o=s,s=i}else o=s,s=i;else o=s,s=i;if(s===i){if(s=o,m.charCodeAt(o)===123?(c=L,o++):(c=i,F===0&&x(Ke)),c!==i)if(d=me(),d!==i){for(b=[],E=M();E!==i;)b.push(E),E=M();if(b!==i)if(m.substr(o,2)===ce?(E=ce,o+=2):(E=i,F===0&&x(tt)),E!==i){if(D=[],_=M(),_!==i)for(;_!==i;)D.push(_),_=M();else D=i;D!==i?(_=me(),_!==i?(m.charCodeAt(o)===125?(re=Ye,o++):(re=i,F===0&&x(Je)),re!==i?(A=s,c=Pe(d,_),s=c):(o=s,s=i)):(o=s,s=i)):(o=s,s=i)}else o=s,s=i;else o=s,s=i}else o=s,s=i;else o=s,s=i;if(s===i){if(s=o,m.charCodeAt(o)===91?(c=Qe,o++):(c=i,F===0&&x(Ae)),c!==i)if(d=me(),d!==i){for(b=[],E=M();E!==i;)b.push(E),E=M();if(b!==i)if(m.substr(o,2)===ce?(E=ce,o+=2):(E=i,F===0&&x(tt)),E!==i){if(D=[],_=M(),_!==i)for(;_!==i;)D.push(_),_=M();else D=i;D!==i?(_=me(),_!==i?(m.charCodeAt(o)===125?(re=Ye,o++):(re=i,F===0&&x(Je)),re!==i?(A=s,c=T(d,_),s=c):(o=s,s=i)):(o=s,s=i)):(o=s,s=i)}else o=s,s=i;else o=s,s=i}else o=s,s=i;else o=s,s=i;if(s===i)if(s=o,m.charCodeAt(o)===123?(c=L,o++):(c=i,F===0&&x(Ke)),c!==i)if(d=me(),d!==i){for(b=[],E=M();E!==i;)b.push(E),E=M();if(b!==i)if(m.substr(o,2)===ce?(E=ce,o+=2):(E=i,F===0&&x(tt)),E!==i){if(D=[],_=M(),_!==i)for(;_!==i;)D.push(_),_=M();else D=i;D!==i?(_=me(),_!==i?(m.charCodeAt(o)===93?(re=Ze,o++):(re=i,F===0&&x(H)),re!==i?(A=s,c=xt(d,_),s=c):(o=s,s=i)):(o=s,s=i)):(o=s,s=i)}else o=s,s=i;else o=s,s=i}else o=s,s=i;else o=s,s=i}}return s}function xe(){var s,c,d,b,E;for(s=o,c=[],d=M();d!==i;)c.push(d),d=M();if(c!==i)if(d=ps(),d!==i){if(b=[],E=M(),E!==i)for(;E!==i;)b.push(E),E=M();else b=i;b!==i?(A=s,c=Ee(d),s=c):(o=s,s=i)}else o=s,s=i;else o=s,s=i;if(s===i){for(s=o,c=[],d=M();d!==i;)c.push(d),d=M();c!==i?(d=ps(),d!==i?(b=ot(),b!==i?(A=s,c=Ee(d),s=c):(o=s,s=i)):(o=s,s=i)):(o=s,s=i)}return s}function ps(){var s;return m.substr(o,6)===$t?(s=$t,o+=6):(s=i,F===0&&x(Yt)),s===i&&(m.substr(o,7)===Jt?(s=Jt,o+=7):(s=i,F===0&&x(Zt)),s===i&&(m.substr(o,2)===Be?(s=Be,o+=2):(s=i,F===0&&x(le)),s===i&&(m.substr(o,3)===st?(s=st,o+=3):(s=i,F===0&&x(Os)),s===i&&(m.substr(o,3)===Xt?(s=Xt,o+=3):(s=i,F===0&&x(Rs)),s===i&&(m.substr(o,2)===es?(s=es,o+=2):(s=i,F===0&&x(rt)),s===i&&(m.substr(o,2)===Se?(s=Se,o+=2):(s=i,F===0&&x(Ns)))))))),s}function Pt(){var s,c,d;for(s=o,c=[],d=M();d!==i;)c.push(d),d=M();return c!==i?(d=Ws(),d!==i?(A=s,c=Ee(d),s=c):(o=s,s=i)):(o=s,s=i),s}function Ws(){var s;return m.charCodeAt(o)===43?(s=Ge,o++):(s=i,F===0&&x(mt)),s===i&&(m.charCodeAt(o)===45?(s=_e,o++):(s=i,F===0&&x(ht)),s===i&&(m.charCodeAt(o)===33?(s=yt,o++):(s=i,F===0&&x(vt)))),s}function M(){var s,c;if(F++,s=[],It.test(m.charAt(o))?(c=m.charAt(o),o++):(c=i,F===0&&x(ne)),c!==i)for(;c!==i;)s.push(c),It.test(m.charAt(o))?(c=m.charAt(o),o++):(c=i,F===0&&x(ne));else s=i;return F--,s===i&&(c=i,F===0&&x(Ls)),s}function ot(){var s,c;return s=o,F++,m.length>o?(c=m.charAt(o),o++):(c=i,F===0&&x(ke)),F--,c===i?s=void 0:(o=s,s=i),s}if(nt=Y(),nt!==i&&o===m.length)return nt;throw nt!==i&&o<m.length&&x(ts()),rs(wt,oe<m.length?m.charAt(oe):null,oe<m.length?Ve(oe,oe+1):Ve(oe,oe))}Ie.exports={SyntaxError:v,parse:I}},76396:Ie=>{"use strict";var W="<implicit>";Ie.exports=function v(I){if(!I)return"";var m="";return I.start!=null&&(m+=(I.parenthesized?"(":"")+I.start+" "),I.field&&I.field!==W&&(m+=I.field+":"),I.left&&(I.parenthesized&&!I.start&&(m+="("),m+=v(I.left),I.parenthesized&&!I.right&&(m+=")")),I.operator&&(I.left&&(m+=" "),I.operator!==W&&(m+=I.operator)),I.right&&(I.operator&&I.operator!==W&&(m+=" "),m+=v(I.right),I.parenthesized&&(m+=")")),(I.term||I.term===""&&I.quoted)&&(I.prefix&&(m+=I.prefix),I.quoted?(m+='"',m+=I.term,m+='"'):I.regex?(m+="/",m+=I.term,m+="/"):m+=I.term,I.proximity!=null&&(m+="~"+I.proximity),I.boost!=null&&(m+="^"+I.boost)),I.term_min&&(I.inclusive==="both"||I.inclusive==="left"?m+="[":m+="{",m+=I.term_min,m+=" TO ",m+=I.term_max,I.inclusive==="both"||I.inclusive==="right"?m+="]":m+="}"),I.similarity&&(m+="~",I.similarity!==.5&&(m+=I.similarity)),m}}}]);

//# sourceMappingURL=6087.bbc9e86d53f5803ef2bb.js.map