"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8693],{8886:(K,x,o)=>{o.r(x),o.d(x,{plugin:()=>De});var f=o(51023),n=o(31733),L=o(85498),C=o(69671),v=o(5279),R=o(74881);const w=e=>{const{options:t,onOptionsChange:a}=e;return n.createElement(n.Fragment,null,n.createElement(C.E,{defaultUrl:"http://localhost:4040",dataSourceConfig:t,showAccessOptions:!1,onChange:a,secureSocksDSProxyEnabled:L.config.secureSocksDSProxyEnabled}),n.createElement("h3",{className:"page-heading"},"Querying"),n.createElement("div",{className:"gf-form-group"},n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(v.LegacyForms.FormField,{label:"Minimal step",labelWidth:13,inputEl:n.createElement(v.LegacyForms.Input,{className:"width-6",value:t.jsonData.minStep,spellCheck:!1,placeholder:"15s",onChange:s=>{a({...t,jsonData:{...t.jsonData,minStep:s.currentTarget.value}})},validationEvents:{[R.JU.onBlur]:[(0,R.FE)(/^$|^\d+(ms|[Mwdhmsy])$/,"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s")]}}),tooltip:"Minimal step used for metric query. Should be the same or higher as the scrape interval setting in the Pyroscope database."})))))};var W=o(89162),F=o.n(W),U=o(69781),z=o(61375),M=o(87580),p=o(76932),y=o(76067);function c(e){const t=(0,y.wW)(P,e);return n.createElement("div",{className:t.root},e.children)}const P=(e,t)=>({root:(0,p.css)({display:"flex",flexDirection:t.direction??"row",flexWrap:t.wrap??!0?"wrap":void 0,alignItems:t.alignItems,gap:e.spacing(t.gap??2),flexGrow:t.flexGrow})}),S=({children:e,stackProps:t})=>{const a=(0,y.wW)(T);return n.createElement("div",{className:a.root},n.createElement(c,{gap:2,...t},e))},T=e=>({root:(0,p.css)({padding:e.spacing(1),backgroundColor:e.colors.background.secondary,borderRadius:e.shape.radius.default})}),D=({children:e})=>n.createElement(c,{gap:.5,direction:"column"},e);var $=o(80004),h=o(59326),Q=o(73642);const k={id:"pyroscopeql",extensions:[".pyroscopeql"],aliases:["pyroscope","pyroscopeql"],mimetypes:[],def:{language:{ignoreCase:!1,defaultToken:"",tokenPostfix:".pyroscopeql",keywords:[],operators:[],symbols:/[=><!~?:&|+\-*\/^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,hexdigits:/[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,integersuffix:/(ll|LL|u|U|l|L)?(ll|LL|u|U|l|L)?/,floatsuffix:/[fFlL]?/,tokenizer:{root:[[/[a-z_]\w*(?=\s*(=|!=|=~|!~))/,"tag"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],{include:"@whitespace"},[/[{}()\[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/@symbols/,{cases:{"@operators":"delimiter","@default":""}}],[/\d+/,"number"],[/\d*\d+[eE]([\-+]?\d+)?(@floatsuffix)/,"number.float"],[/\d*\.\d+([eE][\-+]?\d+)?(@floatsuffix)/,"number.float"],[/0[xX][0-9a-fA-F']*[0-9a-fA-F](@integersuffix)/,"number.hex"],[/0[0-7']*[0-7](@integersuffix)/,"number.octal"],[/0[bB][0-1']*[0-1](@integersuffix)/,"number.binary"],[/\d[\d']*\d(@integersuffix)/,"number"],[/\d(@integersuffix)/,"number"]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]],clauses:[[/[^(,)]/,"tag"],[/\)/,"identifier","@pop"]],whitespace:[[/[ \t\r\n]+/,"white"]]}},languageConfiguration:{wordPattern:/(-?\d*\.\d\w*)|([^`~!#%^&*()=+\[{\]}\\|;:'",<>\/?\s]+)/g,brackets:[["{","}"]],autoClosingPairs:[{open:"{",close:"}"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:'"',close:'"'},{open:"'",close:"'"}],folding:{}}}};class _{constructor(){this.triggerCharacters=["{",",","[","(","=","~"," ",'"'],this.labels=[],this.getLabelValues=()=>Promise.resolve([])}init(t,a){this.labels=t,this.getLabelValues=a}provideCompletionItems(t,a){if(!(this.monaco&&this.editor))throw new Error("provideCompletionItems called before CompletionProvider was initialized");if(this.editor.getModel()?.id!==t.id)return{suggestions:[]};const{range:s,offset:l}=oe(this.monaco,t,a),i=ae(t.getValue(),l);return this.getCompletions(i).then(u=>{const g=u.length.toString().length;return{suggestions:u.map((d,m)=>({kind:q(d.type,this.monaco),label:d.label,insertText:d.insertText,sortText:m.toString().padStart(g,"0"),range:s}))}})}async getCompletions(t){switch(t.type){case"UNKNOWN":return[];case"EMPTY":return this.labels.map(s=>({label:s,insertText:`{${s}="`,type:"LABEL_NAME"}));case"IN_LABEL_NAME":return this.labels.map(s=>({label:s,insertText:s,type:"LABEL_NAME"}));case"IN_LABEL_VALUE":let a=await this.getLabelValues(t.labelName);return a?a.map(s=>({label:s,insertText:t.betweenQuotes?s:`"${s}"`,type:"LABEL_VALUE"})):[];default:throw new Error(`Unexpected situation ${t}`)}}}function q(e,t){switch(e){case"LABEL_NAME":return t.languages.CompletionItemKind.Enum;case"LABEL_VALUE":return t.languages.CompletionItemKind.EnumMember;default:throw new Error(`Unexpected CompletionType: ${e}`)}}const j=/[a-zA-Z_][a-zA-Z0-9_]*/,G=/[^"]*/,ee=new RegExp(`(${j.source})="(${G.source})"`,"g"),te=new RegExp(`(${j.source})=("?)${G.source}$`),ne=new RegExp(/[{,]\s*[a-zA-Z0-9_]*$/);function ae(e,t){if(e==="")return{type:"EMPTY"};const a=e.matchAll(ee),s=Array.from(a).reduce((u,g)=>{const[r,d,m]=g[1];return u.push({name:d,value:m}),u},[]),l=e.substring(0,t).match(te);return l?{type:"IN_LABEL_VALUE",labelName:l[1],betweenQuotes:!!l[2],otherLabels:s}:e.substring(0,t).match(ne)?{type:"IN_LABEL_NAME",otherLabels:s}:{type:"UNKNOWN"}}function oe(e,t,a){const s=t.getWordAtPosition(a),l=s!=null?e.Range.lift({startLineNumber:a.lineNumber,endLineNumber:a.lineNumber,startColumn:s.startColumn,endColumn:s.endColumn}):e.Range.fromPositions(a),i={column:a.column,lineNumber:a.lineNumber};return{offset:t.getOffsetAt(i),range:l}}function se(e){const t=re(e.getLabelValues,e.labels),a=(0,y.wW)(ce),s=(0,$.Z)(e.onRunQuery),l=(0,n.useRef)(null);return n.createElement("div",{className:a.wrapper,ref:l},n.createElement(Q.p,{value:e.value,language:I,onChange:e.onChange,containerStyles:a.queryField,monacoOptions:{folding:!1,fontSize:14,lineNumbers:"off",overviewRulerLanes:0,renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0},scrollBeyondLastLine:!1,wordWrap:"on",padding:{top:4,bottom:5}},onBeforeEditorMount:ie,onEditorDidMount:(i,u)=>{t(i,u);const g=()=>{const r=l.current;if(r!==null){const d=i.getContentHeight();r.style.height=`${d+le}px`,r.style.width="100%";const m=r.clientWidth;i.layout({width:m,height:d})}};i.onDidContentSizeChange(g),g(),i.addCommand(u.KeyMod.Shift|u.KeyCode.Enter,()=>{s.current(i.getValue())})}}))}const le=2;function re(e,t){const a=(0,n.useRef)();a.current===void 0&&(a.current=new _),(0,h.Z)(async()=>{a.current&&a.current.init(t||[],e)},[t,e]);const s=(0,n.useRef)(null);return(0,n.useEffect)(()=>()=>{s.current?.()},[]),(l,i)=>{if(a.current){a.current.editor=l,a.current.monaco=i;const{dispose:u}=i.languages.registerCompletionItemProvider(I,a.current);s.current=u}}}let Z=!1;const I="pyroscopeql";function ie(e){if(Z===!1){Z=!0;const{aliases:t,extensions:a,mimetypes:s,def:l}=k;e.languages.register({id:I,aliases:t,extensions:a,mimetypes:s}),e.languages.setMonarchTokensProvider(I,l.language),e.languages.setLanguageConfiguration(I,l.languageConfiguration)}}const ce=()=>({queryField:(0,p.css)`
      label: LabelsEditorQueryField;
      flex: 1;
      // Not exactly sure but without this the editor does not shrink after resizing (so you can make it bigger but not
      // smaller). At the same time this does not actually make the editor 100px because it has flex 1 so I assume
      // this should sort of act as a flex-basis (but flex-basis does not work for this). So yeah CSS magic.
      width: 100px;
    `,wrapper:(0,p.css)`
      label: LabelsEditorWrapper;
      display: flex;
      flex: 1;
      border: 1px solid rgba(36, 41, 46, 0.3);
      border-radius: 2px;
    `});var H=o(90540),ue=o(69391),ge=o(33500),de=o(51343);const pe="plugins/grafana-pyroscope-datasource/query-links",A={};function we(){Object.keys(A).forEach(e=>delete A[e])}function fe(e){const{datasource:{uid:t},query:a,range:s}=e,{value:l}=(0,h.Z)(async()=>{if(A[t])return A[t];const r=await(0,ue.i)().get(`/api/datasources/uid/${t}`);return A[t]=r,r},[t]),i={datasourceUid:t,query:a,range:s,datasourceSettings:l},{extensions:u}=(0,ge.dj)({extensionPointId:pe,context:i}),g=(0,y.wW)(me);return u.length===0?null:n.createElement(n.Fragment,null,u.map(r=>n.createElement(de.Qj,{className:g.linkButton,key:`${r.id}`,variant:"secondary",icon:r.icon||"external-link-alt",tooltip:r.description,target:"_blank",href:r.path,onClick:r.onClick},r.title)))}function me(e){return{linkButton:(0,p.css)({marginLeft:e.spacing(1)})}}var Ee=o(44343),he=o(96856),ye=o(38834),J=o(64516),be=o(46675),ve=o(67978),xe=o(58037),Le=o(49311),Ce=o(85765);const B=e=>{const{label:t,optional:a,tooltip:s,children:l,width:i,...u}=e,g=(0,y.wW)(Se,i),r=u?.htmlFor||ve?.getChildId(l),d=n.createElement(n.Fragment,null,n.createElement("label",{className:g.label,htmlFor:r},t,a&&n.createElement("span",{className:g.optional}," - optional"),s&&n.createElement(xe.u,{placement:"top",content:s,theme:"info"},n.createElement(Le.J,{name:"info-circle",size:"sm",className:g.icon}))),n.createElement("span",{className:g.space}));return n.createElement("div",{className:g.root},n.createElement(Ce.g,{className:g.field,label:d,...u},l))},Se=(e,t)=>({space:(0,p.css)({paddingRight:e.spacing(0),paddingBottom:e.spacing(.5)}),root:(0,p.css)({minWidth:e.spacing(t??0)}),label:(0,p.css)({fontSize:12,fontWeight:e.typography.fontWeightMedium}),optional:(0,p.css)({fontStyle:"italic",color:e.colors.text.secondary}),field:(0,p.css)({marginBottom:0}),icon:(0,p.css)({color:e.colors.text.secondary,marginLeft:e.spacing(1),":hover":{color:e.colors.text.primary}})}),X=[{value:"metrics",label:"Metric",description:"Return aggregated metrics"},{value:"profile",label:"Profile",description:"Return profile"},{value:"both",label:"Both",description:"Return both metric and profile data"}];function Ne(e){return e===Ee.zj.Explore?X:X.filter(t=>t.value!=="both")}function Pe({query:e,onQueryChange:t,app:a,labels:s}){const l=(0,y.wW)(Te),i=Ne(a),u=s?s.map(r=>({label:r,value:r})):[];let g=[`Type: ${e.queryType}`];return e.groupBy?.length&&g.push(`Group by: ${e.groupBy.join(", ")}`),e.maxNodes&&g.push(`Max nodes: ${e.maxNodes}`),n.createElement(c,{gap:0,direction:"column"},n.createElement(be.d,{title:"Options",collapsedInfo:g},n.createElement("div",{className:l.body},n.createElement(B,{label:"Query Type"},n.createElement(he.S,{options:i,value:e.queryType,onChange:r=>t({...e,queryType:r})})),n.createElement(B,{label:"Group by",tooltip:n.createElement(n.Fragment,null,"Used to group the metric result by a specific label or set of labels. Does not apply to profile query.")},n.createElement(ye.NU,{placeholder:"Label",value:e.groupBy,allowCustomValue:!0,options:u,onChange:r=>{const d=r.map(m=>m.value);t({...e,groupBy:d})}})),L.config.featureToggles.traceToProfiles&&n.createElement(B,{label:"Span ID",tooltip:n.createElement(n.Fragment,null,"Sets the span ID from which to search for profiles.")},n.createElement(J.I,{value:e.spanSelector||[""],type:"string",placeholder:"64f170a95f537095",onChange:r=>{t({...e,spanSelector:r.currentTarget.value!==""?[r.currentTarget.value]:[]})}})),n.createElement(B,{label:"Max Nodes",tooltip:n.createElement(n.Fragment,null,"Sets the maximum number of nodes to return in the flamegraph.")},n.createElement(J.I,{value:e.maxNodes||"",type:"number",placeholder:"16384",onChange:r=>{let d=parseInt(r.currentTarget.value,10);d=isNaN(d)?0:d,t({...e,maxNodes:d})}})))))}const Te=e=>({switchLabel:(0,p.css)({color:e.colors.text.secondary,cursor:"pointer",fontSize:e.typography.bodySmall.fontSize,"&:hover":{color:e.colors.text.primary}}),body:(0,p.css)({display:"flex",paddingTop:e.spacing(2),gap:e.spacing(2),flexWrap:"wrap"})}),Ie=/(\w+)\s*=\s*("[^,"]+")/g;function Ae(e){const{onChange:t,onRunQuery:a,datasource:s,query:l,range:i,app:u}=e;function g(O){t({...l,labelSelector:O}),a()}const r=(0,H.E)(s,i),{labels:d,getLabelValues:m,onLabelSelectorChange:E}=Me(i,s,l,t);Oe(l,r,t,u);let b=n.createElement(z.u,{text:"Loading"});return r&&l.profileTypeId!==void 0&&(b=n.createElement(H.o,{placeholder:r.length===0?"No profile types found":"Select profile type",profileTypes:r,initialProfileTypeId:l.profileTypeId,onChange:O=>{t({...l,profileTypeId:O})}})),n.createElement(D,null,n.createElement(S,{stackProps:{wrap:!1,gap:1}},b,n.createElement(se,{value:l.labelSelector,onChange:E,onRunQuery:g,labels:d,getLabelValues:m}),n.createElement(fe,{...e})),n.createElement(S,null,n.createElement(Pe,{query:l,onQueryChange:e.onChange,app:e.app,labels:d})))}function Oe(e,t,a,s){(0,n.useEffect)(()=>{if(!t)return;const l=(0,M.Up)(e,s);e.profileTypeId||(l.profileTypeId=Re(t)),F()(e,l)||a(l)},[s,e,t,a])}function Re(e){const t=e.filter(a=>a.id.indexOf("cpu")>=0);if(t.length){const a=t.find(s=>s.id.indexOf("samples")===-1);return a?a.id:t[0].id}return e[0]?.id||""}function Me(e,t,a,s){const l={to:Math.ceil((e?.to.valueOf()||0)/1e4)*1e4,from:Math.floor((e?.from.valueOf()||0)/1e4)*1e4},i=(E,b,O)=>{let Y=[`__profile_type__="${b}"`],N;for(;(N=Ie.exec(E))!==null;)if(N[1]&&N[2]){if(N[1]===O)continue;Y.push(`${N[1]}=${N[2]}`)}return`{${Y.join(",")}}`},[u,g]=(0,n.useState)(()=>[""]);(0,n.useEffect)(()=>{(async()=>{const b=await t.getLabelNames(i(a.labelSelector,a.profileTypeId,""),l.from,l.to);g(b)})()},[a,l.from,l.to,t,g]);const r=(0,n.useCallback)(E=>{let b=i(a.labelSelector,a.profileTypeId,E);return t.getLabelValues(b,E,l.from,l.to)},[t,a.labelSelector,a.profileTypeId,l.to,l.from]),d=(0,U.debounce)(E=>{s&&s({...a,labelSelector:E})},200),m=(0,n.useCallback)(E=>{d(E)},[d]);return{labels:u,getLabelValues:r,onLabelSelectorChange:m}}const De=new f.hf(M.tF).setConfigEditor(w).setQueryEditor(Ae)},46675:(K,x,o)=>{o.d(x,{d:()=>z});var f=o(76932),n=o(31733),L=o(83870),C=o(86850),v=o(85498),R=o(76067),w=o(27218),W=o(37739),F=o(58037),U=o(49311);function z({title:c,children:P,collapsedInfo:S,queryStats:T}){const[D,$]=(0,L.Z)(!1),h=(0,R.wW)(M);return n.createElement("div",{className:h.wrapper},n.createElement(w.U,{className:h.collapse,collapsible:!0,isOpen:D,onToggle:$,label:n.createElement(W.K,{gap:0},n.createElement("h6",{className:h.title},c),!D&&n.createElement("div",{className:h.description},S.map((Q,V)=>n.createElement("span",{key:V},Q))))},n.createElement("div",{className:h.body},P)),T&&v.config.featureToggles.lokiQuerySplitting&&n.createElement(F.u,{content:"Note: the query will be split into multiple parts and executed in sequence. Query limits will only apply each individual part."},n.createElement(U.J,{tabIndex:0,name:"info-circle",className:h.tooltip,size:"sm"})),T&&n.createElement("p",{className:h.stats},p(T)))}const M=c=>({collapse:(0,f.css)({backgroundColor:"unset",border:"unset",marginBottom:0,["> button"]:{padding:c.spacing(0,1)}}),wrapper:(0,f.css)({width:"100%",display:"flex",justifyContent:"space-between",alignItems:"baseline"}),title:(0,f.css)({flexGrow:1,overflow:"hidden",fontSize:c.typography.bodySmall.fontSize,fontWeight:c.typography.fontWeightMedium,margin:0}),description:(0,f.css)({color:c.colors.text.secondary,fontSize:c.typography.bodySmall.fontSize,fontWeight:c.typography.bodySmall.fontWeight,paddingLeft:c.spacing(2),gap:c.spacing(2),display:"flex"}),body:(0,f.css)({display:"flex",gap:c.spacing(2),flexWrap:"wrap"}),stats:(0,f.css)({margin:"0px",color:c.colors.text.secondary,fontSize:c.typography.bodySmall.fontSize}),tooltip:(0,f.css)({marginRight:c.spacing(.25)})}),p=c=>c.message?c.message:`This query will process approximately ${y(c)}.`,y=c=>{const{text:P,suffix:S}=(0,C.Cf)("bytes")(c.bytes,1);return P+S}},80004:(K,x,o)=>{o.d(x,{Z:()=>L});var f=o(31733),n=function(C){var v=(0,f.useRef)(C);return v.current=C,v};const L=n}}]);

//# sourceMappingURL=pyroscopePlugin.dad7880c55ea631672e3.js.map