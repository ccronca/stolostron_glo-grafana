"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3168],{62126:(Be,q,u)=>{u.r(q),u.d(q,{plugin:()=>Pe});var _=u(51023),t=u(31733),ie=u(85498),ce=u(69671),me=u(97216),j=u(85765),V=u(38834),L=u(64516);const $=[{label:"<=2.1",value:1},{label:"==2.2",value:2},{label:"==2.3",value:3}],J=[{label:"second",value:1},{label:"millisecond",value:2}],ue=s=>{const{onChange:e,value:a}=s,r=(0,t.useId)();return t.createElement(t.Fragment,null,t.createElement(me.C,{label:"OpenTSDB settings"},t.createElement(j.g,{htmlFor:`select-version-${r}`,label:"Version"},t.createElement(V.Ph,{inputId:`select-version-${r}`,options:$,value:$.find(l=>l.value===a.jsonData.tsdbVersion)??$[0],onChange:ee("tsdbVersion",a,e),width:20})),t.createElement(j.g,{htmlFor:`select-resolution-${r}`,label:"Resolution"},t.createElement(V.Ph,{inputId:`select-resolution-${r}`,options:J,value:J.find(l=>l.value===a.jsonData.tsdbResolution)??J[0],onChange:ee("tsdbResolution",a,e),width:20})),t.createElement(j.g,{htmlFor:`lookup-input-${r}`,label:"Lookup limit"},t.createElement(L.I,{id:`lookup-input-${r}`,type:"number",value:a.jsonData.lookupLimit??1e3,onChange:ge("lookupLimit",a,e),width:20}))))},ee=(s,e,a)=>r=>{a({...e,jsonData:{...e.jsonData,[s]:r.value}})},ge=(s,e,a)=>r=>{a({...e,jsonData:{...e.jsonData,[s]:r.currentTarget.value}})},pe=s=>{const{options:e,onOptionsChange:a}=s;return t.createElement(t.Fragment,null,t.createElement(ce.E,{defaultUrl:"http://localhost:4242",dataSourceConfig:e,onChange:a,secureSocksDSProxyEnabled:ie.config.secureSocksDSProxyEnabled}),t.createElement(ue,{value:e,onChange:a}))};var te=u(76932),ae=u(98827),G=u(76067),d=u(37739),T=u(84275),v=u(71918),I=u(20888),R=u(76772);function de({query:s,onChange:e,onRunQuery:a,aggregators:r,fillPolicies:l,tsdbVersion:c}){const i=r.map(o=>(0,T.E)(o)),n=l.map(o=>(0,T.E)(o));return t.createElement(d.K,{gap:.5,alignItems:"flex-start","data-testid":se.section},t.createElement(d.K,{gap:0},t.createElement(v.c,{className:"query-keyword",width:8,tooltip:t.createElement("div",null,"Leave interval blank for auto or for example use ",t.createElement("code",null,"1m"))},"Down sample"),t.createElement(L.I,{width:25,"data-testid":se.interval,placeholder:"interval",value:s.downsampleInterval??"",onChange:o=>{const m=o.currentTarget.value;e({...s,downsampleInterval:m})},onBlur:()=>a()})),t.createElement(d.K,{gap:0},t.createElement(v.c,{width:"auto",className:"query-keyword"},"Aggregator"),t.createElement(V.Ph,{value:s.downsampleAggregator?(0,T.E)(s.downsampleAggregator):void 0,options:i,onChange:({value:o})=>{o&&(e({...s,downsampleAggregator:o}),a())}})),c>=2&&t.createElement(d.K,{gap:0,alignItems:"flex-start"},t.createElement(I.W,{className:"width-6 query-keyword"},"Fill"),t.createElement(V.Ph,{inputId:"opentsdb-fillpolicy-select",value:s.downsampleFillPolicy?(0,T.E)(s.downsampleFillPolicy):void 0,options:n,onChange:({value:o})=>{o&&(e({...s,downsampleFillPolicy:o}),a())}})),t.createElement(d.K,{gap:0},t.createElement(v.c,{className:"query-keyword"},"Disable downsampling"),t.createElement(R.x,{value:s.disableDownsampling??!1,onChange:()=>{const o=s.disableDownsampling??!1;e({...s,disableDownsampling:!o}),a()}})),t.createElement(d.K,{gap:0,grow:1},t.createElement(I.W,null," ")))}const se={section:"opentsdb-downsample",interval:"downsample-interval"};var he=u(8806),z=u.n(he),g=u(69781),re=u(51343),k=u(49311);function fe({query:s,onChange:e,onRunQuery:a,suggestTagKeys:r,filterTypes:l,suggestTagValues:c}){const i=(0,G.wW)(re.gN),[n,o]=(0,t.useState)(),[m,E]=(0,t.useState)(),[f,S]=(0,t.useState)(!1),[y,w]=(0,t.useState)("iliteral_or"),[K,O]=(0,t.useState)(""),[b,M]=(0,t.useState)(""),[A,x]=(0,t.useState)(!1),[U,X]=(0,t.useState)(""),Y=l.map(p=>(0,T.E)(p));function h(){S(!f)}function N(){if(s.tags&&(0,g.size)(s.tags)>0){X("Please remove tags to use filters, tags and filters are mutually exclusive.");return}if(!f){S(!0);return}const p={type:y,tagk:K,filter:b,groupBy:A};s.filters=s.filters?s.filters.concat([p]):[p],w("literal_or"),O(""),M(""),x(!1),e(s),a(),h()}function D(p){s.filters?.splice(p,1),e(s),a()}function Ae(p,F){D(F),O(p.tagk),M(p.filter),w(p.type),x(p.groupBy),N()}const Ne=" ",Me=(0,t.useCallback)((p,F)=>{const Z=p.value??"";return F.split(Ne).reduce((Le,Re)=>Le&&Z.toLowerCase().includes(Re.toLowerCase()),!0)},[]),De=z()(p=>c(p),350);return t.createElement(d.K,{gap:0,"data-testid":W.section},t.createElement(v.c,{className:"query-keyword",width:8,tooltip:t.createElement("div",null,"Filters does not work with tags, either of the two will work but not both.")},"Filters"),s.filters&&s.filters.map((p,F)=>t.createElement(v.c,{key:F,width:"auto","data-testid":W.list+F},p.tagk," = ",p.type,"(",p.filter,"), groupBy = ",""+p.groupBy,t.createElement("button",{type:"button",className:i,onClick:()=>Ae(p,F)},t.createElement(k.J,{name:"pen"})),t.createElement("button",{type:"button",className:i,onClick:()=>D(F),"data-testid":W.remove},t.createElement(k.J,{name:"times"})))),!f&&t.createElement(v.c,{width:2},t.createElement("button",{type:"button",className:i,onClick:h,"aria-label":"Add filter"},t.createElement(k.J,{name:"plus"}))),f&&t.createElement(d.K,{gap:.5,alignItems:"center"},t.createElement(d.K,{gap:0},t.createElement(V.Ph,{inputId:"opentsdb-suggested-tagk-select",value:K?(0,T.E)(K):void 0,placeholder:"key",allowCustomValue:!0,filterOption:Me,onOpenMenu:async()=>{E(!0);const F=(await r(s)).map(Z=>(0,T.E)(Z));o(F),E(!1)},isLoading:m,options:n,onChange:({value:p})=>{p&&O(p)}})),t.createElement(d.K,{gap:0},t.createElement(I.W,{className:"width-4 query-keyword"},"Type"),t.createElement(V.Ph,{inputId:"opentsdb-aggregator-select",value:y?(0,T.E)(y):void 0,options:Y,onChange:({value:p})=>{p&&w(p)}})),t.createElement(d.K,{gap:0},t.createElement(V.qb,{inputId:"opentsdb-suggested-tagv-select",value:b?(0,T.E)(b):void 0,placeholder:"filter",allowCustomValue:!0,loadOptions:De,defaultOptions:[],onChange:({value:p})=>{p&&M(p)}})),t.createElement(v.c,{width:5,className:"query-keyword"},"Group by"),t.createElement(R.x,{value:A,onChange:()=>{x(!A)}}),t.createElement(d.K,{gap:0},U&&t.createElement(I.W,{title:U,"data-testid":W.error},t.createElement(k.J,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"})),t.createElement(v.c,{width:5.5},t.createElement("button",{type:"button",className:i,onClick:N},"add filter"),t.createElement("button",{type:"button",className:i,onClick:h},t.createElement(k.J,{name:"times"}))))),t.createElement(d.K,{gap:0,grow:1},t.createElement(I.W,null," ")))}const W={section:"opentsdb-filter",list:"opentsdb-filter-list",error:"opentsdb-filter-error",remove:"opentsdb-filter-remove"};function Ee({query:s,onChange:e,onRunQuery:a,suggestMetrics:r,aggregators:l}){const c=l.map(n=>(0,T.E)(n)),i=z()(n=>r(n),350);return t.createElement(d.K,{gap:.5,alignItems:"flex-start","data-testid":ne.section},t.createElement(d.K,{gap:0},t.createElement(v.c,{width:8,className:"query-keyword"},"Metric"),t.createElement(V.qb,{width:25,inputId:"opentsdb-metric-select",value:s.metric?(0,T.E)(s.metric):void 0,placeholder:"Metric name",allowCustomValue:!0,loadOptions:i,defaultOptions:[],onChange:({value:n})=>{n&&(e({...s,metric:n}),a())}})),t.createElement(d.K,{gap:0,alignItems:"flex-start"},t.createElement(v.c,{width:"auto",className:"query-keyword"},"Aggregator"),t.createElement(V.Ph,{inputId:"opentsdb-aggregator-select",value:s.aggregator?(0,T.E)(s.aggregator):void 0,options:c,onChange:({value:n})=>{n&&(e({...s,aggregator:n}),a())}})),t.createElement(d.K,{gap:0},t.createElement(v.c,{className:"query-keyword",width:6,tooltip:t.createElement("div",null,"Use patterns like $tag_tagname to replace part of the alias for a tag value")},"Alias"),t.createElement(L.I,{"data-testid":ne.alias,placeholder:"series alias",value:s.alias??"",onChange:n=>{const o=n.currentTarget.value;e({...s,alias:o})},onBlur:()=>a()})),t.createElement(d.K,{gap:0,grow:1},t.createElement(I.W,null," ")))}const ne={section:"opentsdb-metricsection",alias:"metric-alias"};function ve({query:s,onChange:e,onRunQuery:a,tsdbVersion:r}){return t.createElement(d.K,{gap:0,"data-testid":B.section},t.createElement(v.c,{className:"query-keyword",width:8},"Rate"),t.createElement(R.x,{"data-testid":B.shouldComputeRate,value:s.shouldComputeRate??!1,onChange:()=>{const l=s.shouldComputeRate??!1;e({...s,shouldComputeRate:!l}),a()}}),s.shouldComputeRate&&t.createElement(t.Fragment,null,t.createElement(v.c,{className:"query-keyword",width:"auto"},"Counter"),t.createElement(R.x,{"data-testid":B.isCounter,value:s.isCounter??!1,onChange:()=>{const l=s.isCounter??!1;e({...s,isCounter:!l}),a()}})),s.shouldComputeRate&&s.isCounter&&t.createElement(d.K,{gap:0},t.createElement(I.W,{width:"auto",className:"query-keyword"},"Counter max"),t.createElement(L.I,{"data-testid":B.counterMax,placeholder:"max value",value:s.counterMax??"",onChange:l=>{const c=l.currentTarget.value;e({...s,counterMax:c})},onBlur:()=>a()}),t.createElement(I.W,{width:"auto",className:"query-keyword"},"Reset value"),t.createElement(L.I,{"data-testid":B.counterResetValue,placeholder:"reset value",value:s.counterResetValue??"",onChange:l=>{const c=l.currentTarget.value;e({...s,counterResetValue:c})},onBlur:()=>a()})),r>2&&t.createElement(t.Fragment,null,t.createElement(v.c,{className:"query-keyword",width:"auto"},"Explicit tags"),t.createElement(R.x,{"data-testid":B.explicitTags,value:s.explicitTags??!1,onChange:()=>{const l=s.explicitTags??!1;e({...s,explicitTags:!l}),a()}})),t.createElement(d.K,{gap:0,grow:1},t.createElement(I.W,null," ")))}const B={section:"opentsdb-rate",shouldComputeRate:"opentsdb-shouldComputeRate",isCounter:"opentsdb-is-counter",counterMax:"opentsdb-counter-max",counterResetValue:"opentsdb-counter-reset-value",explicitTags:"opentsdb-explicit-tags"};function be({query:s,onChange:e,onRunQuery:a,suggestTagKeys:r,suggestTagValues:l,tsdbVersion:c}){const i=(0,G.wW)(re.gN),[n,o]=(0,t.useState)(),[m,E]=(0,t.useState)(),[f,S]=(0,t.useState)(!1),[y,w]=(0,t.useState)(""),[K,O]=(0,t.useState)(""),[b,M]=(0,t.useState)("");function A(){S(!f)}function x(){if(s.filters&&(0,g.size)(s.filters)>0){M("Please remove filters to use tags, tags and filters are mutually exclusive.");return}if(!f){S(!0);return}if(s.tags&&(0,g.has)(s.tags,y)){const h="Duplicate tag key '"+y+"'.";M(h);return}s.tags||(s.tags={}),s.tags[y]=K,w(""),O(""),e(s),a(),A()}function U(h){delete s.tags[h],e(s),a()}function X(h,N){U(h),w(h),O(N),x()}const Y=z()(h=>l(h),350);return t.createElement(d.K,{gap:0,"data-testid":Q.section},t.createElement(v.c,{className:"query-keyword",width:8,tooltip:c>=2?t.createElement("div",null,"Please use filters, tags are deprecated in opentsdb 2.2"):void 0},"Tags"),s.tags&&Object.keys(s.tags).map((h,N)=>{const D=s.tags[h];return t.createElement(v.c,{key:N,width:"auto","data-testid":Q.list+N},h,"=",D,t.createElement("button",{type:"button",className:i,onClick:()=>X(h,D)},t.createElement(k.J,{name:"pen"})),t.createElement("button",{type:"button",className:i,onClick:()=>U(h),"data-testid":Q.remove},t.createElement(k.J,{name:"times"})))}),!f&&t.createElement(v.c,{width:2},t.createElement("button",{type:"button",className:i,onClick:A,"aria-label":"Add tag"},t.createElement(k.J,{name:"plus"}))),f&&t.createElement(d.K,{gap:.5,alignItems:"center"},t.createElement(d.K,{gap:0},t.createElement(V.Ph,{inputId:"opentsdb-suggested-tagk-select",value:y?(0,T.E)(""+y):void 0,placeholder:"key",allowCustomValue:!0,onOpenMenu:async()=>{E(!0);const N=(await r(s)).map(D=>(0,T.E)(D));o(N),E(!1)},isLoading:m,options:n,onChange:({value:h})=>{h&&w(h)}})),t.createElement(d.K,{gap:0},t.createElement(V.qb,{inputId:"opentsdb-suggested-tagv-select",value:K?(0,T.E)(K):void 0,placeholder:"value",allowCustomValue:!0,loadOptions:Y,defaultOptions:[],onChange:({value:h})=>{h&&O(h)}})),t.createElement(d.K,{gap:0},b&&t.createElement(I.W,{title:b,"data-testid":Q.error},t.createElement(k.J,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"})),t.createElement(v.c,{width:5.5},t.createElement("button",{type:"button",className:i,onClick:x},"add tag"),t.createElement("button",{type:"button",className:i,onClick:A},t.createElement(k.J,{name:"times"}))))),t.createElement(d.K,{gap:0,grow:1},t.createElement(I.W,null," ")))}const Q={section:"opentsdb-tag",list:"opentsdb-tag-list",error:"opentsdb-tag-error",remove:"opentsdb-tag-remove"};function Te({datasource:s,onRunQuery:e,onChange:a,query:r,range:l,queries:c}){const i=(0,G.wW)(ye),[n,o]=(0,t.useState)(["avg","sum","min","max","dev","zimsum","mimmin","mimmax"]),m=["none","nan","null","zero"],[E,f]=(0,t.useState)(["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"]),S=s.tsdbVersion;r.aggregator||(r.aggregator="sum"),r.downsampleAggregator||(r.downsampleAggregator="avg"),r.downsampleFillPolicy||(r.downsampleFillPolicy="none"),(0,t.useEffect)(()=>{s.getAggregators().then(b=>{b.length!==0&&o(b)})},[s]),(0,t.useEffect)(()=>{s.getFilterTypes().then(b=>{b.length!==0&&f(b)})},[s]);async function y(b){return s.metricFindQuery(`metrics(${b})`).then(O)}async function w(b){return s.metricFindQuery(`suggest_tagv(${b})`).then(O)}async function K(b){return s.suggestTagKeys(b)}function O(b){const M=s.getVariables().map(x=>({value:ae.QX.escapeHtml(x),description:x})),A=b.map(x=>({value:ae.QX.escapeHtml(x.text),description:x.text}));return M.concat(A)}return t.createElement("div",{className:i.container,"data-testid":we.editor},t.createElement(d.K,{gap:.5,direction:"column",grow:1},t.createElement(Ee,{query:r,onChange:a,onRunQuery:e,suggestMetrics:y,aggregators:n}),t.createElement(de,{query:r,onChange:a,onRunQuery:e,aggregators:n,fillPolicies:m,tsdbVersion:S}),S>=2&&t.createElement(fe,{query:r,onChange:a,onRunQuery:e,filterTypes:E,suggestTagValues:w,suggestTagKeys:K}),t.createElement(be,{query:r,onChange:a,onRunQuery:e,suggestTagValues:w,suggestTagKeys:K,tsdbVersion:S}),t.createElement(ve,{query:r,onChange:a,onRunQuery:e,tsdbVersion:S})))}function ye(s){return{container:(0,te.css)`
      display: flex;
    `,toggleButton:(0,te.css)`
      margin-left: ${s.spacing(.5)};
    `}}const we={editor:"opentsdb-editor"};var Ce=u(71156),Se=u(26722),H=u(86457),P=u(71892),Ke=u(56183),C=u(4558),le=u(98147),xe=u(89026),oe=u(69391),Ve=u(4419);const Ie=s=>{const{query:e,onChange:a}=s,[r,l]=(0,t.useState)(e.target??""),[c,i]=(0,t.useState)(e.isGlobal??!1),n=(m,E)=>{a({...e,[m]:E,fromAnnotations:!0})},o=m=>{m=!m,i(m),n("isGlobal",m)};return t.createElement("div",{className:"gf-form-group"},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:12},"OpenTSDB metrics query"),t.createElement(L.I,{value:r,onChange:m=>l(m.currentTarget.value??""),onBlur:()=>n("target",r),placeholder:"events.eventname"})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:12},"Show Global Annotations?"),t.createElement(R.x,{value:c,onChange:m=>o(c)})))},Fe=s=>({fromAnnotations:!0,target:s.target??"",name:s.name??"",isGlobal:s.isGlobal??!1}),ke=s=>{const e=s.target&&typeof s.target!="string"?s.target:Fe(s);return s.target=e,s};class Oe extends _.MF{constructor(e,a=(0,Ve.J)()){super(e),this.templateSrv=a,this.type="opentsdb",this.url=e.url,this.name=e.name,this.withCredentials=e.withCredentials,this.basicAuth=e.basicAuth,e.jsonData=e.jsonData||{},this.tsdbVersion=e.jsonData.tsdbVersion||1,this.tsdbResolution=e.jsonData.tsdbResolution||1,this.lookupLimit=e.jsonData.lookupLimit||1e3,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null,this.annotations={QueryEditor:Ie,prepareAnnotation:ke}}query(e){if(e.targets.some(n=>n.fromAnnotations)){const n=[];for(const o of e.targets)o.target&&n.push(new Ce.y(m=>{this.annotationEvent(e,o).then(E=>m.next({data:[(0,le.g0)(E)]})).catch(E=>m.next({data:[(0,le.g0)([])]})).finally(()=>m.complete())}));return(0,Se.T)(...n)}const a=this.convertToTSDBTime(e.range.raw.from,!1,e.timezone),r=this.convertToTSDBTime(e.range.raw.to,!0,e.timezone),l=[];(0,g.each)(e.targets,n=>{n.metric&&l.push(this.convertTargetToQuery(n,e,this.tsdbVersion))});const c=(0,g.compact)(l);if((0,g.isEmpty)(c))return(0,H.of)({data:[]});const i={};return(0,g.each)(c,n=>{n.filters&&n.filters.length>0?(0,g.each)(n.filters,o=>{i[o.tagk]=!0}):(0,g.each)(n.tags,(o,m)=>{i[m]=!0})}),e.targets=(0,g.filter)(e.targets,n=>n.hide!==!0),this.performTimeSeriesQuery(c,a,r).pipe((0,Ke.K)(n=>{throw n?.data?.error?.message||"Error performing time series query."}),(0,C.U)(n=>{const o=this.mapMetricsToTargets(n.data,e,this.tsdbVersion);return{data:(0,g.map)(n.data,(E,f)=>(f=o[f],f===-1&&(f=0),this._saveTagKeys(E),this.transformMetricData(E,i,e.targets[f],e,this.tsdbResolution)))}}))}annotationEvent(e,a){const r=this.convertToTSDBTime(e.range.raw.from,!1,e.timezone),l=this.convertToTSDBTime(e.range.raw.to,!0,e.timezone),c=[],i=[];c.push({aggregator:"sum",metric:a.target});const n=(0,g.compact)(c);return(0,P.n)(this.performTimeSeriesQuery(n,r,l).pipe((0,C.U)(o=>{if(o.data[0]){let m=o.data[0].annotations;a.isGlobal&&(m=o.data[0].globalAnnotations),m&&(0,g.each)(m,E=>{const f={text:E.description,time:Math.floor(E.startTime)*1e3,annotation:a};i.push(f)})}return i})))}targetContainsTemplate(e){if(e.filters&&e.filters.length>0){for(let a=0;a<e.filters.length;a++)if(this.templateSrv.containsTemplate(e.filters[a].filter))return!0}if(e.tags&&Object.keys(e.tags).length>0){for(const a in e.tags)if(this.templateSrv.containsTemplate(e.tags[a]))return!0}return!1}performTimeSeriesQuery(e,a,r){let l=!1;this.tsdbResolution===2&&(l=!0);const c={start:a,queries:e,msResolution:l,globalAnnotations:!0};this.tsdbVersion===3&&(c.showQuery=!0),r&&(c.end=r);const i={method:"POST",url:this.url+"/api/query",data:c};return this._addCredentialOptions(i),(0,oe.i)().fetch(i)}suggestTagKeys(e){const a=e.metric??"";return Promise.resolve(this.tagKeys[a]||[])}_saveTagKeys(e){const a=Object.keys(e.tags);(0,g.each)(e.aggregateTags,r=>{a.push(r)}),this.tagKeys[e.metric]=a}_performSuggestQuery(e,a){return this._get("/api/suggest",{type:a,q:e,max:this.lookupLimit}).pipe((0,C.U)(r=>r.data))}_performMetricKeyValueLookup(e,a){if(!e||!a)return(0,H.of)([]);const r=a.split(",").map(n=>n.trim()),l=r[0];let c=l+"=*";r.length>1&&(c+=","+r.splice(1).join(","));const i=e+"{"+c+"}";return this._get("/api/search/lookup",{m:i,limit:this.lookupLimit}).pipe((0,C.U)(n=>{n=n.data.results;const o=[];return(0,g.each)(n,m=>{o.indexOf(m.tags[l])===-1&&o.push(m.tags[l])}),o}))}_performMetricKeyLookup(e){return e?this._get("/api/search/lookup",{m:e,limit:1e3}).pipe((0,C.U)(a=>{a=a.data.results;const r=[];return(0,g.each)(a,l=>{(0,g.each)(l.tags,(c,i)=>{r.indexOf(i)===-1&&r.push(i)})}),r})):(0,H.of)([])}_get(e,a){const r={method:"GET",url:this.url+e,params:a};return this._addCredentialOptions(r),(0,oe.i)().fetch(r)}_addCredentialOptions(e){(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers={Authorization:this.basicAuth})}metricFindQuery(e){if(!e)return Promise.resolve([]);let a;try{a=this.templateSrv.replace(e,{},"distributed")}catch(w){return Promise.reject(w)}const r=w=>(0,g.map)(w,K=>({text:K})),l=/metrics\((.*)\)/,c=/tag_names\((.*)\)/,i=/tag_values\((.*?),\s?(.*)\)/,n=/suggest_tagk\((.*)\)/,o=/suggest_tagv\((.*)\)/,m=a.match(l);if(m)return(0,P.n)(this._performSuggestQuery(m[1],"metrics").pipe((0,C.U)(r)));const E=a.match(c);if(E)return(0,P.n)(this._performMetricKeyLookup(E[1]).pipe((0,C.U)(r)));const f=a.match(i);if(f)return(0,P.n)(this._performMetricKeyValueLookup(f[1],f[2]).pipe((0,C.U)(r)));const S=a.match(n);if(S)return(0,P.n)(this._performSuggestQuery(S[1],"tagk").pipe((0,C.U)(r)));const y=a.match(o);return y?(0,P.n)(this._performSuggestQuery(y[1],"tagv").pipe((0,C.U)(r))):Promise.resolve([])}testDatasource(){return(0,P.n)(this._performSuggestQuery("cpu","metrics").pipe((0,C.U)(()=>({status:"success",message:"Data source is working"}))))}getAggregators(){return this.aggregatorsPromise?this.aggregatorsPromise:(this.aggregatorsPromise=(0,P.n)(this._get("/api/aggregators").pipe((0,C.U)(e=>e.data&&(0,g.isArray)(e.data)?e.data.sort():[]))),this.aggregatorsPromise)}getFilterTypes(){return this.filterTypesPromise?this.filterTypesPromise:(this.filterTypesPromise=(0,P.n)(this._get("/api/config/filters").pipe((0,C.U)(e=>e.data?Object.keys(e.data).sort():[]))),this.filterTypesPromise)}transformMetricData(e,a,r,l,c){const i=this.createMetricLabel(e,r,a,l),n=[];return(0,g.each)(e.dps,(o,m)=>{c===2?n.push([o,m*1]):n.push([o,m*1e3])}),{target:i,datapoints:n}}createMetricLabel(e,a,r,l){if(a.alias){const n=(0,g.clone)(l.scopedVars||{});return(0,g.each)(e.tags,(o,m)=>{n["tag_"+m]={value:o}}),this.templateSrv.replace(a.alias,n)}let c=e.metric;const i=[];return(0,g.isEmpty)(e.tags)||(0,g.each)((0,g.toPairs)(e.tags),n=>{(0,g.has)(r,n[0])&&i.push(n[0]+"="+n[1])}),(0,g.isEmpty)(i)||(c+="{"+i.join(", ")+"}"),c}convertTargetToQuery(e,a,r){if(!e.metric||e.hide)return null;const l=this.interpolateVariablesInQuery(e,a.scopedVars);if(e.shouldComputeRate&&(l.rate=!0,l.rateOptions={counter:!!e.isCounter},e.counterMax&&e.counterMax.length&&(l.rateOptions.counterMax=parseInt(e.counterMax,10)),e.counterResetValue&&e.counterResetValue.length&&(l.rateOptions.resetValue=parseInt(e.counterResetValue,10)),r>=2&&(l.rateOptions.dropResets=!l.rateOptions.counterMax&&(!l.rateOptions.ResetValue||l.rateOptions.ResetValue===0))),!e.disableDownsampling){let c=this.templateSrv.replace(e.downsampleInterval||a.interval);c.match(/\.[0-9]+s/)&&(c=parseFloat(c)*1e3+"ms"),l.downsample=c+"-"+e.downsampleAggregator,e.downsampleFillPolicy&&e.downsampleFillPolicy!=="none"&&(l.downsample+="-"+e.downsampleFillPolicy)}return e.explicitTags&&(l.explicitTags=!0),l}interpolateVariablesInFilters(e,a){e.filters=e.filters?.map(r=>(r.tagk=this.templateSrv.replace(r.tagk,a,"pipe"),r.filter=this.templateSrv.replace(r.filter,a,"pipe"),r))}getVariables(){return this.templateSrv.getVariables().map(e=>`$${e.name}`)}mapMetricsToTargets(e,a,r){let l,c;return(0,g.map)(e,i=>r===3?i.query.index:(0,g.findIndex)(a.targets,n=>n.filters&&n.filters.length>0?n.metric===i.metric:n.metric===i.metric&&(0,g.every)(n.tags,(o,m)=>(l=this.templateSrv.replace(o,a.scopedVars,"pipe"),c=l.split("|"),(0,g.includes)(c,i.tags[m])||l==="*"))))}interpolateVariablesInQueries(e,a){return e.length?e.map(r=>this.interpolateVariablesInQuery(r,a)):e}interpolateVariablesInQuery(e,a){const r=(0,g.cloneDeep)(e);if(r.metric=this.templateSrv.replace(e.metric,a,"pipe"),r.aggregator="avg",e.aggregator&&(r.aggregator=this.templateSrv.replace(e.aggregator)),r.filters&&r.filters.length>0)this.interpolateVariablesInFilters(r,a);else if(r.tags)for(const l in r.tags)r.tags[l]=this.templateSrv.replace(r.tags[l],a,"pipe");return r}convertToTSDBTime(e,a,r){return e==="now"?null:(e=xe.parse(e,a,r),e.valueOf())}}const Pe=new _.hf(Oe).setQueryEditor(Te).setConfigEditor(pe)}}]);

//# sourceMappingURL=opentsdbPlugin.a1b162b1859720f9f273.js.map