"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5890],{39592:(fe,H,s)=>{s.d(H,{a:()=>ae});var x=s(31733),j=s(76932),K=s(41164),R=s(98572),e=s(64516),N=s(98463),k=Object.defineProperty,A=Object.defineProperties,U=Object.getOwnPropertyDescriptors,w=Object.getOwnPropertySymbols,B=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable,$=(M,T,O)=>T in M?k(M,T,{enumerable:!0,configurable:!0,writable:!0,value:O}):M[T]=O,P=(M,T)=>{for(var O in T||(T={}))B.call(T,O)&&$(M,O,T[O]);if(w)for(var O of w(T))V.call(T,O)&&$(M,O,T[O]);return M},G=(M,T)=>A(M,U(T));const ae=({config:M,onChange:T,className:O})=>{const ve=ie=>{T(G(P({},M),{jsonData:G(P({},M.jsonData),{keepCookies:ie})}))},de=ie=>{T(G(P({},M),{jsonData:G(P({},M.jsonData),{timeout:parseInt(ie.currentTarget.value,10)})}))},W={container:(0,j.css)({maxWidth:578})};return x.createElement(N._,{title:"Advanced HTTP settings",className:(0,j.cx)(W.container,O)},x.createElement(K._,{htmlFor:"advanced-http-cookies",label:"Allowed cookies",labelWidth:24,tooltip:"Grafana proxy deletes forwarded cookies by default. Specify cookies by name that should be forwarded to the data source.",disabled:M.readOnly,grow:!0},x.createElement(R.B,{id:"advanced-http-cookies",placeholder:"New cookie (hit enter to add)",tags:M.jsonData.keepCookies,onChange:ve})),x.createElement(K._,{htmlFor:"advanced-http-timeout",label:"Timeout",labelWidth:24,tooltip:"HTTP request timeout in seconds",disabled:M.readOnly,grow:!0},x.createElement(e.I,{id:"advanced-http-timeout",type:"number",min:0,placeholder:"Timeout in seconds","aria-label":"Timeout in seconds",value:M.jsonData.timeout,onChange:de})))}},84655:(fe,H,s)=>{s.d(H,{i:()=>R});var x=s(76932),j=s(31733),K=s(76067);const R=({hideLine:N=!1})=>{const k=(0,K.wW)(e);return N?j.createElement("hr",{className:k.dividerHideLine}):j.createElement("hr",{className:k.divider})},e=N=>({divider:(0,x.css)({margin:N.spacing(4,0)}),dividerHideLine:(0,x.css)({border:"none",margin:N.spacing(3,0)})})},96644:(fe,H,s)=>{s.d(H,{n:()=>N});var x=s(31733),j=s(69328);const K=x.lazy(()=>Promise.all([s.e(9207),s.e(8735),s.e(7142)]).then(s.bind(s,74897))),R=k=>x.createElement(x.Suspense,{fallback:null},x.createElement(K,{...k})),e=k=>{const A=(0,x.useRef)(null),{onRunQuery:U,onChange:w,...B}=k,V=P=>{A.current=P,w(P),U()},$=P=>{w(P)};return x.createElement(R,{onRunQuery:V,onBlur:$,onChange:w,...B})};class N extends x.PureComponent{constructor(A){super(A),this._isMounted=!1,this.onChangeQuery=(U,w)=>{const{query:B,onChange:V,onRunQuery:$}=this.props;if(V){const P={...B,expr:U};V(P),w&&$&&$()}},this.state={labelsLoaded:!1}}async componentDidMount(){this._isMounted=!0,await this.props.datasource.languageProvider.start(this.props.range),this._isMounted&&this.setState({labelsLoaded:!0})}componentWillUnmount(){this._isMounted=!1}componentDidUpdate(A){const{range:U,datasource:{languageProvider:w}}=this.props;(0,j.rf)(U,A.range)&&w.fetchLabels({timeRange:U})}render(){const{ExtraFieldElement:A,query:U,datasource:w,history:B,onRunQuery:V,range:$}=this.props,P=this.props.placeholder??"Enter a Loki query (run with Shift+Enter)";return x.createElement(x.Fragment,null,x.createElement("div",{className:"gf-form-inline gf-form-inline--xs-view-flex-column flex-grow-1","data-testid":this.props["data-testid"]},x.createElement("div",{className:"gf-form--grow flex-shrink-1 min-width-15"},x.createElement(e,{datasource:w,history:B??[],onChange:this.onChangeQuery,onRunQuery:V,initialValue:U.expr??"",placeholder:P,timeRange:$}))),A)}}},45890:(fe,H,s)=>{s.r(H),s.d(H,{plugin:()=>Ua});var x=s(51023),j=s(93670),K=s(1727),R=s(69781),e=s(31733),N=s(64704),k=s(69328);const A=['{job="default/prometheus"}'],U=["job","app","k8s_app"],w=5,B=[{title:"Log pipeline",expression:'{job="mysql"} |= "metrics" | logfmt | duration > 10s',label:'This query targets the MySQL job, keeps logs that contain the substring "metrics", and then parses and filters the logs further.'},{title:"Count over time",expression:'count_over_time({job="mysql"}[5m])',label:"This query counts all the log lines within the last five minutes for the MySQL job."},{title:"Rate",expression:'rate(({job="mysql"} |= "error" != "timeout")[10s])',label:"This query gets the per-second rate of all non-timeout errors within the last ten seconds for the MySQL job."},{title:"Aggregate, count, and group",expression:'sum(count_over_time({job="mysql"}[5m])) by (level)',label:"Get the count of logs during the last five minutes, grouping by level."}];class V extends e.PureComponent{constructor(){super(...arguments),this.state={userExamples:[]},this.checkUserLabels=async()=>{const t=this.props.datasource?.languageProvider;if(t.started){const n=t.getLabelKeys()||[],l=U.find(r=>n.includes(r));if(l){const r=await t.fetchLabelValues(l),o=(0,R.shuffle)(r).slice(0,w).map(u=>`{${l}="${(0,k.U9)(u)}"}`);this.setState({userExamples:o})}}else this.scheduleUserLabelChecking()}}componentDidMount(){this.scheduleUserLabelChecking(),(0,N.ff)("grafana_loki_cheatsheet_opened",{})}componentWillUnmount(){clearTimeout(this.userLabelTimer)}scheduleUserLabelChecking(){this.userLabelTimer=setTimeout(this.checkUserLabels,1e3)}renderExpression(t){const{onClickExample:n}=this.props,l=r=>{n(r),(0,N.ff)("grafana_loki_cheatsheet_example_clicked",{})};return e.createElement("button",{type:"button",className:"cheat-sheet-item__example",key:t,onClick:()=>l({refId:"A",expr:t})},e.createElement("code",null,t))}render(){const{userExamples:t}=this.state,n=t.length>0;return e.createElement("div",null,e.createElement("h2",null,"Loki Cheat Sheet"),e.createElement("div",{className:"cheat-sheet-item"},e.createElement("div",{className:"cheat-sheet-item__title"},"See your logs"),e.createElement("div",{className:"cheat-sheet-item__label"},"Start by selecting a log stream from the Label browser, or alternatively you can write a stream selector into the query field."),n?e.createElement("div",null,e.createElement("div",{className:"cheat-sheet-item__label"},"Here are some example streams from your logs:"),t.map(l=>this.renderExpression(l))):e.createElement("div",null,e.createElement("div",{className:"cheat-sheet-item__label"},"Here is an example of a log stream:"),this.renderExpression(A[0]))),e.createElement("div",{className:"cheat-sheet-item"},e.createElement("div",{className:"cheat-sheet-item__title"},"Combine stream selectors"),this.renderExpression('{app="cassandra",namespace="prod"}'),e.createElement("div",{className:"cheat-sheet-item__label"},"Returns all log lines from streams that have both labels.")),e.createElement("div",{className:"cheat-sheet-item"},e.createElement("div",{className:"cheat-sheet-item__title"},"Filtering for search terms."),this.renderExpression('{app="cassandra"} |~ "(duration|latency)s*(=|is|of)s*[d.]+"'),this.renderExpression('{app="cassandra"} |= "exact match"'),this.renderExpression('{app="cassandra"} != "do not match"'),e.createElement("div",{className:"cheat-sheet-item__label"},e.createElement("a",{href:"https://grafana.com/docs/loki/latest/logql/#log-pipeline",target:"logql"},"LogQL")," ","supports exact and regular expression filters.")),B.map(l=>e.createElement("div",{className:"cheat-sheet-item",key:l.expression},e.createElement("div",{className:"cheat-sheet-item__title"},l.title),this.renderExpression(l.expression),e.createElement("div",{className:"cheat-sheet-item__label"},l.label))))}}var $=s(44343),P=s(31621),G=s(20298),ae=s(21568),M=s(76787),T=s(17302),O=s(10359),ve=s(51925),de=s(39836),W=s(85498),ie=s(90069),D=s(51343),lt=s(29580),rt=s(41197),q=s(28015),we=s(40243),h=s(76932),Z=s(76067),Fe=s(5572),Ie=s(61375),ot=s(85853),it=s(61231),ct=s(49596),me=s(36667),Ee=s(43794),ne=s(64516),Re=s(79106);const ye=1e3,be=1e4,ut=4,Le="{}";function X(a){const t=[];for(const n of a)if(n.selected&&n.values&&n.values.length>0){const l=n.values.filter(r=>r.selected).map(r=>r.name);l.length>1?t.push(`${n.name}=~"${l.map(k.tU).join("|")}"`):l.length===1&&t.push(`${n.name}="${(0,k.U9)(l[0])}"`)}return["{",t.join(","),"}"].join("")}function dt(a,t,n){return a.map(l=>{const r=t[l.name];if(r){let o;if(l.name===n&&l.values)o=l.values;else{const u=new Set(l.values?.filter(i=>i.selected).map(i=>i.name)||[]);o=r.map(i=>({name:i,selected:u.has(i)}))}return{...l,loading:!1,values:o,facets:o.length}}return{...l,loading:!1,hidden:!r,values:void 0,facets:0}})}const mt=a=>({wrapper:(0,h.css)`
    background-color: ${a.colors.background.secondary};
    width: 100%;
  `,wrapperPadding:(0,h.css)`
    padding: ${a.spacing(2)};
  `,list:(0,h.css)`
    margin-top: ${a.spacing(1)};
    display: flex;
    flex-wrap: wrap;
    max-height: 200px;
    overflow: auto;
  `,section:(0,h.css)`
    & + & {
      margin: ${a.spacing(2,0)};
    }

    position: relative;
  `,footerSectionStyles:(0,h.css)`
    padding: ${a.spacing(1)};
    background-color: ${a.colors.background.primary};
    position: sticky;
    bottom: -${a.spacing(3)}; /* offset the padding on modal */
    left: 0;
  `,selector:(0,h.css)`
    font-family: ${a.typography.fontFamilyMonospace};
    margin-bottom: ${a.spacing(1)};
    width: 100%;
  `,status:(0,h.css)`
    margin-bottom: ${a.spacing(1)};
    color: ${a.colors.text.secondary};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: opacity 100ms linear;
    opacity: 0;
    font-size: ${a.typography.bodySmall.fontSize};
    height: calc(${a.typography.bodySmall.fontSize} + 10px);
  `,statusShowing:(0,h.css)`
    opacity: 1;
  `,error:(0,h.css)`
    color: ${a.colors.error.main};
  `,valueList:(0,h.css)`
    margin-right: ${a.spacing(1)};
    resize: horizontal;
  `,valueListWrapper:(0,h.css)`
    border-left: 1px solid ${a.colors.border.medium};
    margin: ${a.spacing(1,0)};
    padding: ${a.spacing(1,0,1,1)};
  `,valueListArea:(0,h.css)`
    display: flex;
    flex-wrap: wrap;
    margin-top: ${a.spacing(1)};
  `,valueTitle:(0,h.css)`
    margin-left: -${a.spacing(.5)};
    margin-bottom: ${a.spacing(1)};
  `,validationStatus:(0,h.css)`
    padding: ${a.spacing(.5)};
    margin-bottom: ${a.spacing(1)};
    color: ${a.colors.text.maxContrast};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  `});class gt extends e.Component{constructor(){super(...arguments),this.state={labels:[],searchTerm:"",status:"Ready",error:"",validationStatus:""},this.onChangeSearch=t=>{this.setState({searchTerm:t.target.value})},this.onClickRunLogsQuery=()=>{(0,N.ff)("grafana_loki_label_browser_closed",{app:this.props.app,closeType:"showLogsButton"});const t=X(this.state.labels);this.props.onChange(t)},this.onClickRunMetricsQuery=()=>{(0,N.ff)("grafana_loki_label_browser_closed",{app:this.props.app,closeType:"showLogsRateButton"});const n=`rate(${X(this.state.labels)}[$__auto])`;this.props.onChange(n)},this.onClickClear=()=>{this.setState(t=>({labels:t.labels.map(l=>({...l,values:void 0,selected:!1,loading:!1,hidden:!1,facets:void 0})),searchTerm:"",status:"",error:"",validationStatus:""})),this.props.deleteLastUsedLabels()},this.onClickLabel=(t,n,l)=>{const r=this.state.labels.find(i=>i.name===t);if(!r)return;const o=!r.selected;let u={selected:o};if(r.values&&!o){const i=r.values.map(c=>({...c,selected:!1}));u={...u,facets:0,values:i}}this.setState({searchTerm:""}),this.updateLabelState(t,u,"",()=>this.doFacettingForLabel(t))},this.onClickValue=(t,n,l)=>{const r=this.state.labels.find(u=>u.name===t);if(!r||!r.values)return;this.setState({searchTerm:""});const o=r.values.map(u=>({...u,selected:u.name===n?!u.selected:u.selected}));this.updateLabelState(t,{values:o},"",()=>this.doFacetting(t))},this.onClickValidate=()=>{const t=X(this.state.labels);this.validateSelector(t)},this.doFacetting=t=>{const n=X(this.state.labels);if(n===Le){const l=this.state.labels.map(r=>({...r,facets:0,values:void 0,hidden:!1}));this.setState({labels:l},()=>{this.state.labels.forEach(r=>r.selected&&this.fetchValues(r.name,n))})}else this.fetchSeries(n,t)}}updateLabelState(t,n,l="",r){this.setState(o=>{const u=o.labels.map(c=>c.name===t?{...c,...n}:c),i=l?"":o.error;return{labels:u,status:l,error:i,validationStatus:""}},r)}componentDidMount(){const{languageProvider:t,autoSelect:n=ut,lastUsedLabels:l,timeRange:r}=this.props;if(t){const o=l;t.start(r).then(()=>{let u=t.getLabelKeys();if(u.length>ye){const c=`Too many labels found (showing only ${ye} of ${u.length})`;u=u.slice(0,ye),this.setState({error:c})}const i=u.map((c,g,f)=>({name:c,selected:f.length<=n&&o.length===0||o.includes(c),loading:!1}));this.setState({labels:i},()=>{this.state.labels.forEach(c=>{c.selected&&this.fetchValues(c.name,Le)})})})}}doFacettingForLabel(t){const n=this.state.labels.find(r=>r.name===t);if(!n)return;const l=this.state.labels.filter(r=>r.selected).map(r=>r.name);this.props.storeLastUsedLabels(l),n.selected?n.values||this.fetchValues(t,X(this.state.labels)):this.doFacetting()}async fetchValues(t,n){const{languageProvider:l,timeRange:r}=this.props;this.updateLabelState(t,{loading:!0},`Fetching values for ${t}`);try{let o=await l.fetchLabelValues(t,{timeRange:r});if(n!==X(this.state.labels)){this.updateLabelState(t,{loading:!1},"");return}if(o.length>be){const i=`Too many values for ${t} (showing only ${be} of ${o.length})`;o=o.slice(0,be),this.setState({error:i})}const u=o.map(i=>({name:i}));this.updateLabelState(t,{values:u,loading:!1})}catch(o){console.error(o)}}async fetchSeries(t,n){const{languageProvider:l,timeRange:r}=this.props;n&&this.updateLabelState(n,{loading:!0},`Loading labels for ${t}`);try{const o=await l.fetchSeriesLabels(t,{timeRange:r});if(t!==X(this.state.labels)){n&&this.updateLabelState(n,{loading:!1});return}if(Object.keys(o).length===0){this.setState({error:`Empty results, no matching label for ${t}`});return}const u=dt(this.state.labels,o,n);this.setState({labels:u,error:""}),n&&this.updateLabelState(n,{loading:!1})}catch(o){console.error(o)}}async validateSelector(t){const{languageProvider:n,timeRange:l}=this.props;this.setState({validationStatus:`Validating selector ${t}`,error:""});const r=await n.fetchSeries(t,{timeRange:l});this.setState({validationStatus:`Selector is valid (${r.length} streams found)`})}render(){const{theme:t}=this.props,{labels:n,searchTerm:l,status:r,error:o,validationStatus:u}=this.state;if(n.length===0)return e.createElement(Ie.u,{text:"Loading labels..."});const i=mt(t),c=X(this.state.labels),g=c===Le;let f=n.filter(d=>d.selected&&d.values);return l?f=f.map(d=>{const y=d.values.filter(L=>{if(L.selected)return L.highlightParts=void 0,!0;const S=(0,ct.C)(L.name.toLowerCase(),l.toLowerCase());return S.found?(L.highlightParts=S.ranges,L.order=S.distance,!0):!1});return{...d,values:(0,R.sortBy)(y,L=>L.selected?-1/0:L.order)}}):f=this.state.labels.filter(d=>d.selected&&d.values).map(d=>({...d,values:d?.values?d.values.map(y=>({...y,highlightParts:void 0})):[]})),e.createElement(e.Fragment,null,e.createElement("div",{className:i.wrapper},e.createElement("div",{className:(0,h.cx)(i.section,i.wrapperPadding)},e.createElement(me._,{description:"Which labels would you like to consider for your search?"},"1. Select labels to search in"),e.createElement("div",{className:i.list},n.map(d=>e.createElement(Ee._,{key:d.name,name:d.name,loading:d.loading,active:d.selected,hidden:d.hidden,facets:d.facets,onClick:this.onClickLabel})))),e.createElement("div",{className:(0,h.cx)(i.section,i.wrapperPadding)},e.createElement(me._,{description:"Choose the label values that you would like to use for the query. Use the search field to find values across selected labels."},"2. Find values for the selected labels"),e.createElement("div",null,e.createElement(ne.I,{onChange:this.onChangeSearch,"aria-label":"Filter expression for values",value:l,placeholder:"Enter a label value"})),e.createElement("div",{className:i.valueListArea},f.map(d=>e.createElement("div",{role:"list",key:d.name,className:i.valueListWrapper},e.createElement("div",{className:i.valueTitle,"aria-label":`Values for ${d.name}`},e.createElement(Ee._,{name:d.name,loading:d.loading,active:d.selected,hidden:d.hidden,facets:d.facets||d.values?.length,onClick:this.onClickLabel})),e.createElement(it.t7,{height:200,itemCount:d.values?.length||0,itemSize:28,itemKey:y=>d.values?.[y].name??y,width:200,className:i.valueList},({index:y,style:L})=>{const S=d.values?.[y];return S?e.createElement("div",{style:L},e.createElement(Ee._,{name:d.name,value:S?.name,active:S?.selected,highlightParts:S?.highlightParts,onClick:this.onClickValue,searchTerm:l})):null})))))),e.createElement("div",{className:i.footerSectionStyles},e.createElement(me._,null,"3. Resulting selector"),e.createElement("pre",{"aria-label":"selector",className:i.selector},c),u&&e.createElement("div",{className:i.validationStatus},u),e.createElement("div",{className:(0,h.cx)(i.status,(r||o)&&i.statusShowing)},e.createElement("span",{className:o?i.error:""},o||r)),e.createElement(Re.Lh,null,e.createElement(D.zx,{"aria-label":"Use selector as logs button",disabled:g,onClick:this.onClickRunLogsQuery},"Show logs"),e.createElement(D.zx,{"aria-label":"Use selector as metrics button",variant:"secondary",disabled:g,onClick:this.onClickRunMetricsQuery},"Show logs rate"),e.createElement(D.zx,{"aria-label":"Validate submit button",variant:"secondary",disabled:g,onClick:this.onClickValidate},"Validate selector"),e.createElement(D.zx,{"aria-label":"Selector clear button",variant:"secondary",onClick:this.onClickClear},"Clear"))))}}const pt=(0,Z.HE)(gt),ht=a=>{const{isOpen:t,onClose:n,datasource:l,app:r,timeRange:o}=a,[u,i]=(0,e.useState)(!1),[c,g]=(0,e.useState)(!1),f="grafana.datasources.loki.browser.labels",d=(0,Z.wW)(ft);(0,e.useEffect)(()=>{t&&l.languageProvider.fetchLabels({timeRange:o}).then(v=>{i(!0),g(v.length>0)})},[l,t,o]);const y=v=>{const{query:p,onChange:m,onRunQuery:b}=a,Q={...p,expr:v};m(Q),b()},L=v=>{y(v),n()},S=()=>{(0,N.ff)("grafana_loki_label_browser_closed",{app:r,closeType:"modalClose"}),n()};return e.createElement(Fe.u,{isOpen:t,title:"Label browser",onDismiss:S,className:d.modal},!u&&e.createElement(Ie.u,{text:"Loading labels..."}),u&&!c&&e.createElement("p",null,"No labels found."),u&&c&&e.createElement(ot.G,{storageKey:f,defaultValue:[]},(v,p,m)=>e.createElement(pt,{languageProvider:l.languageProvider,onChange:L,lastUsedLabels:v,storeLastUsedLabels:p,deleteLastUsedLabels:m,app:r,timeRange:o})))},ft=a=>({modal:(0,h.css)`
      width: 85vw;
      ${a.breakpoints.down("md")} {
        width: 100%;
      }
    `});var vt=s(4579),F=s(17022),_=s(53273),Et=s(5333),Se=s(70605),$e=s(35844),ee=s(73375),yt=s(92651),se=s(84275),bt=s(61262),Lt=s(30019),le=s(41164),te=s(38834),re=s(9184),St=s(58239);function xt({item:a,items:t,defaultOp:n,onChange:l,onDelete:r,onGetLabelNames:o,onGetLabelValues:u,invalidLabel:i,invalidValue:c}){const[g,f]=(0,e.useState)({}),[d,y]=(0,e.useState)(!1),[L,S]=(0,e.useState)(!1),v="You have conflicting label filters",p=(E=a.op)=>Ue.find(J=>J.label===E)?.isMultiValue,m=E=>E?E.indexOf("|")>0?E.split("|"):[E]:[],b=()=>{const E=g.labelValues?[...g.labelValues]:[],J=m(a?.value).map(se.E);return(0,R.uniqBy)([...J,...E],"value")},Q=(0,St.Zc)(a,t);return e.createElement("div",{"data-testid":"prometheus-dimensions-filter-item"},e.createElement(le._,{error:v,invalid:Q?!0:void 0},e.createElement(bt.B,null,e.createElement(te.Ph,{placeholder:"Select label","data-testid":ae.wl.components.QueryBuilder.labelSelect,inputId:"prometheus-dimensions-filter-item-key",width:"auto",value:a.label?(0,se.E)(a.label):null,allowCustomValue:!0,onOpenMenu:async()=>{f({isLoadingLabelNames:!0});const E=await o(a);y(!0),f({labelNames:E,isLoadingLabelNames:void 0})},onCloseMenu:()=>{y(!1)},isOpen:d,isLoading:g.isLoadingLabelNames,options:g.labelNames,onChange:E=>{E.label&&l({...a,op:a.op??n,label:E.label})},invalid:Q||i}),e.createElement(te.Ph,{"data-testid":ae.wl.components.QueryBuilder.matchOperatorSelect,value:(0,se.E)(a.op??n),options:Ue,width:"auto",onChange:E=>{E.value!=null&&l({...a,op:E.value,value:p(E.value)?a.value:m(a?.value)[0]})},invalid:Q}),e.createElement(te.Ph,{placeholder:"Select value","data-testid":ae.wl.components.QueryBuilder.valueSelect,inputId:"prometheus-dimensions-filter-item-value",width:"auto",value:p()?m(a?.value).map(se.E):m(a?.value).map(se.E)[0],allowCustomValue:!0,onOpenMenu:async()=>{f({isLoadingLabelValues:!0});const E=await u(a);f({...g,labelValues:E,isLoadingLabelValues:void 0}),S(!0)},onCloseMenu:()=>{S(!1)},isOpen:L,isMulti:p(),isLoading:g.isLoadingLabelValues,options:b(),onChange:E=>{if(E.value)l({...a,value:E.value,op:a.op??n});else{const J=E.map(z=>z.label).join("|");l({...a,value:J,op:a.op??n})}},invalid:Q||c}),e.createElement(Lt._,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:r}))))}const Ue=[re.AI.equals,re.AI.doesNotEqual,re.AI.matchesRegex,re.AI.doesNotMatchRegex],Ct="Select at least 1 label filter (label and value)";function Nt({labelsFilters:a,onChange:t,onGetLabelNames:n,onGetLabelValues:l,labelFilterRequired:r}){const o="=",[u,i]=(0,e.useState)([{op:o}]);(0,e.useEffect)(()=>{a.length>0?i(a):i([{op:o}])},[a]);const c=f=>{i(f);const d=f.filter(y=>y.label!=null&&y.value!=null);(0,R.isEqual)(d,a)||t(d)},g=u.some(f=>f.label&&f.value);return e.createElement($e.s,null,e.createElement(ee.S,{label:"Label filters",error:Ct,invalid:r&&!g},e.createElement(yt.k,{items:u,onChange:c,renderItem:(f,d,y)=>e.createElement(xt,{item:f,items:u,defaultOp:o,onChange:d,onDelete:y,onGetLabelNames:n,onGetLabelValues:l,invalidLabel:r&&!f.label,invalidValue:r&&!f.value})})))}var Ae=s(4631),Mt=s(41820),Be=s(16975),Pt=s(35887),Tt=s(48733),ge=s(97523),pe=s(74823),Ve=s(37739);const ze="Fetch all log lines matching label filters.",je=e.memo(({query:a})=>{const t=(0,_._z)(a||"").query,n={grammar:pe.xY,name:"lokiql"};return e.createElement(Ve.K,{gap:0,direction:"column"},e.createElement(Ae.B,{stepNumber:1,title:e.createElement(ge.U,{query:`${F.y.renderLabels(t.labels)}`,lang:n})},ze),e.createElement(Be.V,{stepNumber:2,queryModeller:F.y,query:t,lang:n}))});je.displayName="LokiQueryBuilderExplained";var ce=s(1537),We=s(41354),Qt=s(55284);const He=e.memo(({nestedQuery:a,index:t,datasource:n,onChange:l,onRemove:r,onRunQuery:o,showExplain:u})=>{const i=(0,Z.wW)(Dt);return e.createElement("div",{className:i.card},e.createElement("div",{className:i.header},e.createElement("div",{className:i.name},"Operator"),e.createElement(te.Ph,{"aria-label":"Select operator",width:"auto",options:Ot,value:(0,se.E)(a.operator),onChange:c=>{l(t,{...a,operator:c.value})}}),e.createElement("div",{className:i.name},"Vector matches"),e.createElement("div",{className:i.vectorMatchWrapper},e.createElement(te.Ph,{width:"auto",value:a.vectorMatchesType||"on",allowCustomValue:!0,options:[{value:"on",label:"on"},{value:"ignoring",label:"ignoring"}],onChange:c=>{l(t,{...a,vectorMatchesType:c.value})}}),e.createElement(ce.H,{className:i.vectorMatchInput,minWidth:20,defaultValue:a.vectorMatches,onCommitChange:c=>{l(t,{...a,vectorMatches:c.currentTarget.value,vectorMatchesType:a.vectorMatchesType||"on"})}})),e.createElement(O.B,{grow:1}),e.createElement(We.h,{name:"times",size:"sm",onClick:()=>r(t),tooltip:"Remove nested query"})),e.createElement("div",{className:i.body},e.createElement(de._,null,e.createElement(xe,{showExplain:u,query:a.query,datasource:n,onRunQuery:o,onChange:c=>{l(t,{...a,query:c})}}))))}),Ot=Qt.i.map(a=>({label:a.sign,value:a.sign}));He.displayName="NestedQuery";const Dt=a=>({card:(0,h.css)({label:"card",display:"flex",flexDirection:"column",gap:a.spacing(.5)}),header:(0,h.css)({label:"header",padding:a.spacing(.5,.5,.5,1),gap:a.spacing(1),display:"flex",alignItems:"center"}),name:(0,h.css)({label:"name",whiteSpace:"nowrap"}),body:(0,h.css)({label:"body",paddingLeft:a.spacing(2)}),vectorMatchInput:(0,h.css)({label:"vectorMatchInput",marginLeft:-1}),vectorMatchWrapper:(0,h.css)({label:"vectorMatchWrapper",display:"flex"})});function kt({query:a,datasource:t,onChange:n,onRunQuery:l,showExplain:r}){const o=a.binaryQueries??[],u=(c,g)=>{const f=[...o];f.splice(c,1,g),n({...a,binaryQueries:f})},i=c=>{const g=[...o.slice(0,c),...o.slice(c+1)];n({...a,binaryQueries:g})};return e.createElement(Ve.K,{direction:"column",gap:1},o.map((c,g)=>e.createElement(He,{key:g.toString(),nestedQuery:c,index:g,onChange:u,datasource:t,onRemove:i,onRunQuery:l,showExplain:r})))}const xe=e.memo(({datasource:a,query:t,onChange:n,onRunQuery:l,showExplain:r,timeRange:o})=>{const[u,i]=(0,e.useState)(),[c,g]=(0,e.useState)(void 0),f=p=>{n({...t,labels:p})},d=async p=>{const m=await p;return[...a.getVariables(),...m].map(b=>({label:b,value:b}))},y=async p=>{const m=t.labels.filter(z=>z!==p);if(m.length===0)return await a.languageProvider.fetchLabels({timeRange:o});const b=F.y.renderLabels(m),Q=await a.languageProvider.fetchSeriesLabels(b,{timeRange:o}),E=m.map(z=>z.label);return Object.keys(Q).filter(z=>!E.includes(z)).sort()},L=async p=>{if(!p.label)return[];let m;const b=t.labels.filter(Q=>Q!==p);if(b.length===0)m=await a.languageProvider.fetchLabelValues(p.label,{timeRange:o});else{const Q=F.y.renderLabels(b);m=(await a.languageProvider.fetchSeriesLabels(Q))[a.interpolateString(p.label)]}return m?m.map(Q=>(0,k.Hk)(Q,p.op)):[]},S=(0,e.useMemo)(()=>{const{labels:p,operations:m}=t;return!p.length&&m.length?!(m.length===1&&m[0].id===re.B5.LineContains&&m[0].params[0]===""):!1},[t]);(0,e.useEffect)(()=>{const p=async()=>{const m={expr:F.y.renderQuery(t),refId:"data-samples"},b=o??(0,Et.JK)(),E={series:await a.getDataSamples(m,b),state:G.Gu.Done,timeRange:b};i(E)};W.config.featureToggles.lokiQueryHints&&p().catch(console.error)},[a,t,o]);const v={grammar:pe.ZP,name:"logql"};return e.createElement("div",{"data-testid":Me.editor},e.createElement(Se.p,null,e.createElement(Nt,{onGetLabelNames:p=>d(y(p)),onGetLabelValues:p=>d(L(p)),labelsFilters:t.labels,onChange:f,labelFilterRequired:S})),r&&e.createElement(Ae.B,{stepNumber:1,title:e.createElement(ge.U,{query:`${F.y.renderLabels(t.labels)}`,lang:v})},ze),e.createElement(Pt.B,null,e.createElement(Mt.P,{queryModeller:F.y,query:t,onChange:n,onRunQuery:l,datasource:a,highlightedOp:c}),e.createElement(Tt.L,{datasource:a,query:t,onChange:n,data:u,queryModeller:F.y,buildVisualQueryFromString:_._z})),r&&e.createElement(Be.V,{stepNumber:2,queryModeller:F.y,query:t,lang:v,onMouseEnter:p=>{g(p)},onMouseLeave:()=>{g(void 0)}}),t.binaryQueries&&t.binaryQueries.length>0&&e.createElement(kt,{query:t,datasource:a,onChange:n,onRunQuery:l,showExplain:r}))});xe.displayName="LokiQueryBuilder";function wt({query:a}){return e.createElement(Se.p,null,e.createElement($e.s,null,e.createElement(ge.U,{query:a,lang:{grammar:pe.xY,name:"lokiql"}})))}function Ft(a){const{query:t,onChange:n,onRunQuery:l,datasource:r,showExplain:o,timeRange:u}=a,[i,c]=(0,e.useReducer)(Ke.reducer,{expr:t.expr,visQuery:t.expr===""?{labels:[],operations:[{id:"__line_contains",params:[""]}]}:void 0});(0,e.useEffect)(()=>{c($t(t.expr))},[t.expr]);const g=f=>{const d=F.y.renderQuery(f);c(Rt({visQuery:f,expr:d})),n({...a.query,expr:d})};return i.visQuery?e.createElement(e.Fragment,null,e.createElement(xe,{query:i.visQuery,datasource:r,onChange:g,onRunQuery:l,showExplain:o,"data-testid":Me.editor,timeRange:u}),t.expr!==""&&e.createElement(wt,{query:t.expr})):null}const It={expr:""},Ke=(0,vt.oM)({name:"loki-builder-container",initialState:It,reducers:{visualQueryChange:(a,t)=>{a.expr=t.payload.expr,a.visQuery=t.payload.visQuery},exprChanged:(a,t)=>{if(!a.visQuery||a.expr!==t.payload){a.expr=t.payload;const n=(0,_._z)(t.payload);a.visQuery=n.query}}}}),{visualQueryChange:Rt,exprChanged:$t}=Ke.actions;var Ge=s(16528),Ut=s(96856),At=s(25111),Bt=s(46675),ue=s(13464),Ce=s(68735);const Ze=e.memo(({app:a,query:t,onChange:n,onRunQuery:l,maxLines:r,queryStats:o})=>{const[u,i]=(0,e.useState)(!0),c=m=>{n({...t,queryType:m}),l()},g=m=>{(0,N.ff)("grafana_loki_resolution_clicked",{app:a,resolution:m.value}),n({...t,resolution:m.value}),l()},f=m=>{const b=m.currentTarget.value;if(!(0,Ge.jO)(b)){i(!1);return}i(!0),n({...t,splitDuration:b}),l()},d=m=>{n({...t,legendFormat:m.currentTarget.value}),l()};function y(m){const b=(0,ue.Wz)(m.currentTarget.value);t.maxLines!==b&&(n({...t,maxLines:b}),l())}function L(m){n({...t,step:(0,R.trim)(m.currentTarget.value)}),l()}const S=(0,Ce.Lw)(t),v=(0,Ce.rE)(t.expr),p=(0,e.useMemo)(()=>!!(!t.step||(0,Ge.fI)(t.step)||!isNaN(Number(t.step))),[t.step]);return e.createElement(Se.p,null,e.createElement(Bt.d,{title:"Options",collapsedInfo:Vt(t,S,r,v,p),queryStats:o},e.createElement(ee.S,{label:"Legend",tooltip:"Series name override or template. Ex. {{hostname}} will be replaced with label value for hostname."},e.createElement(ce.H,{placeholder:"{{label}}",type:"string",minWidth:14,defaultValue:t.legendFormat,onCommitChange:d})),e.createElement(ee.S,{label:"Type"},e.createElement(Ut.S,{options:ue.uG,value:S,onChange:c})),v&&e.createElement(ee.S,{label:"Line limit",tooltip:"Upper limit for number of log lines returned by query."},e.createElement(ce.H,{className:"width-4",placeholder:r.toString(),type:"number",min:0,defaultValue:t.maxLines?.toString()??"",onCommitChange:y})),!v&&e.createElement(e.Fragment,null,e.createElement(ee.S,{label:"Step",tooltip:"Use the step parameter when making metric queries to Loki. If not filled, Grafana's calculated interval will be used. Example valid values: 1s, 5m, 10h, 1d.",invalid:!p,error:"Invalid step. Example valid values: 1s, 5m, 10h, 1d."},e.createElement(ce.H,{className:"width-6",placeholder:"auto",type:"string",defaultValue:t.step??"",onCommitChange:L})),t.resolution!==void 0&&t.resolution>1&&e.createElement(e.Fragment,null,e.createElement(ee.S,{label:"Resolution",tooltip:"Changes the step parameter of Loki metrics range queries. With a resolution of 1/1, each pixel corresponds to one data point. 1/10 retrieves one data point per 10 pixels. Lower resolutions perform better."},e.createElement(te.Ph,{isSearchable:!1,onChange:g,options:ue.oZ,value:t.resolution||1,"aria-label":"Select resolution"})),e.createElement(At.b,{severity:"warning",title:"The 'Resolution' is deprecated. Use 'Step' editor instead to change step parameter."}))),W.config.featureToggles.lokiQuerySplittingConfig&&W.config.featureToggles.lokiQuerySplitting&&e.createElement(ee.S,{label:"Split Duration",tooltip:"Defines the duration of a single query when query splitting is enabled."},e.createElement(ce.H,{minWidth:14,type:"string",min:0,defaultValue:t.splitDuration??"1d",onCommitChange:f,invalid:!u}))))});function Vt(a,t,n,l,r){const o=ue.uG.find(c=>c.value===t),u=ue.oZ.find(c=>c.value===(a.resolution??1)),i=[];return a.legendFormat&&i.push(`Legend: ${a.legendFormat}`),i.push(`Type: ${o?.label}`),l&&i.push(`Line limit: ${a.maxLines??n}`),l||(a.step&&i.push(`Step: ${r?a.step:"Invalid value"}`),a.resolution&&i.push(`Resolution: ${u?.label}`)),i}Ze.displayName="LokiQueryBuilderOptions";var Xe=s(58037),Ye=s(49311),zt=s(20154),Je=s(96644);function jt({query:a,datasource:t,range:n,onRunQuery:l,onChange:r,data:o,app:u,showExplain:i,history:c}){const g=(0,Z.wW)(Wt),f=W.config.featureToggles.lokiFormatQuery,d=async()=>r({...a,expr:(0,Ce.Ix)(a.expr,t)});return e.createElement("div",{className:g.wrapper},e.createElement(Je.n,{datasource:t,query:a,range:n,onRunQuery:l,onChange:r,history:c,data:o,app:u,"data-testid":Me.editor,ExtraFieldElement:e.createElement(e.Fragment,null,f&&e.createElement("div",{className:g.buttonGroup},e.createElement("div",null,e.createElement(Re.Lh,{spacing:"sm"},e.createElement(We.h,{onClick:d,name:"brackets-curly",size:"xs",tooltip:"Format query"}),e.createElement(Xe.u,{content:`Use ${(0,zt.vl)()}+z to undo`},e.createElement(Ye.J,{className:g.hint,name:"keyboard"}))))))}),i&&e.createElement(je,{query:a.expr}))}const Wt=a=>({wrapper:(0,h.css)`
      max-width: 100%;
      .gf-form {
        margin-bottom: 0.5;
      }
    `,buttonGroup:(0,h.css)`
      border: 1px solid ${a.colors.border.medium};
      border-top: none;
      padding: ${a.spacing(.5,.5,.5,.5)};
      margin-bottom: ${a.spacing(.5)};
      display: flex;
      flex-grow: 1;
      justify-content: end;
      font-size: ${a.typography.bodySmall.fontSize};
    `,hint:(0,h.css)`
      color: ${a.colors.text.disabled};
      white-space: nowrap;
      cursor: help;
    `});var Ht=s(27218),Kt=s(65354),Ne=s(96305);const Gt=a=>{const{pattern:t,onPatternSelect:n,hasNewQueryOption:l,hasPreviousQuery:r,selectedPatternName:o,setSelectedPatternName:u}=a,i=(0,Z.wW)(Zt),c={grammar:pe.ZP,name:"logql"};return e.createElement(Ne.Z,{className:i.card},e.createElement(Ne.Z.Heading,null,t.name),e.createElement("div",{className:i.rawQueryContainer},e.createElement(ge.U,{query:F.y.renderQuery({labels:[],operations:t.operations}),lang:c,className:i.rawQuery})),e.createElement(Ne.Z.Actions,null,o!==t.name?e.createElement(D.zx,{size:"sm",onClick:()=>{r?u(t.name):n(t)}},"Use this query"):e.createElement(e.Fragment,null,e.createElement("div",{className:i.spacing},`If you would like to use this query, ${l?"you can either replace your current query or create a new query":"your current query will be replaced"}.`),e.createElement(D.zx,{size:"sm",fill:"outline",onClick:()=>u(null)},"Back"),e.createElement(D.zx,{size:"sm",onClick:()=>{n(t)}},"Replace query"),l&&e.createElement(D.zx,{size:"sm",onClick:()=>{n(t,!0)}},"Create new query"))))},Zt=a=>({card:(0,h.css)`
      width: 49.5%;
      display: flex;
      flex-direction: column;
    `,rawQueryContainer:(0,h.css)`
      flex-grow: 1;
    `,rawQuery:(0,h.css)`
      background-color: ${a.colors.background.primary};
      padding: ${a.spacing(1)};
      margin-top: ${a.spacing(1)};
    `,spacing:(0,h.css)`
      margin-bottom: ${a.spacing(1)};
    `}),Xt=a=>{const{isOpen:t,onClose:n,onChange:l,onAddQuery:r,query:o,queries:u,app:i}=a,[c,g]=(0,e.useState)([]),[f,d]=(0,e.useState)(null),y=(0,Z.wW)(Yt),L=!!r,S=(0,e.useMemo)(()=>(0,_._z)(o.expr).query.operations.length>0,[o.expr]),v=(p,m=!1)=>{const b=(0,_._z)(m?"":o.expr);(0,N.ff)("grafana_loki_query_patterns_selected",{version:"v2",app:i??"",editorMode:o.editorMode,selectedPattern:p.name,preSelectedOperationsCount:b.query.operations.length,preSelectedLabelsCount:b.query.labels.length,createNewQuery:L&&m}),b.query.operations=p.operations,L&&m?r({...o,refId:(0,Kt.Hs)(u??[o]),expr:F.y.renderQuery(b.query)}):l({...o,expr:F.y.renderQuery(b.query)}),d(null),n()};return e.createElement(Fe.u,{isOpen:t,title:"Kick start your query",onDismiss:n,className:y.modal},e.createElement("div",{className:y.spacing},"Kick start your query by selecting one of these queries. You can then continue to complete your query."),Object.values(re.Hv).map(p=>e.createElement(Ht.U,{key:p,label:`${(0,R.capitalize)(p)} query starters`,isOpen:c.includes(p),collapsible:!0,onToggle:()=>g(m=>m.includes(p)?m.filter(b=>b!==p):[...m,p])},e.createElement("div",{className:y.cardsContainer},F.y.getQueryPatterns().filter(m=>m.type===p).map(m=>e.createElement(Gt,{key:m.name,pattern:m,hasNewQueryOption:L,hasPreviousQuery:S,onPatternSelect:v,selectedPatternName:f,setSelectedPatternName:d}))))),e.createElement(D.zx,{variant:"secondary",onClick:n},"Close"))},Yt=a=>({cardsContainer:(0,h.css)`
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: space-between;
    `,spacing:(0,h.css)`
      margin-bottom: ${a.spacing(1)};
    `,modal:(0,h.css)`
      width: 85vw;
      ${a.breakpoints.down("md")} {
        width: 100%;
      }
    `});var Jt=s(76621);const qe="LokiQueryEditorModeDefault";function qt(a,t,n){a.expr===""&&window.localStorage.setItem(qe,t),n({...a,editorMode:t})}function _t(a){if(a!=null&&a!=="")return q.c.Code;switch(window.localStorage.getItem(qe)){case"code":return q.c.Code;case"builder":default:return q.c.Builder}}function ea(a){let t=a;return a.editorMode||(t={...a,editorMode:_t(a.expr)}),a.expr==null&&(t={...t,expr:""}),a.queryType==null&&(t={...t,queryType:Jt.EM.Range}),t}var ta=s(74011);function _e(a,t){return!a||!t?!1:(0,ta.v9)(a)?a.isSame(t):a===t}function aa(a,t,n,l,r,o){return t===void 0||a.trim()!==t.trim()||r!==o?!0:!(_e(n?.raw.from,l?.raw.from)&&_e(n?.raw.to,l?.raw.to))}const Me={editor:"loki-editor"},et=e.memo(a=>{const t=(0,e.useId)(),{onChange:n,onRunQuery:l,onAddQuery:r,data:o,app:u,queries:i,datasource:c,range:g}=a,[f,d]=(0,e.useState)(!1),[y,L]=(0,e.useState)(!1),[S,v]=(0,e.useState)(!1),[p,m]=(0,e.useState)(!1),[b,Q]=(0,e.useState)(null),{flag:E,setFlag:J}=(0,we.P5)(we.iS),z=c.predefinedOperations,at=(0,P.Z)(g),C=ea(a.query);W.config.featureToggles.lokiPredefinedOperations&&!C.expr&&z&&(C.expr=`{} ${z}`);const nt=(0,P.Z)(C.expr),st=(0,P.Z)(C.queryType),Oe=C.editorMode,Aa=I=>{J(I.currentTarget.checked)},Ba=(0,e.useCallback)(I=>{if((0,N.ff)("grafana_loki_editor_mode_clicked",{newEditor:I,previousEditor:C.editorMode??"",newQuery:!C.expr,app:u??""}),I===q.c.Builder&&(0,_._z)(C.expr||"").errors.length){d(!0);return}qt(C,I,n)},[n,C,u]);(0,e.useEffect)(()=>{v(!1)},[o]);const De=I=>{(0,R.isEqual)(I,a.query)||v(!0),n(I)},Va=()=>{(0,N.ff)("grafana_loki_label_browser_opened",{app:u}),m(I=>!I)};return(0,e.useEffect)(()=>{aa(C.expr,nt,g,at,C.queryType,st)&&g&&(async()=>{const za=await c.getStats({...C,refId:`${t}_${C.refId}`},g);Q(za)})()},[c,g,at,C,nt,st,Q,t]),e.createElement(e.Fragment,null,e.createElement(ie.s,{isOpen:f,title:"Query parsing",body:"There were errors while trying to parse the query. Continuing to visual builder may lose some parts of the query.",confirmText:"Continue",onConfirm:()=>{n({...C,editorMode:q.c.Builder}),d(!1)},onDismiss:()=>d(!1)}),e.createElement(Xt,{isOpen:y,onClose:()=>L(!1),query:C,queries:i,app:u,onChange:n,onAddQuery:r}),e.createElement(ht,{isOpen:p,datasource:c,query:C,app:u,onClose:()=>m(!1),onChange:De,onRunQuery:l,timeRange:g}),e.createElement(M.K,null,e.createElement(T.K,{gap:1},e.createElement(D.zx,{"data-testid":ae.wl.components.QueryBuilder.queryPatterns,variant:"secondary",size:"sm",onClick:()=>{L(ke=>!ke);const I=(0,_._z)(C.expr||"");(0,N.ff)("grafana_loki_query_patterns_opened",{version:"v2",app:u??"",editorMode:C.editorMode,preSelectedOperationsCount:I.query.operations.length,preSelectedLabelsCount:I.query.labels.length})}},"Kick start your query"),e.createElement(D.zx,{variant:"secondary",size:"sm",onClick:Va,"data-testid":"label-browser-button"},"Label browser")),e.createElement(rt.n,{label:"Explain query",value:E,onChange:Aa}),e.createElement(O.B,{grow:1}),u!==$.zj.Explore&&u!==$.zj.Correlations&&e.createElement(D.zx,{variant:S?"primary":"secondary",size:"sm",onClick:l,icon:o?.state===G.Gu.Loading?"spinner":void 0,disabled:o?.state===G.Gu.Loading},i&&i.length>1?"Run queries":"Run query"),e.createElement(lt.k,{mode:Oe,onChange:Ba})),e.createElement(ve.T,{v:.5}),e.createElement(de._,null,Oe===q.c.Code&&e.createElement(jt,{...a,query:C,onChange:De,showExplain:E}),Oe===q.c.Builder&&e.createElement(Ft,{datasource:a.datasource,query:C,onChange:De,onRunQuery:a.onRunQuery,showExplain:E,timeRange:g}),e.createElement(Ze,{query:C,onChange:n,onRunQuery:l,app:u,maxLines:c.maxLines,queryStats:b})))});et.displayName="LokiQueryEditor";function na(a){const{query:t,data:n,datasource:l,onChange:r,onRunQuery:o,history:u}=a;return e.createElement(Je.n,{datasource:l,query:t,onChange:r,onRunQuery:o,history:u,data:n,placeholder:"Enter a Loki query","data-testid":sa.editor})}const sa={editor:"loki-editor-cloud-alerting"};function la(a){const{app:t}=a;switch(t){case $.zj.CloudAlerting:return e.createElement(na,{...a});default:return e.createElement(et,{...a})}}const ra=(0,e.memo)(la),ja={editor:"loki-editor"};var oa=s(85510),ia=s(60466),ca=s(49875),ua=s(31388),da=s(83717),ma=s(39592),ga=s(41854),oe=s(84655),Pe=s(98463),tt=s(76772),Te=s(5936);function pa({options:a,onOptionsChange:t}){return e.createElement(Pe._,{title:"Alerting",description:e.createElement(Te.W,{description:"Manage alert rules for the Loki data source.",suffix:"loki/configure-loki-data-source/#alerting",feature:"alerting"})},e.createElement(le._,{labelWidth:29,label:"Manage alert rules in Alerting UI",disabled:a.readOnly,tooltip:"Manage alert rules for this data source. To manage other alerting resources, add an Alertmanager data source."},e.createElement(tt.x,{value:a.jsonData.manageAlerts!==!1,onChange:n=>t({...a,jsonData:{...a.jsonData,manageAlerts:n.currentTarget.checked}})})))}var ha=s(81548),fa=s(63908),va=s(85666),Ea=s(28718),ya=s(97402);const ba=a=>{const{derivedFields:t,className:n}=a,[l,r]=(0,e.useState)("");let o=[];return l&&t&&(o=Sa(t,l)),e.createElement("div",{className:n},e.createElement(le._,{label:"Debug log message",labelWidth:24,grow:!0},e.createElement(Ea.K,{type:"text","aria-label":"Prometheus Query",placeholder:"Paste an example log line here to test the regular expressions of your derived fields",value:l,onChange:u=>r(u.currentTarget.value)})),!!o.length&&e.createElement(La,{fields:o}))},La=({fields:a})=>e.createElement("table",{className:"filter-table"},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",null,"Name"),e.createElement("th",null,"Value"),e.createElement("th",null,"Url"))),e.createElement("tbody",null,a.map(t=>{let n=t.value;return t.error&&t.error instanceof Error?n=t.error.message:t.href&&(n=e.createElement("a",{href:t.href},n)),e.createElement("tr",{key:`${t.name}=${t.value}`},e.createElement("td",null,t.name),e.createElement("td",null,n),e.createElement("td",null,t.href?e.createElement("a",{href:t.href},t.href):""))})));function Sa(a,t){return a.filter(n=>n.name&&n.matcherRegex).map(n=>{try{const l=t.match(n.matcherRegex),r=l&&l[1];let o=null;return n.url&&r&&(o=(0,ya.a_)({field:{name:"",type:va.fS.string,values:[r],config:{links:[{title:"",url:n.url}]}},rowIndex:0,range:{}})[0]),{name:n.name,value:r||"<no match>",href:o?o.href:void 0}}catch(l){return{name:n.name,error:l}}})}var Y=s(85765),xa=s(14757),Ca=s(79228);const Na=a=>({row:(0,h.css)`
    display: flex;
    align-items: baseline;
  `,nameField:(0,h.css)`
    flex: 2;
    margin-right: ${a.spacing(.5)};
  `,regexField:(0,h.css)`
    flex: 3;
    margin-right: ${a.spacing(.5)};
  `,urlField:(0,h.css)`
    flex: 1;
    margin-right: ${a.spacing(.5)};
  `,urlDisplayLabelField:(0,h.css)`
    flex: 1;
  `,internalLink:(0,h.css)`
    margin-right: ${a.spacing(1)};
  `,dataSource:(0,h.css)``,nameMatcherField:(0,h.css)({width:a.spacing(20),marginRight:a.spacing(.5)})}),Ma=a=>{const{value:t,onChange:n,onDelete:l,suggestions:r,className:o,validateName:u}=a,i=(0,Z.wW)(Na),[c,g]=(0,e.useState)(!!t.datasourceUid),f=(0,P.Z)(t.datasourceUid),[d,y]=(0,e.useState)(t.matcherType??"regex");(0,e.useEffect)(()=>{!f&&t.datasourceUid&&!c&&g(!0),f&&!t.datasourceUid&&c&&g(!1)},[f,t.datasourceUid,c]);const L=v=>p=>{n({...t,[v]:p.currentTarget.value})},S=!u(t.name);return e.createElement("div",{className:o,"data-testid":"derived-field"},e.createElement("div",{className:"gf-form"},e.createElement(Y.g,{className:i.nameField,label:"Name",invalid:S,error:"The name is already in use"},e.createElement(ne.I,{value:t.name,onChange:L("name"),placeholder:"Field name",invalid:S})),e.createElement(Y.g,{className:i.nameMatcherField,label:e.createElement(he,{label:"Type",content:"Derived fields can be created from labels or by applying a regular expression to the log message."})},e.createElement(te.Ph,{options:[{label:"Regex in log line",value:"regex"},{label:"Label",value:"label"}],value:d,onChange:v=>{(v.value==="label"||v.value==="regex")&&(y(v.value),n({...t,matcherType:v.value}))}})),e.createElement(Y.g,{className:i.regexField,label:e.createElement(e.Fragment,null,d==="regex"&&e.createElement(he,{label:"Regex",content:"Use to parse and capture some part of the log message. You can use the captured groups in the template."}),d==="label"&&e.createElement(he,{label:"Label",content:"Use to derive the field from a label."}))},e.createElement(ne.I,{value:t.matcherRegex,onChange:L("matcherRegex")})),e.createElement(Y.g,{label:""},e.createElement(D.zx,{variant:"destructive",title:"Remove field",icon:"times",onClick:v=>{v.preventDefault(),l()}}))),e.createElement("div",{className:"gf-form"},e.createElement(Y.g,{label:c?"Query":"URL",className:i.urlField},e.createElement(xa.v,{placeholder:c?"${__value.raw}":"http://example.com/${__value.raw}",value:t.url||"",onChange:v=>n({...t,url:v}),suggestions:r})),e.createElement(Y.g,{className:i.urlDisplayLabelField,label:e.createElement(he,{label:"URL Label",content:"Use to override the button label when this derived field is found in a log."})},e.createElement(ne.I,{value:t.urlDisplayLabel,onChange:L("urlDisplayLabel")}))),e.createElement("div",{className:"gf-form"},e.createElement(Y.g,{label:"Internal link",className:i.internalLink},e.createElement(tt.r,{value:c,onChange:v=>{const{checked:p}=v.currentTarget;p||n({...t,datasourceUid:void 0}),g(p)}})),c&&e.createElement(Y.g,{label:"",className:i.dataSource},e.createElement(Ca.q,{tracing:!0,onChange:v=>n({...t,datasourceUid:v.uid}),current:t.datasourceUid,noDefault:!0}))))},he=({content:a,label:t})=>e.createElement(me._,null,t,e.createElement(Xe.u,{placement:"top",content:a,theme:"info"},e.createElement(Ye.J,{tabIndex:0,name:"info-circle",size:"sm",style:{marginLeft:"10px"}}))),Pa=a=>({addButton:(0,h.css)`
    margin-right: 10px;
  `,derivedField:(0,h.css)`
    margin-bottom: ${a.spacing(1)};
  `,container:(0,h.css)`
    margin-bottom: ${a.spacing(4)};
  `,debugSection:(0,h.css)`
    margin-top: ${a.spacing(4)};
  `}),Ta=({fields:a=[],onChange:t})=>{const n=(0,Z.l4)(),l=Pa(n),[r,o]=(0,e.useState)(!1),u=(0,e.useCallback)(i=>a.filter(c=>c.name&&c.name===i).length<=1,[a]);return e.createElement(Pe._,{title:"Derived fields",description:e.createElement(Te.W,{description:"Derived fields can be used to extract new fields from a log message and create a link from its value.",suffix:"loki/configure-loki-data-source/#derived-fields",feature:"derived fields"})},e.createElement("div",{className:l.container},a.map((i,c)=>e.createElement(Ma,{className:l.derivedField,key:c,value:i,onChange:g=>{const f=[...a];f.splice(c,1,g),t(f)},onDelete:()=>{const g=[...a];g.splice(c,1),t(g)},validateName:u,suggestions:[{value:ha.W.valueRaw,label:"Raw value",documentation:"Exact string captured by the regular expression",origin:fa.L8.Value}]})),e.createElement("div",null,e.createElement(D.zx,{variant:"secondary",className:l.addButton,icon:"plus",onClick:i=>{i.preventDefault();const c={name:"",matcherRegex:"",urlDisplayLabel:"",url:"",matcherType:"regex"},g=[...a,c];t(g)}},"Add"),a.length>0&&e.createElement(D.zx,{variant:"secondary",type:"button",onClick:()=>o(!r)},r?"Hide example log message":"Show example log message")),r&&e.createElement("div",{className:l.debugSection},e.createElement(ba,{className:(0,h.css)`
                margin-bottom: 10px;
              `,derivedFields:a}))))};var Qa=s(47701),Oa=s(50248);const Da=a=>{const{maxLines:t,onMaxLinedChange:n,predefinedOperations:l,onPredefinedOperationsChange:r}=a;return e.createElement(Pe._,{title:"Queries",description:e.createElement(Te.W,{description:"Additional options to customize your querying experience.",suffix:"loki/configure-loki-data-source/#queries",feature:"query settings"})},e.createElement(le._,{label:"Maximum lines",htmlFor:"loki_config_maxLines",labelWidth:22,tooltip:e.createElement(e.Fragment,null,"Loki queries must contain a limit of the maximum number of lines returned (default: 1000). Increase this limit to have a bigger result set for ad-hoc analysis. Decrease this limit if your browser becomes sluggish when displaying the log results.")},e.createElement(ne.I,{type:"number",id:"loki_config_maxLines",value:t,onChange:o=>n(o.currentTarget.value),width:16,placeholder:"1000",spellCheck:!1})),W.config.featureToggles.lokiPredefinedOperations&&e.createElement(Qa.Z,null,e.createElement(le._,{label:"Predefined operations",htmlFor:"loki_config_predefinedOperations",labelWidth:22,tooltip:e.createElement(e.Fragment,null,'Predefined operations are used as an initial state for your queries. They are useful, if you want to unpack, parse or format all log lines. Currently we support only log operations starting with |. For example: | unpack | line_format "{{.message}}".')},e.createElement(ne.I,{type:"string",id:"loki_config_predefinedOperations",value:l,onChange:o=>r(o.currentTarget.value),width:40,placeholder:"| unpack | line_format",spellCheck:!1})),e.createElement(le._,null,e.createElement(Oa.C,{text:"Experimental",color:"orange",icon:"exclamation-triangle",tooltip:"Predefined operations is an experimental feature that may change in the future."}))))},Qe=a=>(t,n)=>({...t,jsonData:{...t.jsonData,[a]:n}}),ka=Qe("maxLines"),wa=Qe("predefinedOperations"),Fa=Qe("derivedFields"),Ia=a=>{const{options:t,onOptionsChange:n}=a,l=(0,e.useCallback)(r=>{(0,N.ff)("grafana_loki_predefined_operations_changed",{value:r}),n(wa(t,r))},[t,n]);return e.createElement(e.Fragment,null,e.createElement(oa.j,{dataSourceName:"Loki",docsLink:"https://grafana.com/docs/grafana/latest/datasources/loki/configure-loki-data-source/",hasRequiredFields:!1}),e.createElement(oe.i,null),e.createElement(ia.f,{config:t,onChange:n,urlPlaceholder:"http://localhost:3100"}),e.createElement(oe.i,null),e.createElement(ca.g,{...(0,ua.T2)({config:t,onChange:n})}),e.createElement(oe.i,null),e.createElement(da.K,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!0},e.createElement(ma.a,{config:t,onChange:n}),e.createElement(oe.i,{hideLine:!0}),W.config.secureSocksDSProxyEnabled&&e.createElement(ga.i,{options:t,onOptionsChange:n}),e.createElement(pa,{options:t,onOptionsChange:n}),e.createElement(oe.i,{hideLine:!0}),e.createElement(Da,{maxLines:t.jsonData.maxLines||"",onMaxLinedChange:r=>n(ka(t,r)),predefinedOperations:t.jsonData.predefinedOperations||"",onPredefinedOperationsChange:l}),e.createElement(oe.i,{hideLine:!0}),e.createElement(Ta,{fields:t.jsonData.derivedFields,onChange:r=>n(Fa(t,r))})))};var Ra=s(99820),$a=s(57499);const Ua=new x.hf(Ra.KV).setQueryEditor(ra).setConfigEditor(Ia).setQueryEditorHelp(V);(0,K.N$)().subscribe(j.Pl,$a.uJ)}}]);

//# sourceMappingURL=5890.aeee39fcf36c85c972ad.js.map