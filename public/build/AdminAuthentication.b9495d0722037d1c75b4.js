"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8741],{38738:(ue,P,t)=>{t.r(P),t.d(P,{AuthConfigPageUnconnected:()=>Y,default:()=>ae});var e=t(31733),V=t(55024),U=t(64704),x=t(94746),A=t(41431),h=t(50186),w=t(76932),I=t(76067),v=t(37739),B=t(49311),l=t(36717);const g=()=>{const r=(0,I.wW)(u);return e.createElement("div",{className:r.container},e.createElement(v.K,{gap:1,alignItems:"center"},e.createElement(B.J,{name:"cog"}),e.createElement(l.x,null,"Configuration required")),e.createElement(l.x,{variant:"bodySmall",color:"secondary"},"You have no authentication configuration created at the moment."),e.createElement(x.h,{href:"https://grafana.com/docs/grafana/latest/auth/overview/",external:!0},"Refer to the documentation on how to configure authentication"))},u=r=>({container:(0,w.css)({display:"flex",flexDirection:"column",gap:r.spacing(2),backgroundColor:r.colors.background.secondary,borderRadius:r.shape.radius.default,padding:r.spacing(3),width:"max-content",margin:r.spacing(3,"auto")})}),E=g;var z=t(7820),c=t(96305),G=t(50248);const J="admin/authentication/";function Q(r){return J+(r.configPath||`advanced/${r.id}`)}const _={github:["github","GitHub"],gitlab:["gitlab","GitLab"],google:["google","Google"],generic_oauth:["lock","Generic OAuth"],grafana_com:["grafana","Grafana.com"],azuread:["microsoft","Azure AD"],okta:["okta","Okta"]};function ee({providerId:r,enabled:C,configPath:p,authType:y,onClick:k}){const O=Q({configPath:p,id:r}),[D,M]=_[r]||["lock",r.toUpperCase()];return e.createElement(c.Z,{href:O,onClick:k},e.createElement(c.Z.Heading,null,M),e.createElement(c.Z.Meta,null,y),(0,z.Mo)(D)&&e.createElement(c.Z.Figure,null,e.createElement(B.J,{name:D,size:"xxxl"})),e.createElement(c.Z.Actions,null,e.createElement(G.C,{text:C?"Enabled":"Not enabled",color:C?"green":"blue"})))}var W=t(16011),te=t(65824);function K(r){const{isLoading:C,providerStatuses:p,providers:y}=r.authConfig;return{isLoading:C,providerStatuses:p,providers:y}}const X={loadSettings:W.ri},ne=(0,V.connect)(K,X),Y=({providerStatuses:r,isLoading:C,loadSettings:p,providers:y})=>{(0,e.useEffect)(()=>{p()},[p]);const O=(0,te.getRegisteredAuthProviders)().filter(d=>!r[d.id]?.hide),D=d=>{(0,U.ff)("authentication_ui_provider_clicked",{provider:d})},M=O.length?[...O.map(d=>({provider:d.id,settings:{...r[d.id],configPath:d.configPath,type:d.type}})),...y]:y;return e.createElement(h.T,{navId:"authentication",subTitle:e.createElement(e.Fragment,null,"Manage your auth settings and configure single sign-on. Find out more in our"," ",e.createElement(x.h,{href:"https://grafana.com/docs/grafana/next/setup-grafana/configure-security/configure-authentication"},"documentation"),".")},e.createElement(h.T.Contents,{isLoading:C},M.length?e.createElement(A.r,{gap:3,minColumnWidth:34},M.filter(({provider:d})=>!["grafana_com","generic_oauth"].includes(d)).map(({provider:d,settings:N})=>e.createElement(ee,{key:d,authType:N.type||"OAuth",providerId:d,enabled:N.enabled,onClick:()=>D(d),configPath:N.configPath}))):e.createElement(E,null)))},ae=ne(Y)},44403:(ue,P,t)=>{t.r(P),t.d(P,{ProviderConfigPage:()=>de,default:()=>fe});var e=t(31733),V=t(55024),U=t(50186),x=t(54126),A=t(56821),h=t(1727),w=t(19690),I=t(69391),v=t(85765),B=t(64516),l=t(32901),g=t(33904),u=t(38834),E=t(37739),z=t(76772),c=t(51343),G=t(76932),J=t(97890),Q=t(5572);const _=({confirmRedirect:n,onDiscard:a,onLocationChange:i})=>{const[m,f]=(0,e.useState)(!1),[L,F]=(0,e.useState)(null),[q,re]=(0,e.useState)(!1);(0,e.useEffect)(()=>{const S=b=>{n&&(b.preventDefault(),b.returnValue="")};return window.addEventListener("beforeunload",S),()=>{window.removeEventListener("beforeunload",S)}},[n]);const $=S=>{const b=window.location.pathname,le=S.pathname;if(b===le)return!0;const j=i?.(S);let Z=n&&!q;return j!==void 0&&(Z=Z&&j),Z?(f(!0),F(S),!1):(j&&a(),!0)},oe=()=>{f(!1),F(null)},se=()=>{f(!1),re(!0),a()};return e.createElement(e.Fragment,null,e.createElement(J.NL,{when:!0,message:$}),L&&q&&e.createElement(J.l_,{to:L}),e.createElement(ee,{isOpen:m,onDiscard:se,onBackToForm:oe}))},ee=({onDiscard:n,onBackToForm:a,isOpen:i})=>e.createElement(Q.u,{isOpen:i,title:"Leave page?",onDismiss:a,icon:"exclamation-triangle",className:(0,G.css)({width:"500px"})},e.createElement("h5",null,"Changes that you made may not be saved."),e.createElement(Q.u.ButtonRow,null,e.createElement(c.zx,{variant:"secondary",onClick:a,fill:"outline"},"Continue editing"),e.createElement(c.zx,{variant:"destructive",onClick:n},"Discard unsaved changes")));function W(n){return Array.isArray(n)&&n.every(a=>typeof a=="object"&&a!==null&&"value"in a)}const te={github:["clientId","clientSecret","teamIds","allowedOrganizations"],google:["clientId","clientSecret","allowedDomains"],gitlab:["clientId","clientSecret","allowedOrganizations","teamIds"],azuread:["clientId","clientSecret","authUrl","tokenUrl","scopes","allowedGroups","allowedDomains"],okta:["clientId","clientSecret","authUrl","tokenUrl","apiUrl","roleAttributePath","allowedGroups","allowedDomains"]},K={clientId:{label:"Client Id",type:"text",validation:{required:!0,message:"This field is required"}},clientSecret:{label:"Client Secret",type:"secret"},teamIds:{label:"Team Ids",type:"select",multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter team IDs and press Enter to add",validation:{validate:n=>typeof n=="string"?X(n):W(n)?n.every(a=>a?.value&&X(a.value)):!0,message:"Team ID must be a number."}},allowedOrganizations:{label:"Allowed Organizations",type:"select",multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter organizations (my-team, myteam...) and press Enter to add"},allowedDomains:{label:"Allowed Domains",type:"select",multi:!0,allowCustomValue:!0,options:[]},authUrl:{label:"Auth Url",type:"text",validation:{required:!1}},tokenUrl:{label:"Token Url",type:"text",validation:{required:!1}},scopes:{label:"Scopes",type:"select",multi:!0,allowCustomValue:!0,options:[]},allowedGroups:{label:"Allowed Groups",type:"select",multi:!0,allowCustomValue:!0,options:[]},apiUrl:{label:"API Url",type:"text",validation:{required:!1}},roleAttributePath:{label:"Role Attribute Path",type:"text",validation:{required:!1}}};function X(n){return/^-?\d+$/.test(n)}const ne={allowAssignGrafanaAdmin:!1,allowSignUp:!1,allowedDomains:[],allowedGroups:[],allowedOrganizations:[],apiUrl:"",authStyle:"",authUrl:"",autoLogin:!1,clientId:"",clientSecret:"",emailAttributeName:"",emailAttributePath:"",emptyScopes:!1,enabled:!1,extra:{},groupsAttributePath:"",hostedDomain:"",icon:"shield",name:"",roleAttributePath:"",roleAttributeStrict:!1,scopes:[],signoutRedirectUrl:"",skipOrgRoleSync:!1,teamIds:[],teamIdsAttributePath:"",teamsUrl:"",tlsClientCa:"",tlsClientCert:"",tlsClientKey:"",tlsSkipVerify:!1,tokenUrl:"",type:"",usePKCE:!1,useRefreshToken:!1},Y=n=>n?.length?Array.isArray(n)?n.map(a=>({label:a,value:a})):n.split(/[\s,]/).map(a=>({label:a,value:a})):[];function ae(n){if(!n)return ne;const a=p(K),i={...n.settings};for(const m of a)i[m]=Y(i[m]);return i}const r=n=>n.map(({value:a})=>a).join(",");function C(n){const a=p(K),i={...n};for(const m of a){const f=n[m];f&&W(f)&&(i[m]=r(f))}return i}function p(n){return Object.entries(n).filter(([a,i])=>i.type==="select"&&i.multi===!0).map(([a])=>a)}const y=(0,h.N$)(),k=({config:n,provider:a,isLoading:i})=>{const{register:m,handleSubmit:f,control:L,reset:F,watch:q,setValue:re,formState:{errors:$,dirtyFields:oe,isSubmitted:se}}=(0,x.cI)({defaultValues:ae(n)}),[S,b]=(0,e.useState)(!1),[le,j]=(0,e.useState)(!!n?.settings.clientSecret),Z=te[a],[he,me]=(0,e.useState)(!1),ie=se&&!he;(0,e.useEffect)(()=>{ie&&w.E1.push("/admin/authentication")},[ie]);const ve=async o=>{b(!0),me(!1);const s=C(o);try{await(0,I.i)().put(`/api/v1/sso-settings/${a}`,{...n,settings:{...n?.settings,...s}}),y.publish({type:A.SI.alertSuccess.name,payload:["Settings saved"]})}catch(T){let R="";(0,I.kW)(T)?R=T.data.message:T instanceof Error&&(R=T.message),y.publish({type:A.SI.alertError.name,payload:[R]}),me(!0)}finally{b(!1)}},Ee=(o,s)=>{switch(s.type){case"text":return e.createElement(v.g,{label:s.label,required:!!s.validation?.required,invalid:!!$[o],error:s.validation?.message,key:o},e.createElement(B.I,{...m(o,{required:!!s.validation?.required}),type:s.type,id:o,autoComplete:"off"}));case"secret":return e.createElement(v.g,{label:s.label,required:!!s.validation?.required,invalid:!!$[o],error:s.validation?.message,key:o,htmlFor:o},e.createElement(l.g,{name:o,control:L,rules:s.validation,render:({field:{ref:pe,value:H,...ce}})=>e.createElement(g.m4,{...ce,autoComplete:"off",id:o,value:typeof H=="string"?H:"",isConfigured:le,onReset:()=>{j(!1),re(o,"")}})}));case"select":const T=q(o),R=W(T)?T:[{label:"",value:""}];return e.createElement(v.g,{label:s.label,htmlFor:o,key:o,invalid:!!$[o],error:s.validation?.message},e.createElement(l.g,{rules:s.validation,name:o,control:L,render:({field:{ref:pe,onChange:H,...ce},fieldState:{invalid:ye}})=>e.createElement(u.Ph,{...ce,placeholder:s.placeholder,isMulti:s.multi,invalid:ye,inputId:o,options:R,allowCustomValue:!0,onChange:H,onCreateOption:ge=>{const Ce={value:ge,label:ge};H([...R,Ce])}})}));default:throw new Error(`Unknown field type: ${s.type}`)}};return e.createElement(U.T.Contents,{isLoading:i},e.createElement(E.K,{grow:1,direction:"column"},e.createElement("form",{onSubmit:f(ve),style:{maxWidth:"600px"}},e.createElement(e.Fragment,null,e.createElement(_,{confirmRedirect:!!Object.keys(oe).length&&!ie,onDiscard:()=>{F()}}),e.createElement(v.g,{label:"Enabled"},e.createElement(z.r,{...m("enabled"),id:"enabled",label:"Enabled"})),Z.map(o=>{const s=K[o];return Ee(o,s)}),e.createElement(E.K,{gap:2},e.createElement(v.g,null,e.createElement(c.zx,{type:"submit"},S?"Saving...":"Save")),e.createElement(v.g,null,e.createElement(c.Qj,{href:"/admin/authentication",variant:"secondary"},"Discard")))))))};var O=t(16011);const D=n=>n?{text:n.settings.name||"",subTitle:`To configure ${n.settings.name} OAuth2 you must register your application with ${n.settings.name}. ${n.settings.name} will generate a Client ID and Client Secret for you to use.`,icon:n.settings.icon||"shield",id:n.provider}:{text:"Authentication",subTitle:"Configure authentication providers",icon:"shield",id:"authentication"};function M(n,a){const{isLoading:i,providers:m}=n.authConfig,{provider:f}=a.match.params;return{config:m.find(F=>F.provider===f),isLoading:i,provider:f}}const d={loadProviders:O.Ct},N=(0,V.connect)(M,d),de=({config:n,loadProviders:a,isLoading:i,provider:m})=>{const f=D(n);return(0,e.useEffect)(()=>{a(m)},[a,m]),n?e.createElement(U.T,{navId:"authentication",pageNav:f},e.createElement(k,{config:n,isLoading:i,provider:m})):null},fe=N(de)},16011:(ue,P,t)=>{t.d(P,{Ct:()=>I,ri:()=>w});var e=t(69391),V=t(85498),U=t(75923),x=t(42342),A=t(65824),h=t(82412);function w(){return async l=>{if(U.Vt.hasPermission(x.AccessControlAction.SettingsRead)){l((0,h.uX)()),l(I());const g=await(0,e.i)().get("/api/admin/settings");return l((0,h.AW)(g)),await l(v()),l((0,h._E)()),g}}}function I(l=""){return async g=>{if(!V.config.featureToggles.ssoSettingsApi)return[];const u=await(0,e.i)().get(`/api/v1/sso-settings${l?`/${l}`:""}`);return g((0,h.sg)(l?[u]:u)),u}}function v(){return async l=>{const g=(0,A.getRegisteredAuthProviders)(),u={},E=[];for(const c of g)E.push((0,A.getAuthProviderStatus)(c.id));const z=await Promise.all(E);for(let c=0;c<g.length;c++){const G=g[c];u[G.id]=z[c]}l((0,h.AB)(u))}}function B(l){return async g=>{if(contextSrv.hasPermission(AccessControlAction.SettingsWrite))try{return await lastValueFrom(getBackendSrv().fetch({url:"/api/admin/settings",method:"PUT",data:l,showSuccessAlert:!1,showErrorAlert:!1})),g(resetError()),!0}catch(u){if(console.log(u),isFetchError(u)){u.isHandled=!0;const E={message:u.data?.message,errors:u.data?.errors};return g(setError(E)),!1}}return!1}}}}]);

//# sourceMappingURL=AdminAuthentication.b9495d0722037d1c75b4.js.map