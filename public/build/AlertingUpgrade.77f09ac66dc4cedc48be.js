"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9027],{3663:(Z,U,s)=>{s.r(U),s.d(U,{UpgradePage:()=>le,UpgradeTabs:()=>se,default:()=>ke,getStyles:()=>B});var i=s(76932),C=s(20670),S=s(7261),v=s(69781),$=s(86504),D=s.n($),e=s(31733),W=s(97890),w=s(50370),R=s(21568),m=s(17302),E=s(19690),I=s(25111),A=s(76067),F=s(94746),J=s(88062),V=s(4981),H=s(31805),P=s(51343),pe=s(90069),Y=s(36717),fe=s(53567),L=s(58037),x=s(49311),N=s(50248),G=s(34037),_=s(89719),he=s(76804),Ee=s(60196),ye=s(79106),Ce=s(61375),ae=s(50186),ve=s(297),be=s(41273),Q=s(69391),p=s(42876),f=s(43025),we=s(68568);function j(a){return typeof a=="object"&&a!=null&&"error"in a}const b=we.C.injectEndpoints({endpoints:a=>({upgradeChannel:a.mutation({query:({channelId:n,skipExisting:l})=>({url:`/api/v1/upgrade/channels/${n}${l?"?skipExisting=true":""}`,method:"POST",showSuccessAlert:!1,showErrorAlert:!1}),invalidatesTags:["OrgMigrationState"],async onQueryStarted({channelId:n},{dispatch:l,queryFulfilled:t}){try{l(b.util.updateQueryData("getOrgUpgradeSummary",void 0,o=>{const d=(o.migratedChannels??[]).findIndex(g=>g.legacyChannel?.id===n);d!==-1&&(o.migratedChannels[d].isUpgrading=!0)}));const{data:r}=await t;r.hasErrors?l((0,f.$l)((0,p.ZR)(`Failed to upgrade notification channel '${n}'`))):r.removed?l((0,f.$l)((0,p.AT)(`Notification channel '${n}' not found, removed from list of upgrades`))):l((0,f.$l)((0,p.AT)(`Upgraded notification channel '${n}'`)))}catch(r){j(r)&&(0,Q.kW)(r.error)?l((0,f.$l)((0,p.t_)("Request failed",r.error.data.message))):l((0,f.$l)((0,p.t_)("Request failed")))}}}),upgradeAllChannels:a.mutation({query:({skipExisting:n})=>({url:`/api/v1/upgrade/channels${n?"?skipExisting=true":""}`,method:"POST",showSuccessAlert:!1,showErrorAlert:!1}),invalidatesTags:["OrgMigrationState"],async onQueryStarted({skipExisting:n},{dispatch:l,queryFulfilled:t}){try{const{data:r}=await t;r.hasErrors?l((0,f.$l)((0,p.ZR)(`Issues while upgrading ${r.newChannels} ${n?"new ":""}notification channels`))):l((0,f.$l)((0,p.AT)(`Upgraded ${r.newChannels} ${n?"new ":""}notification channels`)))}catch(r){j(r)&&(0,Q.kW)(r.error)?l((0,f.$l)((0,p.t_)("Request failed",r.error.data.message))):l((0,f.$l)((0,p.t_)("Request failed")))}}}),upgradeAlert:a.mutation({query:({dashboardId:n,panelId:l,skipExisting:t})=>({url:`/api/v1/upgrade/dashboards/${n}/panels/${l}${t?"?skipExisting=true":""}`,method:"POST",showSuccessAlert:!1,showErrorAlert:!1}),invalidatesTags:["OrgMigrationState"],async onQueryStarted({dashboardId:n,panelId:l},{dispatch:t,queryFulfilled:r}){try{t(b.util.updateQueryData("getOrgUpgradeSummary",void 0,d=>{const g=(d.migratedDashboards??[]).findIndex(u=>u.dashboardId===n);if(g!==-1){const u=(d.migratedDashboards[g]?.migratedAlerts??[]).findIndex(T=>T.legacyAlert?.panelId===l);u!==-1&&(d.migratedDashboards[g].migratedAlerts[u].isUpgrading=!0)}}));const{data:o}=await r;o.hasErrors?t((0,f.$l)((0,p.ZR)(`Failed to upgrade alert from dashboard '${n}', panel '${l}'`))):o.removed?t((0,f.$l)((0,p.AT)(`Alert from dashboard '${n}', panel '${l}' not found, removed from list of upgrades`))):t((0,f.$l)((0,p.AT)(`Upgraded alert from dashboard '${n}', panel '${l}'`)))}catch(o){j(o)&&(0,Q.kW)(o.error)?t((0,f.$l)((0,p.t_)("Request failed",o.error.data.message))):t((0,f.$l)((0,p.t_)("Request failed")))}}}),upgradeDashboard:a.mutation({query:({dashboardId:n,skipExisting:l})=>({url:`/api/v1/upgrade/dashboards/${n}${l?"?skipExisting=true":""}`,method:"POST",showSuccessAlert:!1,showErrorAlert:!1}),invalidatesTags:["OrgMigrationState"],async onQueryStarted({dashboardId:n,skipExisting:l},{dispatch:t,queryFulfilled:r}){try{t(b.util.updateQueryData("getOrgUpgradeSummary",void 0,d=>{const g=(d.migratedDashboards??[]).findIndex(u=>u.dashboardId===n);g!==-1&&(d.migratedDashboards[g].isUpgrading=!0)}));const{data:o}=await r;o.hasErrors?t((0,f.$l)((0,p.ZR)(`Issues while upgrading ${o.newAlerts} ${l?"new ":""}alerts from dashboard '${n}'`))):o.removed?t((0,f.$l)((0,p.AT)(`Dashboard '${n}' not found, removed from list of upgrades`))):t((0,f.$l)((0,p.AT)(`Upgraded ${o.newAlerts} ${l?"new ":""}alerts from dashboard '${n}'`)))}catch(o){j(o)&&(0,Q.kW)(o.error)?t((0,f.$l)((0,p.t_)("Request failed",o.error.data.message))):t((0,f.$l)((0,p.t_)("Request failed")))}}}),upgradeAllDashboards:a.mutation({query:({skipExisting:n})=>({url:`/api/v1/upgrade/dashboards${n?"?skipExisting=true":""}`,method:"POST",showSuccessAlert:!1,showErrorAlert:!1}),invalidatesTags:["OrgMigrationState"],async onQueryStarted({skipExisting:n},{dispatch:l,queryFulfilled:t}){try{const{data:r}=await t;r.hasErrors?l((0,f.$l)((0,p.ZR)(`Issues while upgrading ${r.newAlerts} ${n?"new ":""}alerts in ${r.newDashboards} dashboards`))):l((0,f.$l)((0,p.AT)(`Upgraded ${r.newAlerts} ${n?"new ":""}alerts in ${r.newDashboards} dashboards`)))}catch(r){j(r)&&(0,Q.kW)(r.error)?l((0,f.$l)((0,p.t_)("Request failed",r.error.data.message))):l((0,f.$l)((0,p.t_)("Request failed")))}}}),upgradeOrg:a.mutation({query:({skipExisting:n})=>({url:`/api/v1/upgrade/org${n?"?skipExisting=true":""}`,method:"POST",showSuccessAlert:!1,showErrorAlert:!1}),invalidatesTags:["OrgMigrationState"],async onQueryStarted({skipExisting:n},{dispatch:l,getCacheEntry:t,queryFulfilled:r}){try{const{data:o}=await r;o.hasErrors?l((0,f.$l)((0,p.ZR)(`Issues while upgrading ${o.newAlerts} ${n?"new ":""}alerts in ${o.newDashboards} dashboards and ${o.newChannels} ${n?"new ":""}notification channels`))):l((0,f.$l)((0,p.AT)(`Upgraded ${o.newAlerts} ${n?"new ":""}alerts in ${o.newDashboards} dashboards and ${o.newChannels} ${n?"new ":""}notification channels`)))}catch(o){j(o)&&(0,Q.kW)(o.error)?l((0,f.$l)((0,p.t_)("Request failed",o.error.data.message))):l((0,f.$l)((0,p.t_)("Request failed")))}}}),cancelOrgUpgrade:a.mutation({query:()=>({url:"/api/v1/upgrade/org",method:"DELETE"}),invalidatesTags:["OrgMigrationState"],async onQueryStarted(n,{dispatch:l}){try{l(b.util.updateQueryData("getOrgUpgradeSummary",n,t=>{Object.assign(t,{orgId:0,migratedDashboards:[],migratedChannels:[],errors:[]})}))}catch{}}}),getOrgUpgradeSummary:a.query({query:()=>({url:"/api/v1/upgrade/org"}),providesTags:["OrgMigrationState"],transformResponse:n=>(n.migratedDashboards=n.migratedDashboards??[],n.migratedChannels=n.migratedChannels??[],n.errors=n.errors??[],n.migratedDashboards.forEach(l=>{l.migratedAlerts=l.migratedAlerts??[],l.error=l.error??"",l.warning=l.warning??"",l.migratedAlerts.sort((t,r)=>{const o=(r.error??"").localeCompare(t.error??"");return o!==0?o:(t.legacyAlert?.name??"").localeCompare(r.legacyAlert?.name??"")})}),n.migratedDashboards.sort((l,t)=>{const r=(t.error??"").localeCompare(l.error??"");if(r!==0)return r;const o=t.migratedAlerts.filter(u=>u.error).length-l.migratedAlerts.filter(u=>u.error).length;if(o!==0)return o;const d=(t.warning??"").localeCompare(l.warning??"");if(d!==0)return d;const g=l.folderName.localeCompare(t.folderName);return g!==0?g:l.dashboardName.localeCompare(t.dashboardName)}),n.migratedChannels.sort((l,t)=>{const r=(t.error?1:0)-(l.error?1:0);return r!==0?r:(l.legacyChannel?.name??"").localeCompare(t.legacyChannel?.name??"")}),n)})})});var re=s(25899),ne=s(78770),Ae=s(86963),z=s(74086),X=s(66172),ee=s(99825);const le=()=>{const{useGetOrgUpgradeSummaryQuery:a}=b,{currentData:n,isError:l,error:t}=a(void 0,{pollingInterval:1e4}),r=(n?.migratedDashboards??[]).reduce((T,K)=>T+(K?.migratedAlerts?.length??0),0),o=n?.migratedChannels?.length??0,d=n?.errors??[],g=r>0||o>0||d.length>0,u=(0,e.useMemo)(()=>!l&&g?e.createElement(xe,null):null,[l,g]);return e.createElement(ae.T,{navId:"alerting-upgrade",actions:u},e.createElement(ae.T.Contents,null,l&&e.createElement(I.b,{severity:"error",title:"Error loading Grafana Alerting upgrade information"},t instanceof Error?t.message:"Unknown error."),!l&&!g&&e.createElement(Ne,null),!l&&g&&e.createElement(e.Fragment,null,e.createElement(Ke,{errors:d}),e.createElement(se,{alertCount:r,contactCount:o}))))},se=({alertCount:a,contactCount:n})=>{const l=(0,A.wW)(B),[t,r]=(0,ve.K)(),{tab:o}=Ie(t),[d,g]=(0,e.useState)(o);return(0,e.useEffect)(()=>{g(o)},[o]),e.createElement(e.Fragment,null,e.createElement(I.b,{severity:"info",title:"Grafana Alerting upgrade guide"},e.createElement("p",null,"Preview of how your existing alert rules and notification channels wll be upgraded to the new Grafana Alerting.",e.createElement("br",null),"Once you are happy with the results, you can permanently upgrade by modifying the Grafana configuration."),e.createElement("p",null,"For more information, please refer to the ",e.createElement(F.h,{external:!0,href:"https://grafana.com/docs/grafana/latest/alerting/set-up/migrating-alerts/"},"Grafana Alerting Migration Guide"))),e.createElement(J.J,null,e.createElement(V.O,{label:"Upgraded alert rules",active:d==="alerts",counter:a,icon:"bell",onChangeTab:()=>{g("alerts"),r({tab:"alerts"})}}),e.createElement(V.O,{label:"Upgraded notification channels",active:d==="contacts",counter:n,icon:"at",onChangeTab:()=>{g("contacts"),r({tab:"contacts"})}})),e.createElement(H.I,{className:l.tabContent},e.createElement(e.Fragment,null,d==="alerts"&&e.createElement(ie,null),d==="contacts"&&e.createElement(ce,null))))},xe=()=>{const a=(0,A.wW)(B),[n]=b.useCancelOrgUpgradeMutation({fixedCacheKey:"cancel-org-upgrade-loading"}),[l,t]=(0,e.useState)(!1),r=async()=>{n(),t(!1)};return e.createElement(e.Fragment,null,e.createElement(P.zx,{size:"md",variant:"destructive",onClick:()=>t(!0),icon:"trash-alt",className:""},"Cancel upgrade"),l&&e.createElement(pe.s,{isOpen:!0,title:"Cancel upgrade",body:e.createElement(m.K,{direction:"column",gap:.5},e.createElement(Y.x,{color:"primary"},"All new Grafana Alerting resources will be deleted."),e.createElement(Y.x,{color:"secondary",variant:"bodySmall"},"This includes: alert rules, contact points, notification policies, silences, mute timings, and any manual changes you have made."),e.createElement("span",{className:a.separator}),e.createElement(Y.x,{color:"primary"},"No legacy alerts or notification channels will be affected.")),confirmText:"Cancel upgrade",onConfirm:r,dismissText:"Keep reviewing",onDismiss:()=>t(!1)}))};var $e=(a=>(a.Alerts="alerts",a.Contacts="contacts",a))($e||{});function Ie(a){let n="alerts";return a.tab==="alerts"&&(n="alerts"),a.tab==="contacts"&&(n="contacts"),{tab:n}}const Ne=()=>{const a=(0,A.wW)(oe),{useUpgradeOrgMutation:n}=b,[l,{isLoading:t}]=n({fixedCacheKey:"upgrade-org-loading"}),[,{isLoading:r}]=b.useCancelOrgUpgradeMutation({fixedCacheKey:"cancel-org-upgrade-loading"}),o=t||r,d=async()=>{await l({skipExisting:!1})};if(o)return e.createElement(me,{text:r?"Cancelling upgrade...":"Upgrade in progress..."});const g=e.createElement(e.Fragment,null,e.createElement("span",{key:"proTipFooter"},e.createElement("p",null,"Note:"," ","Previewing the upgrade process will not affect your existing legacy alerts and can be stopped at any time."))),u=e.createElement("div",null,e.createElement(m.K,{direction:"column",gap:1},e.createElement(m.K,{direction:"row",gap:1},e.createElement(P.zx,{size:"lg",variant:"primary",onClick:d,icon:"bell",className:"","data-testid":R.wl.components.CallToActionCard.buttonV2("Preview upgrade")},"Preview upgrade"))));return e.createElement("div",{className:a.grid},e.createElement(te,{className:a.processBlock},e.createElement("h3",{className:a.header},"How it works"),e.createElement(m.K,{direction:"column",alignItems:"space-between"},e.createElement("div",{className:a.list},e.createElement("h4",null,"Automatic Upgrade"),e.createElement("div",{className:a.step},e.createElement("p",null,"The upgrade process seamlessly transfers your existing legacy alert rules and notification channels to the new Grafana Alerting system. This means your alerting configurations are preserved during the transition.")),e.createElement("h4",null,"Preview and Modification"),e.createElement("div",{className:a.step},e.createElement("p",null,"Alert Rules, Contact Points, and Notification Policies generated during the upgrade are available for your review and potential adjustments. However, please note that they won't actively trigger alerts or send notifications at this stage.")),e.createElement("h4",null,"Limitations on Real-Time Updates"),e.createElement("div",{className:a.step},e.createElement("p",null,"Any changes made to your configurations after initiating the upgrade won't be immediately reflected in the summary table. You have the flexibility to re-upgrade specific resources like dashboards, alert rules, and notification channels at any time.")),e.createElement("h4",null,"Cancellation and Restart"),e.createElement("div",{className:a.step},e.createElement("p",null,"If necessary, you can cancel and restart the upgrade process. However, it's important to be aware that canceling the upgrade will result in the removal of all Grafana Alerting resources created during the process, including any manual modifications.")),e.createElement("h4",null,"Completing the Upgrade"),e.createElement("div",{className:a.step},e.createElement("p",null,"To enable Grafana Alerting, you'll need to modify the Grafana configuration and restart. Until this step is completed, Grafana Alerting will remain inactive."))))),e.createElement(te,{className:a.getStartedBlock},e.createElement("h3",{className:a.header},"Get started"),e.createElement(m.K,{direction:"column",alignItems:"space-between"},e.createElement("div",{className:a.list},e.createElement("h4",null,"Step 1: Preview the Upgrade"),e.createElement("div",{className:a.step},e.createElement("p",null,'Start the upgrade process by clicking on "Preview upgrade." This action will display a summary table showing how your existing alert rules and notification channels will be mapped to resources in the new Grafana Alerting system.')),e.createElement("h4",null,"Step 2: Investigate and Resolve Errors"),e.createElement("div",{className:a.step},e.createElement("p",null,"Review the previewed upgrade carefully. Alert rules or notification channels that couldn't be automatically upgraded will be marked as errors. You have two options to address these errors:"),e.createElement("ul",{className:a.list},e.createElement("li",null,"Fix the issues on the legacy side: If possible, resolve the problems within your legacy alerting setup, and then attempt the upgrade again."),e.createElement("li",null,"Manually create new resources: If fixing legacy issues isn't feasible, manually create new alert rules, notification policies, or contact points in the new Grafana Alerting system to replace the problematic ones."))),e.createElement("h4",null,"Step 3: Update Your As-Code Setup (Optional)"),e.createElement("div",{className:a.step},e.createElement("p",null,"In the new Grafana Alerting, Legacy Alerting methods of provisioning will no longer work. If you use provisioning to manage alert rules and notification channels, you can export the upgraded versions to generate Grafana Alerting-compatible provisioning files. This can all be done before completeing the upgrade process.")),e.createElement("h4",null,"Step 4: Perform the Upgrade to Grafana Alerting"),e.createElement("div",{className:a.step},e.createElement("p",null,"Once you are satisfied with the state of your Grafana Alerting setup, it's time to proceed with the upgrade:"),e.createElement("ul",{className:a.list},e.createElement("li",null,"Contact your Grafana server administrator to restart Grafana with the [unified_alerting] section enabled in your configuration."),e.createElement("li",null,"During this process, all organizations that have undergone the above upgrade process will continue to use their configured setup."),e.createElement("li",null,"Any organization that has not yet started the upgrade process will be automatically upgraded as part of this restart."),e.createElement("li",null,"Note: If the automatic upgrade fails for any reason, Grafana will not start, so it's safer to address any issues before initiating this step.")))),e.createElement(m.K,{direction:"row",alignItems:"center",gap:.5},e.createElement(Y.x,{color:"secondary"},"For more information, please refer to the"),e.createElement(F.h,{external:!0,href:"https://grafana.com/docs/grafana/latest/alerting/set-up/migrating-alerts/"},"Grafana Alerting Migration Guide")))),e.createElement(te,{className:a.ctaBlock},e.createElement(fe._,{className:a.ctaStyle,message:"Start the upgrade to the new Grafana Alerting.",footer:g,callToActionElement:u})))};function te({children:a,className:n}){const l=(0,A.wW)(oe);return e.createElement("div",{className:(0,i.cx)(l.box,n)},a)}const oe=a=>{const n=a.colors.warning;return{box:(0,i.css)({padding:a.spacing(2),backgroundColor:a.colors.background.secondary,borderRadius:a.shape.radius.default}),warningIcon:(0,i.css)({color:n.text}),grid:(0,i.css)({display:"grid",gridTemplateRows:"min-content auto auto",gridTemplateColumns:"1fr 1fr 1fr 1fr 1fr",gap:a.spacing(2)}),list:(0,i.css)({margin:`${a.spacing(0)} ${a.spacing(2)}`,"& > li":{marginBottom:a.spacing(1)}}),ctaStyle:(0,i.css)({textAlign:"center"}),processBlock:(0,i.css)({gridColumn:"1 / span 2",justifyContent:"space-between"}),getStartedBlock:(0,i.css)({gridColumn:"3 / span 3",justifyContent:"space-between"}),ctaBlock:(0,i.css)({gridColumn:"1 / span 5"}),header:(0,i.css)({marginBottom:a.spacing(2)}),step:(0,i.css)({paddingLeft:a.spacing(2)})}},ie=()=>{const a=De(),n="alertFilter",[l,t]=de(n),[r,{isLoading:o}]=b.useUpgradeAllDashboardsMutation({fixedCacheKey:"upgrade-alerts-loading"}),[d,{isLoading:g}]=b.useUpgradeAllChannelsMutation({fixedCacheKey:"upgrade-channels-loading"}),u=g||o,T=(0,e.useMemo)(()=>{const y=[];return(0,S.P1)(O=>O?.migratedDashboards??[],O=>O??y)},[]),{items:K}=b.useGetOrgUpgradeSummaryQuery(void 0,{selectFromResult:({data:y})=>({items:T(y)})}),k=(0,e.useCallback)(y=>`${y.folderName} ${y.dashboardName} ${y.newFolderName} ${y.migratedAlerts.map(O=>O.legacyAlert?.name??"").join(" ")}`,[]),c=(0,e.useCallback)(({data:y})=>e.createElement(Le,{dashboardUid:y.dashboardUid??"",dashboardId:y.dashboardId,showGuidelines:!0}),[]),h=(0,e.useMemo)(()=>{const y=async()=>{await r({skipExisting:!0})};return e.createElement(L.u,{theme:"info-alt",content:u?"Upgrade in progress...":"Upgrade all newly created legacy alerts since the previous run.",placement:"top"},e.createElement(P.zx,{size:"md",variant:"secondary",onClick:y,icon:"plus-circle",disabled:u},"Upgrade New Alerts"))},[r,u]),M=(0,e.useMemo)(()=>{const y=async()=>{await r({skipExisting:!1})};return e.createElement(L.u,{theme:"info-alt",content:u?"Upgrade in progress...":"Upgrade all legacy alerts from scratch.",placement:"top"},e.createElement(P.zx,{size:"md",variant:"secondary",onClick:y,icon:"sync",disabled:u},"Upgrade All Alerts"))},[r,u]);return e.createElement(Me,{rows:K,queryParam:l,updateQueryParam:t,searchSpaceMap:k,searchPlaceholder:(0,be.nV)(!1),syncNewButton:h,syncAllButton:M,isUpgrading:u,emptyMessage:"No alert upgrades found.",columns:a,isExpandable:!0,renderExpandedContent:c})};ie.displayName="AlertTabContentWrapper";const ce=()=>{const a=Se(),n="contactFilter",[l,t]=de(n),[r,{isLoading:o}]=b.useUpgradeAllChannelsMutation({fixedCacheKey:"upgrade-channels-loading"}),[,{isLoading:d}]=b.useUpgradeAllDashboardsMutation({fixedCacheKey:"upgrade-alerts-loading"}),g=o||d,u=(0,e.useMemo)(()=>{const h=[];return(0,S.P1)(M=>M?.migratedChannels??[],M=>M??h)},[]),{items:T}=b.useGetOrgUpgradeSummaryQuery(void 0,{selectFromResult:({data:h})=>({items:u(h)})}),K=(0,e.useCallback)(h=>`${h.legacyChannel?.name} ${h.contactPoint?.name} ${h.legacyChannel?.type}`,[]),k=(0,e.useMemo)(()=>{const h=async()=>{await r({skipExisting:!0})};return e.createElement(L.u,{theme:"info-alt",content:g?"Upgrade in progress...":"Upgrade all newly created legacy notification channels since the previous run.",placement:"top"},e.createElement(P.zx,{size:"md",variant:"secondary",onClick:h,icon:"plus-circle",disabled:g},"Upgrade New Channels"))},[r,g]),c=(0,e.useMemo)(()=>{const h=async()=>{await r({skipExisting:!1})};return e.createElement(L.u,{theme:"info-alt",content:g?"Upgrade in progress...":"Upgrade all legacy notification channels from scratch.",placement:"top"},e.createElement(P.zx,{size:"md",variant:"secondary",onClick:h,icon:"sync",disabled:g},"Upgrade All Channels"))},[r,g]);return e.createElement(Te,{rows:T,queryParam:l,updateQueryParam:t,searchSpaceMap:K,searchPlaceholder:"Search for channel and contact point names",syncNewButton:k,syncAllButton:c,isUpgrading:g,emptyMessage:"No channel upgrades found.",columns:a})};ce.displayName="ChannelTabContentWrapper";function de(a){const{search:n}=(0,W.TH)(),l=(0,e.useMemo)(()=>new URLSearchParams(n).get(a)||"",[a,n]),t=(0,e.useCallback)(r=>E.E1.partial({[a]:r||null}),[a]);return[l,t]}const ge=({rows:a=[],queryParam:n,updateQueryParam:l,searchSpaceMap:t,columns:r,isExpandable:o=!1,renderExpandedContent:d,emptyMessage:g,searchPlaceholder:u,syncNewButton:T,syncAllButton:K,isUpgrading:k})=>{const c=(0,A.wW)(B),h=k||k,M=(0,e.useMemo)(()=>Oe(t,a),[t,a]),y=(0,e.useMemo)(()=>M(n).map((q,Be)=>({id:`${t(q)} - ${Be}`,data:q})),[t,M,n]),O=!1,ue=(0,i.cx)(c.wrapper,{[c.wrapperMargin]:O}),Fe=O?ne.F:re.t,Pe=(0,e.useMemo)(()=>({itemsPerPage:50}),[]);return e.createElement(e.Fragment,null,e.createElement("div",{className:c.searchWrapper},e.createElement(m.K,{direction:"column",gap:1},e.createElement(m.K,{direction:"row",gap:1},e.createElement(Re,{placeholder:u,searchFn:q=>{l?.(q||"")},searchPhrase:n||""}),T,K))),h&&e.createElement(me,{text:k?"Upgrade in progress...":"Loading..."}),!h&&!!y.length&&e.createElement("div",{className:ue},e.createElement(Fe,{cols:r,isExpandable:o,items:y,renderExpandedContent:d,pagination:Pe,paginationStyles:c.pagination})),!h&&!y.length&&e.createElement("div",{className:(0,i.cx)(ue,c.emptyMessage)},g))},Te=e.memo(ge),Me=e.memo(ge),Se=()=>{const a=(0,A.wW)(B),{useUpgradeChannelMutation:n}=b,[l]=n();return(0,e.useMemo)(()=>[{id:"contact-level-error",label:"",renderCell:({data:t})=>{if(!t.error)return null;const r=t?.error==="channel not upgraded"||t?.error==="channel no longer exists";return e.createElement(L.u,{theme:"error",content:t.error},e.createElement(x.J,{name:"exclamation-circle",className:r?a.warningIcon:a.errorIcon,size:"lg"}))},size:"45px"},{id:"legacyChannel",label:"Legacy Channel",renderCell:({data:t})=>t?.legacyChannel?!t.legacyChannel.name&&t.contactPoint?.name?e.createElement(N.C,{color:"red",text:`Deleted Channel (ID: ${t.legacyChannel?.id})`}):t.legacyChannel.name?e.createElement(m.K,{direction:"row",gap:1},e.createElement(G.r,{rel:"noreferrer",target:"_blank",className:a.textLink,href:(0,ee.u)(`/alerting-legacy/notifications/receivers/${encodeURIComponent(t.legacyChannel.id)}/edit`,{})},t.legacyChannel.name),t.legacyChannel?.type&&e.createElement(N.C,{color:"blue",text:t.legacyChannel.type})):e.createElement(N.C,{color:"red",text:`Unknown Channel (ID: ${t.legacyChannel?.id})`}):null,size:5},{id:"arrow",label:"",renderCell:({data:t})=>t?.contactPoint?e.createElement(x.J,{name:"arrow-right"}):null,size:"45px"},{id:"route",label:"Notification Policy",renderCell:({data:t})=>e.createElement(Ae.g,{matchers:t?.contactPoint?.routeMatchers??[]}),size:5},{id:"arrow2",label:"",renderCell:({data:t})=>t?.contactPoint?e.createElement(x.J,{name:"arrow-right"}):null,size:"45px"},{id:"contactPoint",label:"Contact Point",renderCell:({data:t})=>e.createElement(m.K,{direction:"row",gap:1},t?.contactPoint&&e.createElement(e.Fragment,null,e.createElement(G.r,{rel:"noreferrer",target:"_blank",className:a.textLink,href:(0,X.GV)(t.contactPoint.name,"grafana")},t.contactPoint.name),e.createElement(N.C,{color:"blue",text:t.contactPoint.type}))),size:5},{id:"provisioned",label:"",renderCell:({data:t})=>t.provisioned?e.createElement(N.C,{color:"purple",text:"Provisioned",className:a.badge}):null,size:"100px"},{id:"actions",label:"Actions",renderCell:({data:t})=>!t?.legacyChannel||t.legacyChannel.id<=0?null:t.isUpgrading?e.createElement(m.K,{gap:.5,alignItems:"center"},e.createElement(_.$,{size:"sm",inline:!0,className:a.spinner})):t?.error==="channel not upgraded"?e.createElement(m.K,{gap:.5,alignItems:"center"},e.createElement(z.A,{"aria-label":"upgrade legacy notification channel",key:"upgrade-channel",icon:"plus",tooltip:"upgrade legacy notification channel",onClick:()=>l({channelId:t.legacyChannel.id,skipExisting:!1})})):t?.error==="channel no longer exists"?e.createElement(m.K,{gap:.5,alignItems:"center"},e.createElement(z.A,{"aria-label":"remove upgraded notification channel",key:"upgrade-channel",icon:"minus",tooltip:"remove upgraded notification channel",onClick:()=>l({channelId:t.legacyChannel.id,skipExisting:!1})})):e.createElement(m.K,{gap:.5,alignItems:"center"},e.createElement(z.A,{"aria-label":"re-upgrade legacy notification channel",key:"upgrade-channel",icon:"sync",tooltip:"re-upgrade legacy notification channel",onClick:()=>l({channelId:t.legacyChannel.id,skipExisting:!1})})),size:"70px"}],[a.textLink,a.errorIcon,a.warningIcon,a.badge,a.spinner,l])},De=()=>{const a=(0,A.wW)(B),{useUpgradeDashboardMutation:n}=b,[l]=n();return(0,e.useMemo)(()=>[{id:"dashboard-level-error",label:"",renderCell:({data:t})=>{if(!t.error)return null;const r=t?.error==="dashboard not upgraded"||t?.error==="dashboard no longer exists";return e.createElement(L.u,{theme:"error",content:t.error},e.createElement(x.J,{name:"exclamation-circle",className:r?a.warningIcon:a.errorIcon,size:"lg"}))},size:"45px"},{id:"folder",label:"Folder",renderCell:({data:t})=>t.folderName?e.createElement(m.K,{alignItems:"center",gap:.5},e.createElement(x.J,{name:"folder"}),e.createElement(G.r,{rel:"noreferrer",target:"_blank",className:a.textLink,href:(0,X.HV)(t.folderUid)},t.folderName)):e.createElement(m.K,{alignItems:"center",gap:.5},e.createElement(x.J,{name:"folder"}),e.createElement(N.C,{color:"red",text:"Unknown Folder"})),size:2},{id:"dashboard",label:"Dashboard",renderCell:({data:t})=>t.dashboardName?e.createElement(m.K,{alignItems:"center",gap:.5},e.createElement(x.J,{name:"apps"}),e.createElement(G.r,{rel:"noreferrer",target:"_blank",className:a.textLink,href:(0,X.RQ)(t.dashboardUid)},t.dashboardName)):e.createElement(m.K,{alignItems:"center",gap:.5},e.createElement(x.J,{name:"apps"}),e.createElement(N.C,{color:"red",text:`Unknown Dashboard (ID: ${t.dashboardId})`})),size:2},{id:"new-folder-arrow",label:"",renderCell:({data:t})=>{const r=t?.newFolderUid;return r&&r!==t.folderUid&&t?.newFolderName?e.createElement(x.J,{name:"arrow-right"}):null},size:"45px"},{id:"new-folder",label:"New folder",renderCell:({data:t})=>{const r=t?.newFolderUid;if(r&&r!==t.folderUid&&t?.newFolderName){const o=t.warning.includes("dashboard alerts moved");return e.createElement(m.K,{alignItems:"center",gap:.5},e.createElement(x.J,{name:"folder"}),e.createElement(G.r,{rel:"noreferrer",target:"_blank",className:a.textLink,href:(0,X.HV)(r)},t.newFolderName),o&&e.createElement(L.u,{theme:"info-alt",content:t.warning,placement:"top"},e.createElement(x.J,{name:"info-circle"})))}return null},size:3},{id:"provisioned",label:"",className:a.tableBadges,renderCell:({data:t})=>{const r=t.warning.includes("provisioned status:");return e.createElement(e.Fragment,null,t.provisioned&&e.createElement(N.C,{color:"purple",text:r?"Unknown":"Provisioned",tooltip:t.warning,icon:r?"exclamation-triangle":void 0,className:a.badge}))},size:"100px"},{id:"error-badge",label:"",className:a.tableBadges,renderCell:({data:t})=>{const o=(t?.migratedAlerts??[]).map(d=>d.error??"").filter(d=>!!d);return o.length===0?null:e.createElement(N.C,{color:"red",key:"errors",text:`${o.length} errors`,className:a.badge})},size:"90px"},{id:"alert-count-badge",label:"",className:a.tableBadges,renderCell:({data:t})=>{const r=t?.migratedAlerts??[];return e.createElement(N.C,{color:"green",key:"alerts",text:`${r.length} alert rules`,className:a.badge})},size:"115px"},{id:"actions",label:"Actions",renderCell:({data:t})=>t.isUpgrading?e.createElement(m.K,{gap:.5,alignItems:"center"},e.createElement(_.$,{size:"sm",inline:!0,className:a.spinner})):t?.error==="dashboard not upgraded"?e.createElement(m.K,{gap:.5,alignItems:"center"},e.createElement(z.A,{"aria-label":"upgrade legacy alerts for this dashboard",key:"upgrade-dashboard",icon:"plus",tooltip:"upgrade legacy alerts for this dashboard",onClick:()=>l({dashboardId:t.dashboardId,skipExisting:!1})})):t?.error==="dashboard no longer exists"?e.createElement(m.K,{gap:.5,alignItems:"center"},e.createElement(z.A,{"aria-label":"remove upgraded alerts for this dashboard",key:"upgrade-dashboard",icon:"minus",tooltip:"remove upgraded alerts for this dashboard",onClick:()=>l({dashboardId:t.dashboardId,skipExisting:!1})})):e.createElement(m.K,{gap:.5,alignItems:"center"},t.dashboardId&&e.createElement(z.A,{"aria-label":"re-upgrade legacy alerts for this dashboard",key:"upgrade-dashboard",icon:"sync",tooltip:"re-upgrade legacy alerts for this dashboard",onClick:()=>l({dashboardId:t.dashboardId,skipExisting:!1})})),size:"70px"}],[a.tableBadges,a.errorIcon,a.warningIcon,a.textLink,a.badge,a.spinner,l])},Ue=new C.Z({intraMode:1,intraIns:1,intraSub:1,intraTrn:1,intraDel:1}),Oe=(a,n)=>{const l=n.map(a);return t=>{if(!t)return n;const[r,o,d]=Ue.search(l,t,5);return o&&d?d.map(g=>n[o.idx[g]]):r?r.map(g=>n[g]):n}},Re=({searchFn:a,searchPhrase:n,placeholder:l})=>{const[t,r]=(0,e.useState)(n),o=(0,e.useMemo)(()=>(0,v.debounce)(a,600),[a]);return(0,e.useEffect)(()=>(r(n),()=>{o?.cancel()}),[o,n]),e.createElement(he.H,{placeholder:l,value:t,width:55,escapeRegex:!1,onChange:d=>{r(d||""),d===""?(o?.cancel(),a("")):o(d||"")}})},Le=({dashboardId:a,dashboardUid:n,showGuidelines:l=!1,emptyMessage:t="No alert upgrades found."})=>{const r=(0,A.wW)(B),o=(0,e.useMemo)(()=>{const c=[];return(0,S.P1)(h=>h?.migratedDashboards??[],(h,M)=>M,(h,M)=>h?.find(y=>y.dashboardId===M)?.migratedAlerts.map((y,O)=>({id:`${y?.legacyAlert?.id}-${O}`,data:y}))??c)},[]),{items:d}=b.useGetOrgUpgradeSummaryQuery(void 0,{selectFromResult:({data:c})=>({items:o(c,a)})}),{useUpgradeAlertMutation:g}=b,[u]=g(),T=(0,i.cx)(r.wrapper,r.rulesTable,{[r.wrapperMargin]:l}),K=[{id:"alert-level-error",label:"",renderCell:({data:c})=>{if(!c.error)return null;const h=c?.error==="alert not upgraded"||c?.error.endsWith("no longer exists");return e.createElement(L.u,{theme:"error",content:c.error},e.createElement(x.J,{name:"exclamation-circle",className:h?r.warningIcon:r.errorIcon,size:"lg"}))},size:"45px"},{id:"legacyAlert",label:"Legacy alert rule",renderCell:({data:c})=>c?.legacyAlert?(c.error??"").endsWith("no longer exists")?e.createElement(N.C,{color:"red",text:`Deleted Alert: (ID: ${c.legacyAlert?.panelId})`}):e.createElement(e.Fragment,null,n?e.createElement(G.r,{rel:"noreferrer",target:"_blank",className:c.legacyAlert.name?r.textLink:r.errorLink,href:(0,ee.u)(`/d/${encodeURIComponent(n)}`,{editPanel:String(c.legacyAlert.panelId),tab:"alert"})},c.legacyAlert.name||"Missing Title"):e.createElement(N.C,{color:"red",text:c.legacyAlert.name||"Unknown Alert"})):null,size:5},{id:"arrow",label:"",renderCell:({data:c})=>c?.legacyAlert?e.createElement(x.J,{name:"arrow-right"}):null,size:"45px"},{id:"alertRule",label:"New alert rule",renderCell:({data:c})=>e.createElement(m.K,{direction:"row",gap:1},c?.alertRule&&e.createElement(G.r,{rel:"noreferrer",target:"_blank",className:r.textLink,href:(0,ee.u)(`/alerting/grafana/${c.alertRule?.uid??""}/view`,{})},c.alertRule?.title??"")),size:5},{id:"contacts",label:"Sends To",renderCell:({data:c})=>e.createElement(e.Fragment,null,c?.alertRule&&e.createElement(Ee.P,{tags:c?.alertRule?.sendsTo??[],displayMax:3,className:(0,i.css)({justifyContent:"flex-start",width:"100%"})})),size:3},{id:"actions",label:"Actions",renderCell:({data:c})=>!c?.legacyAlert||c.legacyAlert.dashboardId<=0||c.legacyAlert.panelId<=0?null:c.isUpgrading?e.createElement(m.K,{gap:.5,alignItems:"center"},e.createElement(_.$,{size:"sm",inline:!0,className:r.spinner})):c?.error==="alert not upgraded"?e.createElement(m.K,{gap:.5,alignItems:"center"},e.createElement(z.A,{"aria-label":"upgrade legacy alert",key:"upgrade-alert",icon:"plus",tooltip:"upgrade legacy alert",onClick:()=>u({dashboardId:c.legacyAlert.dashboardId,panelId:c.legacyAlert.panelId,skipExisting:!1})})):c?.error?.endsWith("no longer exists")?e.createElement(m.K,{gap:.5,alignItems:"center"},e.createElement(z.A,{"aria-label":"remove upgraded alert",key:"upgrade-alert",icon:"minus",tooltip:"remove upgraded alert",onClick:()=>u({dashboardId:c.legacyAlert.dashboardId,panelId:c.legacyAlert.panelId,skipExisting:!1})})):e.createElement(m.K,{gap:.5,alignItems:"center"},e.createElement(z.A,{"aria-label":"re-upgrade legacy alert",key:"upgrade-alert",icon:"sync",tooltip:"re-upgrade legacy alert",onClick:()=>u({dashboardId:c.legacyAlert.dashboardId,panelId:c.legacyAlert.panelId,skipExisting:!1})})),size:"70px"}];if(!d.length)return e.createElement("div",{className:(0,i.cx)(T,r.emptyMessage)},t);const k=l?ne.F:re.t;return e.createElement("div",{className:T,"data-testid":"rules-table"},e.createElement(k,{cols:K,items:d,pagination:{itemsPerPage:50},paginationStyles:r.pagination}))},ze=({count:a,onClick:n})=>e.createElement(ye.Lh,{height:"auto",justify:"flex-start"},e.createElement(L.u,{content:"Show all errors",placement:"top"},e.createElement(P.zx,{fill:"text",variant:"destructive",icon:"exclamation-circle",onClick:n},a>1?e.createElement(e.Fragment,null,a," errors"):e.createElement(e.Fragment,null,"1 error")))),Ke=({errors:a})=>{const[n,l]=(0,e.useState)(!1),[t,r]=(0,w.Z)("grafana.unifiedalerting.upgrade.hideErrors",!0),o=(0,A.wW)(B);return e.createElement(e.Fragment,null,!!a.length&&t&&e.createElement(ze,{count:a.length,onClick:()=>r(!1)}),!!a.length&&!t&&e.createElement(I.b,{"data-testid":"upgrade-errors",title:"Errors upgrading to Grafana Alerting",severity:"error",onRemove:()=>r(!0)},n&&a.map((d,g)=>e.createElement("div",{key:g},d)),!n&&e.createElement(e.Fragment,null,e.createElement("div",null,a[0]),a.length>=2&&e.createElement(P.zx,{className:o.moreButton,fill:"text",icon:"angle-right",size:"sm",onClick:()=>l(!0)},a.length-1," more ",D()("error",a.length-1)))))},me=({text:a="Loading..."})=>e.createElement("div",{className:"page-loader-wrapper"},e.createElement(Ce.u,{text:a})),B=a=>({wrapperMargin:(0,i.css)({[a.breakpoints.up("md")]:{marginLeft:"36px"}}),emptyMessage:(0,i.css)({padding:a.spacing(1)}),wrapper:(0,i.css)({width:"auto",borderRadius:a.shape.radius.default}),pagination:(0,i.css)({display:"flex",margin:"0",paddingTop:a.spacing(1),paddingBottom:a.spacing(.25),justifyContent:"center",borderLeft:`1px solid ${a.colors.border.medium}`,borderRight:`1px solid ${a.colors.border.medium}`,borderBottom:`1px solid ${a.colors.border.medium}`}),rulesTable:(0,i.css)({marginTop:a.spacing(3)}),errorIcon:(0,i.css)({fill:a.colors.error.text}),warningIcon:(0,i.css)({fill:a.colors.warning.text}),searchWrapper:(0,i.css)({marginBottom:a.spacing(2)}),textLink:(0,i.css)({color:a.colors.text.link,cursor:"pointer","&:hover":{textDecoration:"underline"}}),errorLink:(0,i.css)({color:a.colors.error.text,cursor:"pointer","&:hover":{textDecoration:"underline"}}),tabContent:(0,i.css)({marginTop:a.spacing(2)}),moreButton:(0,i.css)({padding:"0"}),tableBadges:(0,i.css)({justifyContent:"flex-end"}),badge:(0,i.css)({width:"100%",justifyContent:"center"}),separator:(0,i.css)({borderBottom:`1px solid ${a.colors.border.weak}`,marginTop:a.spacing(2)}),spinner:(0,i.css)({display:"flex",alignItems:"center",justifyContent:"center",width:a.spacing(3),height:a.spacing(3)})}),ke=le},78770:(Z,U,s)=>{s.d(U,{F:()=>$});var i=s(76932),C=s(31733),S=s(76067),v=s(25899);const $=({renderExpandedContent:e,...W})=>{const w=(0,S.wW)(D);return C.createElement(v.t,{renderExpandedContent:e?(R,m,E)=>C.createElement(C.Fragment,null,m!==E.length-1&&C.createElement("div",{className:(0,i.cx)(w.contentGuideline,w.guideline)}),e(R,m,E)):void 0,renderPrefixHeader:()=>C.createElement("div",{className:w.relative},C.createElement("div",{className:(0,i.cx)(w.headerGuideline,w.guideline)})),renderPrefixCell:(R,m,E)=>C.createElement("div",{className:w.relative},C.createElement("div",{className:(0,i.cx)(w.topGuideline,w.guideline)}),m!==E.length-1&&C.createElement("div",{className:(0,i.cx)(w.bottomGuideline,w.guideline)})),...W})},D=e=>({relative:(0,i.css)`
    position: relative;
    height: 100%;
  `,guideline:(0,i.css)`
    left: -19px;
    border-left: 1px solid ${e.colors.border.weak};
    position: absolute;

    ${e.breakpoints.down("md")} {
      display: none;
    }
  `,topGuideline:(0,i.css)`
    width: 18px;
    border-bottom: 1px solid ${e.colors.border.medium};
    top: 0;
    bottom: 50%;
  `,bottomGuideline:(0,i.css)`
    top: 50%;
    bottom: 0;
  `,contentGuideline:(0,i.css)`
    top: 0;
    bottom: 0;
    left: -49px !important;
  `,headerGuideline:(0,i.css)`
    top: -17px;
    bottom: 0;
  `})},86963:(Z,U,s)=>{s.d(U,{g:()=>w});var i=s(76932),C=s(69781),S=s.n(C),v=s(31733),$=s(76067),D=s(37739),e=s(7225),W=s(96477);const w=({matchers:E})=>{const I=(0,$.wW)(m),A=5,F=(0,C.take)(E,A),J=(0,C.takeRight)(E,E.length-A),V=J.length>0;return v.createElement("span",{"data-testid":"label-matchers"},v.createElement(D.K,{direction:"row",gap:1,alignItems:"center",wrap:"wrap"},F.map(H=>v.createElement(R,{key:(0,C.uniqueId)(),matcher:H})),V&&v.createElement(W.z,{arrow:!0,placement:"top",content:v.createElement(v.Fragment,null,J.map(H=>v.createElement(R,{key:(0,C.uniqueId)(),matcher:H})))},v.createElement("span",null,v.createElement("div",{className:I.metadata},`and ${J.length} more`)))))},R=({matcher:[E,I,A]})=>{const F=(0,$.wW)(m);return v.createElement("div",{className:F.matcher(E).wrapper},v.createElement(D.K,{direction:"row",gap:0,alignItems:"baseline"},E," ",I," ",A))},m=E=>({matcher:I=>{const{color:A,borderColor:F}=(0,e.Bx)(I);return{wrapper:(0,i.css)`
        color: #fff;
        background: ${A};
        padding: ${E.spacing(.33)} ${E.spacing(.66)};
        font-size: ${E.typography.bodySmall.fontSize};

        border: solid 1px ${F};
        border-radius: ${E.shape.borderRadius(2)};
      `}},metadata:(0,i.css)`
    color: ${E.colors.text.secondary};

    font-size: ${E.typography.bodySmall.fontSize};
    font-weight: ${E.typography.bodySmall.fontWeight};
  `})},74086:(Z,U,s)=>{s.d(U,{A:()=>v});var i=s(31733),C=s(58037),S=s(51343);const v=({tooltip:$,icon:D,to:e,target:W,onClick:w,className:R,tooltipPlacement:m="top",...E})=>{const I=typeof $=="string"?$:void 0;return i.createElement(C.u,{content:$,placement:m},e?i.createElement(S.Qj,{variant:"secondary",fill:"text",icon:D,href:e,size:"sm",target:W,...E,"aria-label":I}):i.createElement(S.zx,{className:R,variant:"secondary",fill:"text",size:"sm",icon:D,type:"button",onClick:w,...E,"aria-label":I}))}},41273:(Z,U,s)=>{s.d(U,{F:()=>$,Fl:()=>D,Z:()=>S,nV:()=>C,tH:()=>v});var i=s(53166);function C(e=!1){return e?(0,i.t)("search.search-input.include-panels-placeholder","Search for dashboards, folders, and panels"):(0,i.t)("search.search-input.placeholder","Search for dashboards and folders")}function S(){return(0,i.t)("search.dashboard-actions.new-dashboard","New dashboard")}function v(){return(0,i.t)("search.dashboard-actions.new-folder","New folder")}function $(){return(0,i.t)("search.dashboard-actions.import","Import")}function D(){return(0,i.t)("search.dashboard-actions.new","New")}}}]);

//# sourceMappingURL=AlertingUpgrade.77f09ac66dc4cedc48be.js.map