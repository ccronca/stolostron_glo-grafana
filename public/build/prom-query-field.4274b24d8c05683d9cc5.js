"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6031],{41876:(G,$,a)=>{a.d($,{O:()=>s,t:()=>O});var D=a(64142);function s(p,h,d,L){if(!p)return!1;const E=F(h,L);if(!E.length)return!1;let l=E;if(p!==h){const i=F(p,L);l=E.flatMap(g=>i.filter(b=>g.text===b.text)||g)}return l.map(i=>M(p,d,i)).filter(y)}function F(p,h){const d=[];return h.parse(p).iterate({enter:E=>{if(E.type.id===D._A){const l=E.node;d.push({node:l,text:p.substring(l.from,l.to)})}}}),d}function M(p,h,d){if(h.length===1){const l=d.node.from===d.node.to,i=l&&d.node.parent?d.node.parent:d.node,g=l?p.substring(i.from,i.to):d.text;return{startLineNumber:1,startColumn:i.from+1,endLineNumber:1,endColumn:i.to+1,error:g}}let L=0,E=0;for(let l=0;l<h.length;l++){if(E=L+h[l].length,d.node.from>E){L+=h[l].length+1;continue}return{startLineNumber:l+1,startColumn:d.node.from-L+1,endLineNumber:l+1,endColumn:d.node.to-L+1,error:d.text}}return null}function y(p){return p!==null}const O={__interval:{text:"1s",value:"1s"},__rate_interval:{text:"1s",value:"1s"},__auto:{text:"1s",value:"1s"},__interval_ms:{text:"1000",value:1e3},__range_ms:{text:"1000",value:1e3},__range_s:{text:"1",value:1},__range:{text:"1s",value:"1s"}}},64142:(G,$,a)=>{a.d($,{Es:()=>d,KF:()=>h,Tt:()=>p,_A:()=>D,bU:()=>y,ff:()=>L,ge:()=>s,wf:()=>F});const D=0;function s(l){return l.firstChild?s(l.firstChild):l}function F(l,i){return{text:h(l,i),from:i.from,to:i.to,parentType:i.parent?.name}}const M=/\$(\w+)|\[\[([\s\S]+?)(?::(\w+))?\]\]|\${(\w+)(?:\.([^:^\}]+))?(?::([^\}]+))?}/g;function y(l){return l.replace(M,(i,g,b,T,S,Y,z)=>{const K=T||z;let U=g,H="0";return b&&(U=b,H="1"),S&&(U=S,H="2"),`__V_${H}__`+U+"__V__"+(K?"__F__"+K+"__F__":"")})}const O=[(l,i)=>`$${l}`,(l,i)=>`[[${l}${i?`:${i}`:""}]]`,(l,i)=>`\${${l}${i?`:${i}`:""}}`];function p(l){return l.replace(/__V_(\d)__(.+?)__V__(?:__F__(\w+)__F__)?/g,(i,g,b,T)=>O[parseInt(g,10)](b,T))}function h(l,i){return i?p(l.substring(i.from,i.to)):""}function d(l,i,g,b){const T=[parseFloat(h(i,g))];return l.comparison&&T.push(b),{id:l.id,params:T}}function L(l,i,g){if(i.type.id===g||i.name===g)return[h(l,i)];const b=[];let T=0,S=i.childAfter(T);for(;S;)b.push(...L(l,S,g)),T=S.to,S=i.childAfter(T);return b}const E=l=>l.split(" ").map(g=>`${g}.*`).join("")},32578:(G,$,a)=>{a.r($),a.d($,{default:()=>We});var D=a(76932),s=a(97336),F=a(69781),M={id:"promql",extensions:[".promql"],aliases:["Prometheus","prometheus","prom","Prom","promql","Promql","promQL","PromQL"],mimetypes:[],loader:function(){return Promise.all([a.e(5528),a.e(5591)]).then(a.bind(a,72145))}},y=a(31733),O=a(80004),p=a(79117),h=a(21568),d=a(76067),L=a(43017),E=a(41876);function l(){const e=new Map;return e.set("expandSuggestionDocs",(!0).toString()),{onDidChangeValue:t=>{},onDidChangeTarget:t=>{},onWillSaveState:t=>{},get:(t,n,r)=>e.get(t)??r,getBoolean:(t,n,r)=>{const o=e.get(t);return o!==void 0?o==="true":r},getNumber:(t,n,r)=>{const o=e.get(t);return o!==void 0?parseInt(o,10):r},store:(t,n,r,o)=>{n==null?e.delete(t):e.set(t,n.toString())},remove:(t,n)=>{e.delete(t)},keys:(t,n)=>Array.from(e.keys()),logStorage:()=>{console.log("logStorage: not implemented")},migrate:()=>Promise.resolve(void 0),isNew:t=>!0,flush:t=>Promise.resolve(void 0)}}let i=null;function g(){return i===null&&(i={storageService:l()}),i}var b=a(78114),T=a(58465);class S extends Error{constructor(t){super("should never happen")}}async function Y(e){return(await e.getAllMetricNames()).map(n=>({type:"METRIC_NAME",label:n.name,insertText:n.name,detail:`${n.name} : ${n.type}`,documentation:n.help}))}const z=T.r8.map(e=>({type:"FUNCTION",label:e.label,insertText:e.insertText??"",detail:e.detail,documentation:e.documentation}));async function K(e){const t=await Y(e);return[...z,...t]}const U=["$__interval","$__range","$__rate_interval","1m","5m","10m","30m","1h","1d"].map(e=>({type:"DURATION",label:e,insertText:e}));async function H(e){return(await e.getHistory()).slice(0,10).map(n=>({type:"HISTORY",label:n,insertText:n}))}function q(e,t){const n=[...t];return e!==void 0&&n.push({name:"__name__",value:e,op:"="}),`{${n.map(o=>`${o.name}${o.op}"${(0,b.U9)(o.value)}"`).join(",")}}`}async function de(e,t,n){if(e===void 0&&t.length===0)return n.getAllLabelNames();{const r=q(e,t);return await n.getSeriesLabels(r,t)}}async function ee(e,t,n,r,o){return(await de(e,r,o)).map(c=>({type:"LABEL_NAME",label:c,insertText:`${c}${t}`,triggerOnInsert:n}))}async function fe(e,t,n){return ee(e,"=",!0,t,n)}async function me(e,t,n){return ee(e,"",!1,t,n)}async function ge(e,t,n,r){if(e===void 0&&n.length===0)return r.getLabelValues(t);{const o=q(e,n);return await r.getSeriesValues(t,o)}}async function pe(e,t,n,r,o){return(await ge(e,t,r,o)).map(c=>({type:"LABEL_VALUE",label:c,insertText:n?c:`"${c}"`}))}async function he(e,t){switch(e.type){case"IN_DURATION":return U;case"IN_FUNCTION":return K(t);case"AT_ROOT":return K(t);case"EMPTY":{const n=await Y(t);return[...await H(t),...z,...n]}case"IN_LABEL_SELECTOR_NO_LABEL_NAME":return fe(e.metricName,e.otherLabels,t);case"IN_GROUPING":return me(e.metricName,e.otherLabels,t);case"IN_LABEL_SELECTOR_WITH_LABEL_NAME":return pe(e.metricName,e.labelName,e.betweenQuotes,e.otherLabels,t);default:throw new S(e)}}function Ce(e,t){switch(t){case"parent":return e.parent;case"firstChild":return e.firstChild;case"lastChild":return e.lastChild;case"nextSibling":return e.nextSibling;default:throw new S(t)}}function v(e,t){let n=e;for(const[r,o]of t)if(n=Ce(n,r),n===null||n.type.id!==o)return null;return n}function V(e,t){return t.slice(e.from,e.to)}function Ne(e){const t=e.slice(1,e.length-1);if(e.startsWith('"')&&e.endsWith('"'))return t.replace(/\\"/,'"');if(e.startsWith("'")&&e.endsWith("'"))return t.replace(/\\'/,"'");if(e.startsWith("`")&&e.endsWith("`"))return t;throw new Error("FIXME: invalid string literal")}function ve(e,t){return e.every((n,r)=>n===t[r])}const k=0,ye=[{path:[s.m$,s.m6],fun:Oe},{path:[s.vD],fun:Ae},{path:[s.yY],fun:Ie},{path:[s.nv,s.Zm],fun:ne},{path:[k,s.Zm],fun:ne},{path:[k,s.uM],fun:_e},{path:[s.XT],fun:Se}],Le=new Map([[s.M5,"="],[s.f0,"=~"],[s.IJ,"!="],[s.JW,"!~"]]);function Ee(e){const t=e.firstChild;return t===null?null:Le.get(t.type.id)??null}function be(e,t){if(e.type.id!==s.Zm)return null;const n=v(e,[["firstChild",s.m0]]);if(n===null)return null;const r=v(n,[["nextSibling",s.e8]]);if(r===null)return null;const o=Ee(r);if(o===null)return null;const u=v(e,[["lastChild",s.nv]]);if(u===null)return null;const c=V(n,t),C=Ne(V(u,t));return{name:c,value:C,op:o}}function te(e,t){if(e.type.id!==s.m$)return[];let n=v(e,[["firstChild",s.z5]]);const r=[];for(;n!==null;){const o=v(n,[["lastChild",s.Zm]]);if(o===null)return[];const u=be(o,t);u!==null&&r.push(u),n=v(n,[["firstChild",s.z5]])}return r.reverse(),r}function Te(e){let t=e.firstChild;const n=[];for(;t!==null;)n.push(t),t=t.nextSibling;return n}function X(e,t){if(e.type.id===t)return e;const n=Te(e);for(const r of n){const o=X(r,t);if(o!==null)return o}return null}function Se(e,t,n){const r=v(e,[["parent",s.Ip],["parent",s.aZ]]);if(r===null)return null;const o=r.getChild(s.yY);if(o===null)return null;const u=X(o,s.tz);if(u===null)return null;const c=v(u,[["firstChild",s.xb]]);return c===null?null:{type:"IN_GROUPING",metricName:V(c,t),otherLabels:[]}}function ne(e,t,n){const r=!e.type.isError,o=v(e,[["parent",s.Zm]]);if(o===null)return null;const u=v(o,[["firstChild",s.m0]]);if(u===null)return null;const c=V(u,t),C=v(o,[["parent",s.z5]]);if(C===null)return null;let W=C,_=null;for(;_===null;){const N=W.parent;if(N===null)return null;const{id:Q}=N.type;switch(Q){case s.z5:W=N;continue;case s.m$:_=N;continue;default:return null}}const A=te(_,t).filter(N=>N.name!==c),I=v(_,[["parent",s.m6],["firstChild",s.tz],["firstChild",s.xb]]);return I===null?{type:"IN_LABEL_SELECTOR_WITH_LABEL_NAME",labelName:c,betweenQuotes:r,otherLabels:A}:{type:"IN_LABEL_SELECTOR_WITH_LABEL_NAME",metricName:V(I,t),labelName:c,betweenQuotes:r,otherLabels:A}}function Ae(e,t,n){return{type:"AT_ROOT"}}function Ie(e,t,n){return{type:"IN_FUNCTION"}}function _e(e,t,n){return{type:"IN_DURATION"}}function Me(e){return X(e,k)!==null}function Oe(e,t,n){if(Me(e))return null;const r=v(e,[["firstChild",s.z5]]);if(r!==null&&!t.slice(r.to,n).includes(","))return null;const o=v(e,[["parent",s.m6],["firstChild",s.tz],["firstChild",s.xb]]),u=te(e,t);return o===null?{type:"IN_LABEL_SELECTOR_NO_LABEL_NAME",otherLabels:u}:{type:"IN_LABEL_SELECTOR_NO_LABEL_NAME",metricName:V(o,t),otherLabels:u}}function Re(e,t){const n=e.cursorAt(t);for(;;){if(n.from===t&&n.to===t){const{node:r}=n;if(r.type.isError)return r}if(!n.next())break}return null}function we(e,t){if(e==="")return{type:"EMPTY"};const n=s.E2.parse(e),r=Re(n,t),o=r!=null?r.cursor():n.cursorAt(t),u=o.node,c=[o.type.id];for(;o.parent();)c.push(o.type.id);for(let C of ye)if(ve(C.path,c))return C.fun(u,e,t);return null}function xe(){return{showWords:!1}}function Pe(e,t){switch(e){case"DURATION":return t.languages.CompletionItemKind.Unit;case"FUNCTION":return t.languages.CompletionItemKind.Variable;case"HISTORY":return t.languages.CompletionItemKind.Snippet;case"LABEL_NAME":return t.languages.CompletionItemKind.Enum;case"LABEL_VALUE":return t.languages.CompletionItemKind.EnumMember;case"METRIC_NAME":return t.languages.CompletionItemKind.Constructor;default:throw new S(e)}}function $e(e,t){return{triggerCharacters:["{",",","[","(","=","~"," ",'"'],provideCompletionItems:(r,o)=>{const u=r.getWordAtPosition(o),c=u!=null?e.Range.lift({startLineNumber:o.lineNumber,endLineNumber:o.lineNumber,startColumn:u.startColumn,endColumn:u.endColumn}):e.Range.fromPositions(o),C={column:o.column,lineNumber:o.lineNumber};if(window.getSelection){const A=window.getSelection()?.toString();A&&A.length>0&&(C.column=C.column-A.length)}const W=r.getOffsetAt(C),_=we(r.getValue(),W);return(_!=null?he(_,t):Promise.resolve([])).then(A=>{const I=A.length.toString().length;return{suggestions:A.map((N,Q)=>({kind:Pe(N.type,e),label:N.label,insertText:N.insertText,detail:N.detail,documentation:N.documentation,sortText:Q.toString().padStart(I,"0"),range:c,command:N.triggerOnInsert?{id:"editor.action.triggerSuggest",title:""}:void 0}))}})}}}const De={codeLens:!1,contextmenu:!1,fixedOverflowWidgets:!0,folding:!1,fontSize:14,lineDecorationsWidth:8,lineNumbers:"off",minimap:{enabled:!1},overviewRulerBorder:!1,overviewRulerLanes:0,padding:{top:4,bottom:5},renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0,alwaysConsumeMouseWheel:!1},scrollBeyondLastLine:!1,suggest:xe(),suggestFontSize:12,wordWrap:"on"},Fe=2,Z=M.id;let re=!1;function Be(e){if(re===!1){re=!0;const{aliases:t,extensions:n,mimetypes:r,loader:o}=M;e.languages.register({id:Z,aliases:t,extensions:n,mimetypes:r}),o().then(u=>{e.languages.setMonarchTokensProvider(Z,u.language),e.languages.setLanguageConfiguration(Z,u.languageConfiguration)})}}const Ve=(e,t)=>({container:(0,D.css)`
      border-radius: ${e.shape.radius.default};
      border: 1px solid ${e.components.input.borderColor};
    `,placeholder:(0,D.css)`
      ::after {
        content: '${t}';
        font-family: ${e.typography.fontFamilyMonospace};
        opacity: 0.6;
      }
    `}),We=e=>{const t=(0,p.Z)(),n=(0,y.useRef)(g()),r=(0,y.useRef)(null),{languageProvider:o,history:u,onBlur:c,onRunQuery:C,initialValue:W,placeholder:_,onChange:j,datasource:A}=e,I=(0,O.Z)(o),J=(0,O.Z)(u),N=(0,O.Z)(C),Q=(0,O.Z)(c),Ke=(0,O.Z)(j),oe=(0,y.useRef)(null),Ue=(0,d.l4)(),se=Ve(Ue,_);return(0,y.useEffect)(()=>()=>{oe.current?.()},[]),y.createElement("div",{"data-testid":h.wl.components.QueryField.container,className:se.container,ref:r},y.createElement(L.o,{overrideServices:n.current,options:De,language:"promql",value:W,beforeMount:f=>{Be(f)},onMount:(f,R)=>{const le=f.createContextKey("isEditorFocused"+t,!1);f.onDidBlurEditorWidget(()=>{le.set(!1),Q.current(f.getValue())}),f.onDidFocusEditorText(()=>{le.set(!0)});const He=()=>Promise.resolve(J.current.map(m=>m.query.expr).filter(m=>m!==void 0)),Qe=()=>{const{metrics:m,metricsMetadata:w}=I.current,B=m.map(x=>{const P=w?.[x];return{name:x,help:P?.help??"",type:P?.type??""}});return Promise.resolve(B)},ze=()=>Promise.resolve(I.current.getLabelKeys()),Ze=m=>I.current.getLabelValues(m),Ge=I.current.getSeriesValues,Ye=I.current.getSeriesLabels,ie=$e(R,{getHistory:He,getAllMetricNames:Qe,getAllLabelNames:ze,getLabelValues:Ze,getSeriesValues:Ge,getSeriesLabels:Ye}),ke={...ie,provideCompletionItems:(m,w,B,x)=>f.getModel()?.id!==m.id?{suggestions:[]}:ie.provideCompletionItems(m,w,B,x)},{dispose:Xe}=R.languages.registerCompletionItemProvider(Z,ke);oe.current=Xe;const ae=()=>{const m=r.current;if(m!==null){const w=f.getContentHeight();m.style.height=`${w+Fe}px`,m.style.width="100%";const B=m.clientWidth;f.layout({width:B,height:w})}};f.onDidContentSizeChange(ae),ae();const je=(0,F.debounce)(()=>{const m=f.getValue();Ke.current(m)},I.current.datasource.getDebounceTimeInMilliseconds());if(f.getModel()?.onDidChangeContent(()=>{je()}),f.addCommand(R.KeyMod.Shift|R.KeyCode.Enter,()=>{N.current(f.getValue())},"isEditorFocused"+t),f.addCommand(R.KeyMod.CtrlCmd|R.KeyCode.KeyK,function(){a.g.dispatchEvent(new KeyboardEvent("keydown",{key:"k",metaKey:!0}))}),_){const m=[{range:new R.Range(1,1,1,1),options:{className:se.placeholder,isWholeLine:!0}}];let w=[];const B=()=>{const x=f.getModel();if(!x)return;const P=x.getValueLength()===0?m:[];w=x.deltaDecorations(w,P)};B(),f.onDidChangeModelContent(B),f.onDidChangeModelContent(x=>{const P=f.getModel();if(!P)return;const ue=P.getValue(),Je=((0,E.O)(ue,A.interpolateString(ue,E.t),P.getLinesContent(),s.E2)||[]).map(({error:ce,...qe})=>({message:`${ce?`Error parsing "${ce}"`:"Parse error"}. The query appears to be incorrect and could fail to be executed.`,severity:R.MarkerSeverity.Error,...qe}));R.editor.setModelMarkers(P,"owner",Je)})}}}))}},80004:(G,$,a)=>{a.d($,{Z:()=>F});var D=a(31733),s=function(M){var y=(0,D.useRef)(M);return y.current=M,y};const F=s}}]);

//# sourceMappingURL=prom-query-field.4274b24d8c05683d9cc5.js.map