"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4023],{84655:(H,y,e)=>{e.d(y,{i:()=>S});var d=e(76932),l=e(31733),r=e(76067);const S=({hideLine:u=!1})=>{const f=(0,r.wW)(A);return u?l.createElement("hr",{className:f.dividerHideLine}):l.createElement("hr",{className:f.divider})},A=u=>({divider:(0,d.css)({margin:u.spacing(4,0)}),dividerHideLine:(0,d.css)({border:"none",margin:u.spacing(3,0)})})},36662:(H,y,e)=>{e.d(y,{I:()=>G});var d=e(76932),l=e(31733),r=e(44992),S=e(98463),A=e(76067),u=e(47701),f=e(41164),U=e(76772),L=e(5936);function $({options:m,onOptionsChange:g}){const C=(0,A.wW)(F);return l.createElement("div",{className:C.container},l.createElement(u.Z,{className:C.row},l.createElement(f._,{tooltip:"Displays the node graph above the trace view. Default: disabled",label:"Enable node graph",labelWidth:26},l.createElement(U.x,{id:"enableNodeGraph",value:m.jsonData.nodeGraph?.enabled,onChange:N=>(0,r.tp)({onOptionsChange:g,options:m},"nodeGraph",{...m.jsonData.nodeGraph,enabled:N.currentTarget.checked})}))))}const G=({options:m,onOptionsChange:g})=>{let C=m.type;return C+=m.type==="tempo"?"/configure-tempo-data-source/#node-graph":"/#node-graph",l.createElement(S._,{title:"Node graph",description:l.createElement(L.W,{description:"Show or hide the node graph visualization.",suffix:C,feature:"the node graph"})},l.createElement($,{options:m,onOptionsChange:g}))},F=m=>({infoText:(0,d.css)({label:"infoText",paddingBottom:m.spacing(2),color:m.colors.text.secondary}),container:(0,d.css)({label:"container",width:"100%"}),row:(0,d.css)({label:"row",alignItems:"baseline"})})},46898:(H,y,e)=>{e.d(y,{Y:()=>N});var d=e(76932),l=e(31733),r=e(44992),S=e(83717),A=e(76067),u=e(47701),f=e(41164),U=e(51343),L=e(64516),$=e(79228),G=e(5936),F=e(4200),m=e(69256),g=e(42302);function C({options:c,onOptionsChange:v}){const B=(0,A.wW)(Q);return l.createElement("div",{className:(0,d.css)({width:"100%"})},l.createElement(u.Z,{className:B.row},l.createElement(f._,{tooltip:"The Prometheus data source the trace is going to navigate to",label:"Data source",labelWidth:26},l.createElement($.q,{inputId:"trace-to-metrics-data-source-picker",pluginId:"prometheus",current:c.jsonData.tracesToMetrics?.datasourceUid,noDefault:!0,width:40,onChange:h=>(0,r.tp)({onOptionsChange:v,options:c},"tracesToMetrics",{...c.jsonData.tracesToMetrics,datasourceUid:h.uid})})),c.jsonData.tracesToMetrics?.datasourceUid?l.createElement(U.zx,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,r.tp)({onOptionsChange:v,options:c},"tracesToMetrics",{...c.jsonData.tracesToMetrics,datasourceUid:void 0})}},"Clear"):null),l.createElement(u.Z,null,l.createElement(F.w,{label:(0,g.mH)("start"),tooltip:(0,g.rr)("start","-2m"),value:c.jsonData.tracesToMetrics?.spanStartTimeShift||"",onChange:h=>{(0,r.tp)({onOptionsChange:v,options:c},"tracesToMetrics",{...c.jsonData.tracesToMetrics,spanStartTimeShift:h})},placeholder:"-2m",isInvalidError:g.Ny})),l.createElement(u.Z,null,l.createElement(F.w,{label:(0,g.mH)("end"),tooltip:(0,g.rr)("end","2m"),value:c.jsonData.tracesToMetrics?.spanEndTimeShift||"",onChange:h=>{(0,r.tp)({onOptionsChange:v,options:c},"tracesToMetrics",{...c.jsonData.tracesToMetrics,spanEndTimeShift:h})},placeholder:"2m",isInvalidError:g.Ny})),l.createElement(u.Z,null,l.createElement(f._,{tooltip:"Tags that will be used in the metrics query",label:"Tags",labelWidth:26},l.createElement(m.a,{values:c.jsonData.tracesToMetrics?.tags??[],onChange:h=>(0,r.tp)({onOptionsChange:v,options:c},"tracesToMetrics",{...c.jsonData.tracesToMetrics,tags:h})}))),c.jsonData.tracesToMetrics?.queries?.map((h,K)=>l.createElement("div",{key:K,className:B.queryRow},l.createElement(f._,{label:"Link Label",labelWidth:26,tooltip:"Descriptive label for the linked query"},l.createElement(L.I,{label:"Link Label",type:"text",allowFullScreen:!0,value:h.name,width:40,onChange:j=>{const z=(c.jsonData.tracesToMetrics?.queries??[]).map((R,J)=>J===K?{...R,name:j.currentTarget.value}:R);(0,r.tp)({onOptionsChange:v,options:c},"tracesToMetrics",{...c.jsonData.tracesToMetrics,queries:z})}})),l.createElement(f._,{label:"Query",labelWidth:10,tooltip:"The Prometheus query that will run when navigating from a trace to metrics. Interpolate tags using the `$__tags` keyword",grow:!0},l.createElement(L.I,{label:"Query",type:"text",allowFullScreen:!0,value:h.query,onChange:j=>{const z=(c.jsonData.tracesToMetrics?.queries??[]).map((R,J)=>J===K?{...R,query:j.currentTarget.value}:R);(0,r.tp)({onOptionsChange:v,options:c},"tracesToMetrics",{...c.jsonData.tracesToMetrics,queries:z})}})),l.createElement(U.zx,{variant:"destructive",title:"Remove query",icon:"times",type:"button",onClick:()=>{const j=c.jsonData.tracesToMetrics?.queries.filter((z,R)=>R!==K);(0,r.tp)({onOptionsChange:v,options:c},"tracesToMetrics",{...c.jsonData.tracesToMetrics,queries:j})}}))),l.createElement(U.zx,{variant:"secondary",title:"Add query",icon:"plus",type:"button",onClick:()=>{(0,r.tp)({onOptionsChange:v,options:c},"tracesToMetrics",{...c.jsonData.tracesToMetrics,queries:[...c.jsonData.tracesToMetrics?.queries??[],{query:""}]})}},"Add query"))}const N=({options:c,onOptionsChange:v})=>{let B=c.type;return B+=c.type==="tempo"?"/configure-tempo-data-source/#trace-to-metrics":"/#trace-to-metrics",l.createElement(S.K,{title:"Trace to metrics",description:l.createElement(G.W,{description:"Navigate from a trace span to the selected data source's metrics.",suffix:B,feature:"trace to metrics"}),isCollapsible:!0,isInitiallyOpen:!0},l.createElement(C,{options:c,onOptionsChange:v}))},Q=c=>({infoText:(0,d.css)`
    padding-bottom: ${c.spacing(2)};
    color: ${c.colors.text.secondary};
  `,row:(0,d.css)`
    label: row;
    align-items: baseline;
  `,queryRow:(0,d.css)`
    label: queryRow;
    display: flex;
    flex-flow: wrap;
  `})},96634:(H,y,e)=>{e.r(y),e.d(y,{plugin:()=>Ie});var d=e(51023),l=e(76932),r=e(31733),S=e(85510),A=e(83717),u=e(85498),f=e(76067),U=e(69671),L=e(84655),$=e(36662),G=e(42302),F=e(46898),m=e(18180);const g=({options:a,onOptionsChange:t})=>{const n=(0,f.wW)(C);return r.createElement("div",{className:n.container},r.createElement(S.j,{dataSourceName:"Zipkin",docsLink:"https://grafana.com/docs/grafana/latest/datasources/zipkin",hasRequiredFields:!1}),r.createElement(L.i,null),r.createElement(U.E,{defaultUrl:"http://localhost:9411",dataSourceConfig:a,showAccessOptions:!1,onChange:t,secureSocksDSProxyEnabled:u.config.secureSocksDSProxyEnabled}),r.createElement(G.dw,{options:a,onOptionsChange:t}),r.createElement(L.i,null),u.config.featureToggles.traceToMetrics?r.createElement(r.Fragment,null,r.createElement(F.Y,{options:a,onOptionsChange:t}),r.createElement(L.i,null)):null,r.createElement(A.K,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!1},r.createElement($.I,{options:a,onOptionsChange:t}),r.createElement(L.i,{hideLine:!0}),r.createElement(m.vc,{options:a,onOptionsChange:t})))},C=a=>({container:(0,l.css)`
    label: container;
    margin-bottom: ${a.spacing(2)};
    max-width: 900px;
  `});var N=e(69781),Q=e(41710),c=e(81716),v=e(99640),B=e(5572),h=e(54679),K=e(47701),j=e(41164),z=e(79106),R=e(96856),J=e(51343),ee=e(30091),te=e(59328),X=e(7939),w=e(42876),k=e(86573);const V="/api/v2",ae=a=>({tracesCascader:(0,l.css)({label:"tracesCascader",marginRight:a.spacing(1)})}),re=({query:a,onChange:t,onRunQuery:n,datasource:s})=>{const[i,o]=(0,r.useState)(!1),Z=ne(s),I=(0,f.l4)(),E=(0,f.wW)(ae),{onLoadOptions:p,allOptions:T}=se(s),D=(0,r.useCallback)((M,O)=>{if(O.length===3){const q=O[2].value;t({...a,query:q}),n()}},[t,n,a]);(0,r.useEffect)(()=>{a.queryType||t({...a,queryType:"traceID"})},[a,t]);const P=M=>{const O={...a,query:M};t(O)};let x=oe(Z,T);return r.createElement(r.Fragment,null,r.createElement(B.u,{title:"Upload trace",isOpen:i,onDismiss:()=>o(!1)},r.createElement("div",{className:(0,l.css)({padding:I.spacing(2)})},r.createElement(h.Yo,{options:{multiple:!1},onLoad:M=>{s.uploadedJson=M,t({...a,queryType:"upload"}),o(!1),n()}}))),r.createElement(K.Z,null,r.createElement(j._,{label:"Query type",grow:!0},r.createElement(z.Lh,{spacing:"sm",align:"center",justify:"space-between"},r.createElement(R.S,{options:[{value:"traceID",label:"TraceID"}],value:a.queryType||"traceID",onChange:M=>t({...a,queryType:M}),size:"md"}),r.createElement(J.zx,{variant:"secondary",size:"sm",onClick:()=>{o(!0)}},"Import trace")))),a.queryType==="traceID"&&r.createElement(K.Z,null,r.createElement(ee.O,{options:x,onChange:D,loadData:p,variant:"secondary",buttonProps:{className:E.tracesCascader}},"Traces"),r.createElement("div",{className:"gf-form gf-form--grow flex-shrink-1 min-width-15"},r.createElement(te.q,{query:a.query,onChange:P,onRunQuery:n,placeholder:"Insert Trace ID (run with Shift+Enter)",portalOrigin:"zipkin"}))))};function ne(a){const t=`${V}/services`,[n,s]=(0,Q.Z)(async()=>{try{const i=await a.metadataRequest(t);return i?i.sort().map(o=>({label:o,value:o,isLeaf:!1})):[]}catch(i){const o=i instanceof Error?i:"An unknown error occurred";throw(0,k.WI)((0,X.$l)((0,w.t_)("Failed to load services from Zipkin",o))),i}},[a]);return(0,c.Z)(()=>{s()}),n}function se(a){const t=(0,v.Z)(),[n,s]=(0,r.useState)({}),[,i]=(0,Q.Z)(async function(E){const p=`${V}/spans`;try{const T=await a.metadataRequest(p,{serviceName:E});t()&&s(D=>{const P=(0,N.fromPairs)(T.map(x=>[x,void 0]));return{...D,[E]:P}})}catch(T){const D=T instanceof Error?T:"An unknown error occurred";throw(0,k.WI)((0,X.$l)((0,w.t_)("Failed to load spans from Zipkin",D))),T}},[a,n]),[,o]=(0,Q.Z)(async function(E,p){const T=`${V}/traces`,D={serviceName:E,spanName:p};try{const P=await a.metadataRequest(T,D);if(t()){const x=P.length?(0,N.fromPairs)(P.map(M=>{const O=M.find(q=>!q.parentId);return[`${O.name} [${Math.floor(O.duration/1e3)} ms]`,O.traceId]})):ie;s(M=>{const O=M[E];return{...M,[E]:{...O,[p]:x}}})}}catch(P){const x=P instanceof Error?P:"An unknown error occurred";throw(0,k.WI)((0,X.$l)((0,w.t_)("Failed to load spans from Zipkin",x))),P}},[a]);return{onLoadOptions:(0,r.useCallback)(I=>{const E=I[0].value;if(I.length===1)i(E);else if(I.length===2){const p=I[1].value;o(E,p)}},[i,o]),allOptions:n}}function oe(a,t){return(0,r.useMemo)(()=>{let n=[];return a.value&&a.value.length?n=a.value.map(s=>({...s,children:t[s.value]&&Object.keys(t[s.value]).map(i=>({label:i,value:i,isLeaf:!1,children:t[s.value][i]&&Object.keys(t[s.value][i]).map(o=>({label:o,value:t[s.value][i][o]}))}))})):a.value&&!a.value.length&&(n=ce),n},[a,t])}const le="__NO_TRACES__",ce=[{label:"No traces found",value:"no_traces",isLeaf:!0}],ie={"[No traces in time range]":le};var Y=e(86457),de=e(71892),ue=e(4558),me=e(91977),Ee=e(98147),fe=e(85666),ve=e(61129),ge=e(69391),W=e(56790),b=e(60226);function he(a){const{nodes:t,edges:n}=pe(a),[s,i]=(0,b.np)();for(const o of t)s.add(o);for(const o of n)i.add(o);return[s,i]}function pe(a){const t=[],n=[],s=Te(a),i=(0,b.nO)(o=>{if(!(o>=a.length))return{span:a[o],id:a[o].id,parentIds:a[o].parentId?[a[o].parentId]:[]}});for(const o of a){const Z=i[o.id].children.map(T=>{const D=i[T].span;return[D.timestamp,D.timestamp+D.duration]}),I=(0,b.et)(Z),E=o.duration-I,p=(0,b.fy)(o.duration/1e3,s/1e3,E/1e3);t.push({[W.z.id]:o.id,[W.z.title]:o.localEndpoint?.serviceName||o.remoteEndpoint?.serviceName||"unknown",[W.z.subTitle]:o.name,[W.z.mainStat]:p.main,[W.z.secondaryStat]:p.secondary,[W.z.color]:E/s}),o.parentId&&i[o.parentId].span&&n.push({[W.z.id]:o.parentId+"--"+o.id,[W.z.target]:o.id,[W.z.source]:o.parentId})}return{nodes:t,edges:n}}function Te(a){let t=0,n=1/0;for(const s of a)s.timestamp<n&&(n=s.timestamp),s.timestamp+s.duration>t&&(t=s.timestamp+s.duration);return t-n}var De=e(67547);class Me extends d.MF{constructor(t,n=(0,ve.J)()){super(t),this.instanceSettings=t,this.templateSrv=n,this.uploadedJson=null,this.nodeGraph=t.jsonData.nodeGraph}query(t){const n=t.targets[0];if(n.queryType==="upload"){if(!this.uploadedJson)return(0,Y.of)({data:[]});try{const s=JSON.parse(this.uploadedJson);return(0,Y.of)(_({data:s},this.nodeGraph?.enabled))}catch{return(0,Y.of)({error:{message:"JSON is not valid Zipkin format"},data:[]})}}if(n.query){const s=this.applyVariables(n,t.scopedVars);return this.request(`${V}/trace/${encodeURIComponent(s.query)}`).pipe((0,ue.U)(i=>_(i,this.nodeGraph?.enabled)))}return(0,Y.of)(ye)}async metadataRequest(t,n){return(await(0,de.n)(this.request(t,n,{hideFromInspector:!0}))).data}async testDatasource(){return await this.metadataRequest(`${V}/services`),{status:"success",message:"Data source is working"}}getQueryDisplayText(t){return t.query}interpolateVariablesInQueries(t,n){return!t||t.length===0?[]:t.map(s=>({...s,datasource:this.getRef(),...this.applyVariables(s,n)}))}applyVariables(t,n){return{...{...t},query:this.templateSrv.replace(t.query??"",n)}}request(t,n,s){const i=n?me.Cj.serializeParams(n):"",o=`${this.instanceSettings.url}${t}${i.length?`?${i}`:""}`,Z={...s,url:o};return(0,ge.i)().fetch(Z)}}function _(a,t=!1){let n=a?.data?[(0,De.m)(a?.data)]:[];return t&&n.push(...he(a?.data)),{data:n}}const ye={data:[(0,Ee.at)({fields:[{name:"trace",type:fe.fS.trace,values:[]}],meta:{preferredVisualisationType:"trace",custom:{traceFormat:"zipkin"}}})]},Ie=new d.hf(Me).setQueryEditor(re).setConfigEditor(g)},81716:(H,y,e)=>{e.d(y,{Z:()=>r});var d=e(26124),l=function(S){(0,d.Z)(function(){S()})};const r=l}}]);

//# sourceMappingURL=zipkinPlugin.1ebd2c668e5fb1267743.js.map